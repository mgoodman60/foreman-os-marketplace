<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Data Intelligence Dashboard</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        /* ============================================================================
           CSS CUSTOM PROPERTIES (DESIGN TOKENS)
           ============================================================================ */

        :root {
            /* Colors - Primary & Brand */
            --color-navy: #1B2A4A;
            --color-blue: #2E5EAA;
            --color-blue-light: #4A7BC6;
            --color-blue-pale: #EDF2F9;
            --color-white: #FFFFFF;

            /* Colors - Semantic */
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            --color-red: #C0392B;
            --color-green: #2D8F4E;
            --color-amber: #E8A838;

            /* Colors - Extended Palette */
            --color-indigo: #4F46E5;
            --color-teal: #14B8A6;
            --color-pink: #EC4899;
            --color-purple: #A855F7;
            --color-cyan: #06B6D4;

            /* Colors - Neutral */
            --color-text-dark: #1B2A4A;
            --color-text-light: #6B7280;
            --color-gray: #9CA3AF;
            --color-gray-light: #F3F4F6;
            --color-border: #D1D5DB;
            --color-bg-light: #F8F9FB;
            --color-section-bg: #EDF2F9;

            /* Spacing Scale (rem, 0.25rem base) */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 0.75rem;
            --spacing-lg: 1rem;
            --spacing-xl: 1.25rem;
            --spacing-2xl: 1.5rem;
            --spacing-3xl: 2rem;
            --spacing-4xl: 2.5rem;
            --spacing-5xl: 3rem;

            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-base: 200ms ease-in-out;
            --transition-slow: 300ms ease-in-out;

            /* Typography */
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;

            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Z-index Scale */
            --z-sticky: 100;
            --z-dropdown: 200;
            --z-modal: 300;
            --z-toast: 400;

            /* Layout */
            --sidebar-width: 240px;
            --header-height: 64px;
        }

        /* ============================================================================
           GLOBAL STYLES & RESET
           ============================================================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family-base);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            color: var(--color-text-dark);
            background-color: var(--color-bg-light);
            overflow: hidden;
        }

        /* ============================================================================
           TYPOGRAPHY
           ============================================================================ */

        h1 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            line-height: var(--line-height-tight);
            margin-bottom: var(--spacing-xl);
            color: var(--color-text-dark);
        }

        h2 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            line-height: var(--line-height-tight);
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-dark);
        }

        h3 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-tight);
            margin-bottom: var(--spacing-md);
            color: var(--color-text-dark);
        }

        h4 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-tight);
            margin-bottom: var(--spacing-md);
            color: var(--color-text-dark);
        }

        h5 {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-normal);
            margin-bottom: var(--spacing-sm);
            color: var(--color-text-dark);
        }

        h6 {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            line-height: var(--line-height-normal);
            margin-bottom: var(--spacing-sm);
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        p {
            margin-bottom: var(--spacing-lg);
        }

        strong, .font-semibold {
            font-weight: var(--font-weight-semibold);
        }

        em {
            font-style: italic;
        }

        small {
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
        }

        code {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            background-color: var(--color-section-bg);
            color: var(--color-blue);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
        }

        /* ============================================================================
           LAYOUT STRUCTURE
           ============================================================================ */

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background-color: var(--color-bg-light);
        }

        .layout-flex {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--spacing-3xl);
            background-color: var(--color-bg-light);
        }

        /* Custom scrollbar styling */
        .main-content::-webkit-scrollbar {
            width: 8px;
        }

        .main-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: var(--radius-md);
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: var(--color-gray-light);
        }

        /* ============================================================================
           HEADER
           ============================================================================ */

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
            padding: 0 var(--spacing-3xl);
            background-color: var(--color-navy);
            color: var(--color-white);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-md);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-2xl);
        }

        .header-project-info {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .header-project-name {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-white);
        }

        .header-phase-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-md);
            background-color: rgba(74, 123, 198, 0.2);
            color: #4A7BC6;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-sm);
            border: 1px solid #4A7BC6;
            width: fit-content;
        }

        .header-date {
            font-size: var(--font-size-sm);
            color: rgba(255, 255, 255, 0.8);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-2xl);
        }

        .header-search {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            color: rgba(255, 255, 255, 0.7);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .header-search:hover {
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .header-search::after {
            content: 'Ctrl+K';
            margin-left: var(--spacing-lg);
            font-size: var(--font-size-xs);
            opacity: 0.6;
        }

        /* ============================================================================
           SIDEBAR
           ============================================================================ */

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--color-white);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 1px 0 3px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: var(--spacing-2xl) var(--spacing-2xl);
            border-bottom: 1px solid var(--color-border);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--spacing-lg) 0;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: var(--color-gray-light);
            border-radius: var(--radius-md);
        }

        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--color-border);
        }

        .sidebar-section {
            margin-bottom: var(--spacing-lg);
        }

        .sidebar-section-label {
            padding: var(--spacing-md) var(--spacing-2xl);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--spacing-lg);
        }

        .sidebar-item {
            padding: var(--spacing-md) var(--spacing-2xl);
            color: var(--color-text-dark);
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--font-size-sm);
            border-left: 3px solid transparent;
            margin: 0 var(--spacing-md);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
        }

        .sidebar-item:hover {
            background-color: var(--color-section-bg);
            color: var(--color-blue);
        }

        .sidebar-item.active {
            background-color: var(--color-blue-pale);
            color: var(--color-blue);
            font-weight: var(--font-weight-semibold);
            border-left-color: var(--color-blue);
        }

        .sidebar-item-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex: 1;
        }

        .sidebar-item-badge {
            display: none;
            background-color: var(--color-error);
            color: var(--color-white);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            min-width: 20px;
            text-align: center;
        }

        .sidebar-item-badge.show {
            display: inline-block;
        }

        /* ============================================================================
           CARDS & SUMMARY
           ============================================================================ */

        .card {
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-blue-light);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: var(--spacing-2xl);
            margin-bottom: var(--spacing-3xl);
        }

        .card-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--spacing-md);
        }

        .card-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text-dark);
            margin-bottom: var(--spacing-sm);
        }

        .card-sub {
            font-size: var(--font-size-sm);
            color: var(--color-text-light);
        }

        /* ============================================================================
           DETAIL CARDS
           ============================================================================ */

        .detail-card {
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .detail-card-header {
            background-color: var(--color-section-bg);
            padding: var(--spacing-2xl);
            border-bottom: 1px solid var(--color-border);
        }

        .detail-card-content {
            padding: var(--spacing-2xl);
        }

        /* ============================================================================
           KEY-VALUE GRIDS
           ============================================================================ */

        .kv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-2xl);
        }

        .kv-row {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
        }

        .kv-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .kv-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .kv-value {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
        }

        /* ============================================================================
           BADGES & STATUS
           ============================================================================ */

        .badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            border-radius: var(--radius-md);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }

        .status-complete {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }

        .status-pending {
            background-color: rgba(46, 94, 170, 0.1);
            color: var(--color-blue);
            border: 1px solid var(--color-blue);
        }

        .status-warning {
            background-color: rgba(232, 168, 56, 0.1);
            color: var(--color-amber);
            border: 1px solid var(--color-amber);
        }

        .status-critical {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }

        .status-default {
            background-color: rgba(156, 163, 175, 0.1);
            color: var(--color-gray);
            border: 1px solid var(--color-gray);
        }

        .urgency-high {
            background-color: rgba(192, 57, 43, 0.1);
            color: var(--color-red);
        }

        .urgency-medium {
            background-color: rgba(232, 168, 56, 0.1);
            color: var(--color-amber);
        }

        .urgency-low {
            background-color: rgba(45, 143, 78, 0.1);
            color: var(--color-green);
        }

        /* ============================================================================
           TABLES
           ============================================================================ */

        .table-wrap {
            width: 100%;
            overflow-x: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background-color: var(--color-white);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        thead {
            background-color: var(--color-section-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: var(--spacing-lg);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
            border-bottom: 2px solid var(--color-border);
            white-space: nowrap;
        }

        td {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-dark);
        }

        tbody tr:hover {
            background-color: var(--color-gray-light);
        }

        tbody tr:nth-child(even) {
            background-color: rgba(248, 249, 251, 0.5);
        }

        /* ============================================================================
           FORMS & INPUTS
           ============================================================================ */

        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            transition: all var(--transition-base);
            width: 100%;
            max-width: 400px;
        }

        .search-bar:focus-within {
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(46, 94, 170, 0.1);
        }

        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: var(--font-size-base);
            font-family: inherit;
        }

        .search-bar::before {
            content: 'üîç';
            margin-right: var(--spacing-md);
            opacity: 0.6;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: var(--font-size-base);
            transition: all var(--transition-base);
            background-color: var(--color-white);
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--color-blue);
            box-shadow: 0 0 0 3px rgba(46, 94, 170, 0.1);
        }

        /* ============================================================================
           BUTTONS
           ============================================================================ */

        button, .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--color-blue);
            color: var(--color-white);
        }

        .btn-primary:hover {
            background-color: var(--color-blue-light);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--color-gray-light);
            color: var(--color-text-dark);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background-color: var(--color-border);
        }

        .btn-small {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--font-size-sm);
        }

        /* ============================================================================
           TABS
           ============================================================================ */

        .tab-container {
            width: 100%;
        }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid var(--color-border);
            gap: 0;
            background-color: var(--color-white);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .tab-btn {
            padding: var(--spacing-lg) var(--spacing-2xl);
            background: none;
            border: none;
            cursor: pointer;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-light);
            transition: all var(--transition-base);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: var(--color-blue);
        }

        .tab-btn.active {
            color: var(--color-blue);
            border-bottom-color: var(--color-blue);
        }

        .tab-content {
            display: none;
            padding: var(--spacing-2xl);
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-top: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================================================
           EMPTY STATES
           ============================================================================ */

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-5xl);
            text-align: center;
            background-color: var(--color-white);
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            min-height: 300px;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
            margin-bottom: var(--spacing-md);
        }

        .empty-state-description {
            color: var(--color-text-light);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-lg);
        }

        /* ============================================================================
           ALERTS
           ============================================================================ */

        .alert-item {
            padding: var(--spacing-lg) var(--spacing-2xl);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-lg);
            align-items: flex-start;
            font-size: var(--font-size-sm);
        }

        .alert-critical {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--color-error);
            color: var(--color-error);
        }

        .alert-warning {
            background-color: rgba(232, 168, 56, 0.1);
            border-left: 4px solid var(--color-amber);
            color: var(--color-amber);
        }

        .alert-info {
            background-color: rgba(46, 94, 170, 0.1);
            border-left: 4px solid var(--color-blue);
            color: var(--color-blue);
        }

        .alert-icon {
            flex-shrink: 0;
            font-size: 1.25rem;
            margin-top: 2px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-xs);
        }

        /* ============================================================================
           PROCUREMENT BANNER
           ============================================================================ */

        .procurement-banner {
            position: fixed;
            top: var(--header-height);
            left: var(--sidebar-width);
            right: 0;
            background-color: rgba(232, 168, 56, 0.95);
            border-bottom: 2px solid var(--color-amber);
            padding: var(--spacing-lg) var(--spacing-3xl);
            z-index: var(--z-sticky) - 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-2xl);
            max-height: 100px;
            overflow: hidden;
            transition: all var(--transition-base);
            color: #5a3a1a;
        }

        .procurement-banner.collapsed {
            max-height: 0;
            padding: 0 var(--spacing-3xl);
            border-bottom: none;
        }

        .procurement-banner-content {
            display: flex;
            gap: var(--spacing-lg);
            align-items: center;
            flex: 1;
        }

        .procurement-banner-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .procurement-banner-text {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .procurement-banner-close {
            flex-shrink: 0;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            opacity: 0.7;
            transition: opacity var(--transition-base);
        }

        .procurement-banner-close:hover {
            opacity: 1;
        }

        /* ============================================================================
           SECTIONS
           ============================================================================ */

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn var(--transition-base);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* ============================================================================
           VISUALIZATIONS
           ============================================================================ */

        .viz-container {
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin-bottom: var(--spacing-3xl);
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* ============================================================================
           PROGRESS BARS
           ============================================================================ */

        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: var(--color-gray-light);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-blue), var(--color-blue-light));
            transition: width var(--transition-slow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
            color: var(--color-white);
        }

        /* ============================================================================
           FACT SHEETS
           ============================================================================ */

        .fact-sheet {
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
        }

        .fact-sheet-header {
            border-bottom: 2px solid var(--color-border);
            padding-bottom: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .fact-sheet-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
        }

        .fact-sheet-subsection {
            margin-bottom: var(--spacing-2xl);
        }

        .fact-sheet-subsection:last-child {
            margin-bottom: 0;
        }

        .fact-sheet-subsection-header {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-blue);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        /* ============================================================================
           GANTT & TIMELINE
           ============================================================================ */

        .gantt-container {
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow-x: auto;
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-3xl);
        }

        .gantt-chart {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            min-width: 100%;
        }

        .gantt-row {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .gantt-label {
            width: 200px;
            flex-shrink: 0;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-dark);
        }

        .gantt-bar-container {
            flex: 1;
            height: 32px;
            background-color: var(--color-gray-light);
            border-radius: var(--radius-md);
            position: relative;
            overflow: hidden;
        }

        .gantt-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--color-blue), var(--color-blue-light));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            padding: 0 var(--spacing-md);
            color: var(--color-white);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            white-space: nowrap;
            transition: all var(--transition-base);
        }

        .gantt-bar:hover {
            box-shadow: var(--shadow-md);
        }

        /* ============================================================================
           OVERLAY VIEWER
           ============================================================================ */

        .overlay-viewer {
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            min-height: 600px;
        }

        .overlay-canvas {
            width: 100%;
            height: 600px;
            display: block;
            background-color: #f5f5f5;
        }

        .overlay-controls {
            position: absolute;
            bottom: var(--spacing-lg);
            left: var(--spacing-lg);
            display: flex;
            gap: var(--spacing-md);
            background-color: rgba(255, 255, 255, 0.95);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            z-index: 10;
        }

        /* ============================================================================
           CORRELATION VIEWS
           ============================================================================ */

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .correlation-table th,
        .correlation-table td {
            padding: var(--spacing-lg);
            text-align: left;
            border: 1px solid var(--color-border);
        }

        .correlation-table th {
            background-color: var(--color-section-bg);
            font-weight: var(--font-weight-semibold);
        }

        .correlation-graph {
            width: 100%;
            height: 500px;
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
        }

        /* ============================================================================
           RENDERING GALLERY
           ============================================================================ */

        .rendering-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-2xl);
            margin-bottom: var(--spacing-3xl);
        }

        .rendering-thumbnail {
            position: relative;
            width: 100%;
            aspect-ratio: 4 / 3;
            background-color: var(--color-gray-light);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .rendering-thumbnail:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .rendering-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .rendering-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.6));
            padding: var(--spacing-lg);
            color: var(--color-white);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .rendering-thumbnail:hover .rendering-overlay {
            opacity: 1;
        }

        /* ============================================================================
           CHAT PANEL
           ============================================================================ */

        .chat-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 360px;
            max-height: 600px;
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: var(--shadow-xl);
            z-index: var(--z-modal) - 1;
            display: flex;
            flex-direction: column;
            transition: all var(--transition-base);
            transform: translateY(100%);
        }

        .chat-panel.expanded {
            transform: translateY(0);
        }

        .chat-header {
            padding: var(--spacing-lg) var(--spacing-2xl);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-section-bg);
        }

        .chat-header-title {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-dark);
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .chat-message {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            line-height: var(--line-height-normal);
        }

        .chat-message.user {
            background-color: var(--color-blue);
            color: var(--color-white);
            align-self: flex-end;
            max-width: 85%;
        }

        .chat-message.assistant {
            background-color: var(--color-gray-light);
            color: var(--color-text-dark);
            align-self: flex-start;
            max-width: 85%;
        }

        .chat-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: var(--spacing-md);
        }

        .chat-footer input {
            flex: 1;
        }

        /* ============================================================================
           COMMAND PALETTE / MODAL
           ============================================================================ */

        .command-palette {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            padding: var(--spacing-3xl);
        }

        .command-palette.active {
            display: flex;
        }

        .command-palette-content {
            background-color: var(--color-white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 600px;
            max-height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .command-palette-search {
            padding: var(--spacing-2xl);
            border-bottom: 1px solid var(--color-border);
        }

        .command-palette-search input {
            width: 100%;
            padding: var(--spacing-lg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
        }

        .command-palette-results {
            flex: 1;
            overflow-y: auto;
        }

        .command-palette-item {
            padding: var(--spacing-lg) var(--spacing-2xl);
            cursor: pointer;
            transition: all var(--transition-base);
            border-bottom: 1px solid var(--color-border);
        }

        .command-palette-item:hover,
        .command-palette-item.selected {
            background-color: var(--color-section-bg);
        }

        /* ============================================================================
           ROLE DROPDOWN
           ============================================================================ */

        .role-dropdown {
            position: relative;
        }

        .role-dropdown-btn {
            background: none;
            border: none;
            color: var(--color-white);
            cursor: pointer;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }

        .role-dropdown-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .role-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            margin-top: var(--spacing-sm);
            z-index: var(--z-dropdown);
            display: none;
        }

        .role-dropdown-menu.active {
            display: block;
        }

        .role-dropdown-item {
            padding: var(--spacing-lg) var(--spacing-2xl);
            cursor: pointer;
            transition: all var(--transition-base);
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-dark);
        }

        .role-dropdown-item:last-child {
            border-bottom: none;
        }

        .role-dropdown-item:hover {
            background-color: var(--color-section-bg);
            color: var(--color-blue);
        }

        .role-dropdown-item.selected {
            background-color: var(--color-blue-pale);
            color: var(--color-blue);
            font-weight: var(--font-weight-semibold);
        }

        /* ============================================================================
           RESPONSIVE DESIGN
           ============================================================================ */

        @media print {
            .sidebar,
            .header,
            .procurement-banner,
            .chat-panel,
            .command-palette {
                display: none !important;
            }

            .layout-flex {
                flex-direction: column;
            }

            .main-content {
                padding: 0;
            }

            .section {
                page-break-after: always;
                display: block !important;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -240px;
                height: calc(100vh - var(--header-height));
                z-index: var(--z-dropdown);
                transition: left var(--transition-base);
                box-shadow: var(--shadow-xl);
                top: var(--header-height);
            }

            .sidebar.open {
                left: 0;
            }

            .layout-flex {
                flex-direction: column;
            }

            .main-content {
                width: 100%;
                padding: var(--spacing-2xl);
            }

            .procurement-banner {
                left: 0;
            }

            .card-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chat-panel {
                width: 100%;
                max-width: 100%;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            }
        }

        @media (max-width: 768px) {
            :root {
                --spacing-3xl: 1.5rem;
            }

            .header {
                padding: 0 var(--spacing-lg);
                flex-wrap: wrap;
                gap: var(--spacing-lg);
            }

            .header-left {
                gap: var(--spacing-lg);
            }

            .header-right {
                gap: var(--spacing-lg);
                width: 100%;
            }

            .header-search {
                max-width: 100%;
            }

            .main-content {
                padding: var(--spacing-lg);
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .kv-grid {
                grid-template-columns: 1fr;
            }

            .tab-nav {
                overflow-x: auto;
            }

            .rendering-gallery {
                grid-template-columns: 1fr;
            }

            .chat-panel {
                width: 100%;
                max-height: 50vh;
            }

            .command-palette {
                padding: var(--spacing-lg);
            }

            .command-palette-content {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                gap: var(--spacing-md);
                padding: var(--spacing-lg);
            }

            .header-left,
            .header-right {
                width: 100%;
                gap: var(--spacing-md);
            }

            .header-search::after {
                display: none;
            }

            .sidebar {
                width: 100%;
                left: -100%;
            }

            .main-content {
                padding: var(--spacing-lg);
            }

            table {
                font-size: var(--font-size-xs);
            }

            th, td {
                padding: var(--spacing-sm);
            }

            .alert-item {
                padding: var(--spacing-md);
            }
        }

    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="header-project-info">
                    <div class="header-project-name">Morehead One Senior Care</div>
                    <span class="header-phase-badge">Foundation / Sitework</span>
                </div>
                <div class="header-date">Feb 19, 2026</div>
            </div>

            <div class="header-right">
                <div class="search-bar">
                    <input type="text" placeholder="Search dashboards, data...">
                </div>

                <div class="role-dropdown">
                    <button class="role-dropdown-btn">
                        üë§ Superintendent
                        <span style="opacity: 0.7;">‚ñº</span>
                    </button>
                    <div class="role-dropdown-menu">
                        <div class="role-dropdown-item selected">üë§ Superintendent</div>
                        <div class="role-dropdown-item">üìã Project Manager</div>
                        <div class="role-dropdown-item">üë®‚Äçüíº Owner</div>
                        <div class="role-dropdown-item">üèóÔ∏è Architect</div>
                        <div class="role-dropdown-item">üî® Subcontractor</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="layout-flex">
            <aside class="sidebar">
                <div class="sidebar-header">NAVIGATION</div>
                <div class="sidebar-scroll">

                    <!-- OVERVIEW Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">OVERVIEW</div>
                        <div class="sidebar-item" data-section="dashboard">
                            <div class="sidebar-item-left">
                                <span>üìä</span>
                                <span>Dashboard</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="alerts">
                            <div class="sidebar-item-left">
                                <span>üîî</span>
                                <span>Alerts</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="completeness">
                            <div class="sidebar-item-left">
                                <span>üìà</span>
                                <span>Data Completeness</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="revisions">
                            <div class="sidebar-item-left">
                                <span>üîÑ</span>
                                <span>Revision Tracker</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- BUILDING DATA Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">BUILDING DATA</div>
                        <div class="sidebar-item" data-section="grid-lines">
                            <div class="sidebar-item-left">
                                <span>üìê</span>
                                <span>Grid Lines</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="building-areas">
                            <div class="sidebar-item-left">
                                <span>üè¢</span>
                                <span>Building Areas</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="room-browser">
                            <div class="sidebar-item-left">
                                <span>üö™</span>
                                <span>Room Browser</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="doors-hardware">
                            <div class="sidebar-item-left">
                                <span>üö™</span>
                                <span>Doors & Hardware</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="pemb-structure">
                            <div class="sidebar-item-left">
                                <span>üî®</span>
                                <span>PEMB / Structure</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="mep-systems">
                            <div class="sidebar-item-left">
                                <span>‚ö°</span>
                                <span>MEP Systems</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="site-civil">
                            <div class="sidebar-item-left">
                                <span>üó∫Ô∏è</span>
                                <span>Site & Civil</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- QUANTITIES & COST Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">QUANTITIES & COST</div>
                        <div class="sidebar-item" data-section="takeoff">
                            <div class="sidebar-item-left">
                                <span>üìè</span>
                                <span>Takeoff</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="materials">
                            <div class="sidebar-item-left">
                                <span>üß±</span>
                                <span>Materials</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="bidding">
                            <div class="sidebar-item-left">
                                <span>üí∞</span>
                                <span>Bidding</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="calculator">
                            <div class="sidebar-item-left">
                                <span>üßÆ</span>
                                <span>Calculator</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- FINANCIALS Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">FINANCIALS</div>
                        <div class="sidebar-item" data-section="project-summary">
                            <div class="sidebar-item-left">
                                <span>üíµ</span>
                                <span>Project Summary</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="subcontracts-pos">
                            <div class="sidebar-item-left">
                                <span>üìã</span>
                                <span>Subcontracts & POs</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="change-orders">
                            <div class="sidebar-item-left">
                                <span>üîÑ</span>
                                <span>Change Orders</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="pay-applications">
                            <div class="sidebar-item-left">
                                <span>üí≥</span>
                                <span>Pay Applications</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- SPECIFICATIONS Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">SPECIFICATIONS</div>
                        <div class="sidebar-item" data-section="spec-sections">
                            <div class="sidebar-item-left">
                                <span>üìã</span>
                                <span>Spec Sections</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="concrete-mixes">
                            <div class="sidebar-item-left">
                                <span>üß™</span>
                                <span>Concrete Mix Designs</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="field-tolerances">
                            <div class="sidebar-item-left">
                                <span>üìè</span>
                                <span>Field Tolerances</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="weather-thresholds">
                            <div class="sidebar-item-left">
                                <span>üå°Ô∏è</span>
                                <span>Weather Thresholds</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="hold-points">
                            <div class="sidebar-item-left">
                                <span>üõë</span>
                                <span>Hold Points</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- PROJECT CONTROLS Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">PROJECT CONTROLS</div>
                        <div class="sidebar-item" data-section="schedule">
                            <div class="sidebar-item-left">
                                <span>üìÖ</span>
                                <span>Schedule</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="procurement">
                            <div class="sidebar-item-left">
                                <span>üì¶</span>
                                <span>Procurement</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="submittals">
                            <div class="sidebar-item-left">
                                <span>üìë</span>
                                <span>Submittals</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="rfis">
                            <div class="sidebar-item-left">
                                <span>‚ùì</span>
                                <span>RFIs</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="permits">
                            <div class="sidebar-item-left">
                                <span>üìú</span>
                                <span>Permit Compliance</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- DOCUMENTS Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">DOCUMENTS</div>
                        <div class="sidebar-item" data-section="sheet-index">
                            <div class="sidebar-item-left">
                                <span>üìÑ</span>
                                <span>Sheet Index</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="plan-overlay">
                            <div class="sidebar-item-left">
                                <span>üó∫Ô∏è</span>
                                <span>Plan Overlay</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="asi-revisions">
                            <div class="sidebar-item-left">
                                <span>üìù</span>
                                <span>ASI / Revisions</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- SPATIAL Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">SPATIAL</div>
                        <div class="sidebar-item" data-section="correlation-map">
                            <div class="sidebar-item-left">
                                <span>üîó</span>
                                <span>Correlation Map</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="progress-tracking">
                            <div class="sidebar-item-left">
                                <span>üìä</span>
                                <span>Progress Tracking</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- TOOLS Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">TOOLS</div>
                        <div class="sidebar-item" data-section="renderings">
                            <div class="sidebar-item-left">
                                <span>üé®</span>
                                <span>Renderings</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="ai-chatbot">
                            <div class="sidebar-item-left">
                                <span>ü§ñ</span>
                                <span>AI Chatbot</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="export-print">
                            <div class="sidebar-item-left">
                                <span>üì§</span>
                                <span>Export / Print</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                    <!-- LOGS Section -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-label">LOGS</div>
                        <div class="sidebar-item" data-section="delays">
                            <div class="sidebar-item-left">
                                <span>‚è±Ô∏è</span>
                                <span>Delays</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="punch-list">
                            <div class="sidebar-item-left">
                                <span>‚úÖ</span>
                                <span>Punch List</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="meetings">
                            <div class="sidebar-item-left">
                                <span>üìù</span>
                                <span>Meetings</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="geotechnical">
                            <div class="sidebar-item-left">
                                <span>‚õèÔ∏è</span>
                                <span>Geotechnical</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                        <div class="sidebar-item" data-section="swppp">
                            <div class="sidebar-item-left">
                                <span>üíß</span>
                                <span>SWPPP</span>
                            </div>
                            <span class="sidebar-item-badge"></span>
                        </div>
                    </div>

                </div>
            </aside>

            <main class="main-content">
                <!-- Procurement Banner -->
                <div class="procurement-banner">
                    <div class="procurement-banner-content">
                        <div class="procurement-banner-icon">‚ö†Ô∏è</div>
                        <div class="procurement-banner-text">
                            6 submittals overdue | Wells Concrete (17d), Schiller package (24d) | HVAC equipment not ordered ‚Äî 8-week lead time
                        </div>
                    </div>
                    <button class="procurement-banner-close">‚úï</button>
                </div>

                <!-- Content sections will be populated here by subsequent parts -->

            </main>
        </div>
    </div>

    <!-- Command Palette -->
    <div class="command-palette">
        <div class="command-palette-content">
            <div class="command-palette-search">
                <input type="text" placeholder="Search commands, data, sections...">
            </div>
            <div class="command-palette-results">
                <!-- Results will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel">
        <div class="chat-header">
            <span class="chat-header-title">Project Assistant</span>
            <button class="chat-footer" style="border: none; padding: 0; width: auto;">‚úï</button>
        </div>
        <div class="chat-body">
            <!-- Messages will be populated here -->
        </div>
        <div class="chat-footer">
            <input type="text" placeholder="Ask me anything...">
            <button class="btn btn-primary btn-small">Send</button>
        </div>
    </div>

</body>
</html>
<!-- Part 2: All Section Divs - HTML Structure Only -->
<!-- No CSS, no JS. Display:none by default except sec-overview (active) -->

<div class="sections-container">

  <!-- SEC 1: OVERVIEW -->
  <section id="sec-overview" class="section active">
    <h2>Project Intelligence Overview</h2>
    <p>Unified project summary: alerts, coverage, quick stats, and role-specific content.</p>

    <div id="overview-cards" class="card-grid">
      <!-- JS will populate summary cards here -->
    </div>

    <div id="alerts-panel" class="alerts-panel">
      <!-- Alert aggregation: JS will populate -->
    </div>

    <div id="coverage-grid" class="coverage-grid">
      <!-- Data completeness widget: JS will populate -->
    </div>

    <div id="quick-stats" class="kv-grid">
      <!-- Key numbers grid: JS will populate -->
    </div>

    <div id="role-landing" class="role-landing-container">
      <!-- Role-specific content: JS will populate -->
    </div>
  </section>

  <!-- SEC 2: ALERTS -->
  <section id="sec-alerts" class="section">
    <h2>Action Required</h2>
    <p>Critical, warning, and informational alerts flagged for immediate attention.</p>

    <div id="alerts-critical">
      <h3>Critical</h3>
      <div class="alerts-list">
        <!-- JS will populate critical alerts -->
      </div>
    </div>

    <div id="alerts-warning">
      <h3>Warning</h3>
      <div class="alerts-list">
        <!-- JS will populate warning alerts -->
      </div>
    </div>

    <div id="alerts-info">
      <h3>Information</h3>
      <div class="alerts-list">
        <!-- JS will populate info alerts -->
      </div>
    </div>
  </section>

  <!-- SEC 3: COMPLETENESS -->
  <section id="sec-completeness" class="section">
    <h2>Data Completeness Scorecard</h2>
    <p>Category-by-category assessment of document processing and data extraction.</p>

    <div id="completeness-categories">
      <!-- Category progress bars: JS will populate -->
    </div>

    <div id="completeness-actions" class="actionable-guidance">
      <!-- Actionable guidance list: JS will populate -->
    </div>
  </section>

  <!-- SEC 4: REVISIONS -->
  <section id="sec-revisions" class="section">
    <h2>ASI / Revision Tracker</h2>
    <p>All issued Addenda, Supplemental Instructions, and sheet revisions.</p>

    <div id="asi-log-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>ASI #</th>
            <th>Date</th>
            <th>Description</th>
            <th>Sheets Affected</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate ASI log rows -->
        </tbody>
      </table>
    </div>

    <div id="sheet-currency" class="table-container">
      <h3>Sheet Revision Currency</h3>
      <table>
        <thead>
          <tr>
            <th>Sheet #</th>
            <th>Title</th>
            <th>Revision</th>
            <th>Processed Date</th>
            <th>Superseded</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate sheet currency rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 5: GRIDLINES -->
  <section id="sec-gridlines" class="section">
    <h2>Structural Grid</h2>
    <p>Building grid lines, bay dimensions, and spacing reference.</p>

    <div id="grid-detail" class="kv-grid">
      <!-- Grid detail key-value pairs: JS will populate -->
    </div>

    <div id="grid-spacing-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Bay</th>
            <th>Dimension</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate spacing rows -->
        </tbody>
      </table>
    </div>

    <div id="grid-svg" class="svg-container">
      <svg viewBox="0 0 1000 800">
        <!-- Grid visualization SVG: JS will populate -->
      </svg>
    </div>
  </section>

  <!-- SEC 6: AREAS -->
  <section id="sec-areas" class="section">
    <h2>Building Areas</h2>
    <p>Space allocation by area type and use category.</p>

    <div id="area-cards" class="card-grid">
      <!-- Area summary cards: JS will populate -->
    </div>

    <div id="area-breakdown" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Area Type</th>
            <th>Square Feet</th>
            <th>Percentage</th>
            <th>Rooms</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate area breakdown rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 7: ROOMS -->
  <section id="sec-rooms" class="section">
    <h2>Room Browser</h2>
    <p>Interactive room schedule with spatial visualization and details.</p>

    <div class="room-summary-bar">
      <div id="room-summary-stats" class="kv-grid">
        <!-- Room summary statistics: JS will populate -->
      </div>
    </div>

    <div id="room-floorplan" class="viz-container">
      <svg>
        <!-- Floor plan visualization: JS will populate -->
      </svg>
    </div>

    <div class="room-search-bar">
      <input type="text" id="room-search-text" placeholder="Search room name or number...">
      <select id="room-filter-type">
        <option value="">All Types</option>
        <!-- JS will populate room type options -->
      </select>
      <select id="room-filter-floor">
        <option value="">All Floors</option>
        <!-- JS will populate floor options -->
      </select>
    </div>

    <div id="room-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Room #</th>
            <th>Name</th>
            <th>Type</th>
            <th>Area (SF)</th>
            <th>Floor</th>
            <th>Ceiling Ht</th>
            <th>Doors</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate room rows (clickable for detail panel) -->
        </tbody>
      </table>
    </div>

    <div id="room-detail-panel" class="fact-sheet-panel" style="display:none;">
      <!-- Room detail panel: JS will populate when room clicked -->
    </div>
  </section>

  <!-- SEC 8: DOORS -->
  <section id="sec-doors" class="section">
    <h2>Doors & Hardware</h2>
    <p>Complete door schedule, hardware specification, and frame details.</p>

    <div class="tab-nav">
      <button class="tab-button active" data-tab="door-schedule-tab">Door Schedule</button>
      <button class="tab-button" data-tab="hardware-schedule-tab">Hardware Schedule</button>
      <button class="tab-button" data-tab="frame-schedule-tab">Frames</button>
    </div>

    <div id="doors-financial-header" class="card-grid">
      <!-- PO value and submittal status cards: JS will populate -->
    </div>

    <div id="door-schedule-tab" class="tab-content active">
      <div class="filter-bar">
        <input type="text" placeholder="Search marks or descriptions...">
        <select>
          <option value="">All Types</option>
          <!-- JS will populate door types -->
        </select>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Mark</th>
              <th>Type</th>
              <th>Size</th>
              <th>Rating</th>
              <th>Room(s)</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate door schedule rows -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="hardware-schedule-tab" class="tab-content" style="display:none;">
      <!-- Grouped by door type, expandable cards: JS will populate -->
    </div>

    <div id="frame-schedule-tab" class="tab-content" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Type</th>
              <th>Size</th>
              <th>Rating</th>
              <th>Material</th>
              <th>Qty</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate frame rows -->
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SEC 9: PEMB -->
  <section id="sec-pemb" class="section">
    <h2>PEMB / Structure</h2>
    <p>Pre-engineered metal building envelope, foundation, and framing specifications.</p>

    <div id="pemb-cards" class="card-grid">
      <!-- Summary cards: dimensions, eave, frames, wind: JS will populate -->
    </div>

    <div id="pemb-envelope" class="kv-grid">
      <!-- PEMB envelope specs: JS will populate -->
    </div>

    <div id="pemb-reactions" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Grid Location</th>
            <th>Vertical (kips)</th>
            <th>Horizontal (kips)</th>
            <th>Bolt Type</th>
            <th>Qty</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate reactions rows (fixed for array/object) -->
        </tbody>
      </table>
    </div>

    <div id="pemb-foundation" class="kv-grid">
      <!-- PEMB foundation specs: JS will populate -->
    </div>

    <div id="pemb-sog" class="kv-grid">
      <!-- SOG specifications: JS will populate -->
    </div>

    <div id="pemb-interior-framing" class="kv-grid">
      <!-- CFS interior framing specs: JS will populate -->
    </div>
  </section>

  <!-- SEC 10: MEP -->
  <section id="sec-mep" class="section">
    <h2>MEP Systems</h2>
    <p>Mechanical, electrical, and plumbing equipment, controls, and specifications.</p>

    <div class="tab-nav">
      <button class="tab-button active" data-tab="mep-mechanical-tab">Mechanical</button>
      <button class="tab-button" data-tab="mep-electrical-tab">Electrical</button>
      <button class="tab-button" data-tab="mep-plumbing-tab">Plumbing</button>
    </div>

    <div id="mep-mechanical-tab" class="tab-content active">
      <h3>Equipment</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Equipment ID</th>
              <th>Type</th>
              <th>Model</th>
              <th>Capacity</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate mechanical equipment -->
          </tbody>
        </table>
      </div>
      <h3>Ductwork</h3>
      <div id="mep-ductwork-detail" class="kv-grid">
        <!-- Ductwork specs: JS will populate -->
      </div>
      <h3>Controls</h3>
      <div id="mep-controls-detail" class="kv-grid">
        <!-- Controls specs: JS will populate -->
      </div>
    </div>

    <div id="mep-electrical-tab" class="tab-content" style="display:none;">
      <h3>Electrical Panels</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Panel</th>
              <th>Type</th>
              <th>Voltage</th>
              <th>Phase</th>
              <th>Amps</th>
              <th>Location</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate panel schedule -->
          </tbody>
        </table>
      </div>
      <h3>Lighting & Power</h3>
      <div id="mep-lighting-detail" class="kv-grid">
        <!-- Lighting and power specs: JS will populate -->
      </div>
      <h3>Low Voltage Systems</h3>
      <div id="mep-lowvoltage-detail" class="kv-grid">
        <!-- Fire alarm, nurse call, access control, etc.: JS will populate -->
      </div>
    </div>

    <div id="mep-plumbing-tab" class="tab-content" style="display:none;">
      <h3>Fixtures Schedule</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Fixture Type</th>
              <th>Qty</th>
              <th>Model</th>
              <th>Rough-In</th>
              <th>Location(s)</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate fixture schedule -->
          </tbody>
        </table>
      </div>
      <h3>Water Systems</h3>
      <div id="mep-water-detail" class="kv-grid">
        <!-- Water heater, supply, DWV specs: JS will populate -->
      </div>
    </div>
  </section>

  <!-- SEC 11: SITE -->
  <section id="sec-site" class="section">
    <h2>Site & Civil</h2>
    <p>Site layout, utilities, grading, parking, and stormwater management.</p>

    <div id="site-cards" class="card-grid">
      <!-- Parking, setbacks, stormwater cards: JS will populate -->
    </div>

    <div id="site-layout" class="kv-grid">
      <!-- Site layout specifications: JS will populate -->
    </div>

    <div id="site-utilities" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Utility</th>
            <th>Type</th>
            <th>Location / Connection</th>
            <th>Size/Capacity</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate utilities -->
        </tbody>
      </table>
    </div>

    <div id="site-grading" class="kv-grid">
      <!-- Grading and drainage detail: JS will populate -->
    </div>
  </section>

  <!-- SEC 12: TAKEOFF -->
  <section id="sec-takeoff" class="section">
    <h2>Quantity Takeoff</h2>
    <p>Material quantities extracted and organized by CSI division.</p>

    <div id="takeoff-divisions" class="collapsible-cards">
      <!-- Collapsible division cards: JS will populate -->
    </div>

    <div id="takeoff-summary-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Division</th>
            <th>Source</th>
            <th>Confidence</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate takeoff summary -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 13: MATERIALS -->
  <section id="sec-materials" class="section">
    <h2>Materials Database</h2>
    <p>Searchable material specifications and sourcing information.</p>

    <div class="search-bar">
      <input type="text" id="materials-search" placeholder="Search materials, specifications, suppliers...">
    </div>

    <div id="materials-grid" class="card-grid">
      <!-- Material cards: searchable database: JS will populate -->
    </div>
  </section>

  <!-- SEC 14: BIDDING -->
  <section id="sec-bidding" class="section">
    <h2>Bidding Tools</h2>
    <p>Bid comparison matrix and cost estimation from takeoff data.</p>

    <div class="tab-nav">
      <button class="tab-button active" data-tab="bid-comparison-tab">Bid Comparison</button>
      <button class="tab-button" data-tab="cost-estimator-tab">Cost Estimator</button>
    </div>

    <div id="bid-comparison-tab" class="tab-content active">
      <div class="table-container editable-table">
        <table>
          <thead>
            <tr>
              <th>Item / Trade</th>
              <th>Qty</th>
              <th>Unit</th>
              <th class="bid-column">Bidder 1</th>
              <th class="bid-column">Bidder 2</th>
              <th class="bid-column">Bidder 3</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate bid comparison rows, auto-calculations -->
          </tbody>
        </table>
      </div>
      <div class="table-actions">
        <button class="btn-secondary">+ Add Column</button>
        <button class="btn-secondary">- Remove Column</button>
      </div>
    </div>

    <div id="cost-estimator-tab" class="tab-content" style="display:none;">
      <div class="table-container editable-table">
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Unit</th>
              <th>Unit Cost</th>
              <th>Total</th>
              <th>Waste %</th>
              <th>Adjusted Total</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate from takeoff, editable unit costs, totals -->
          </tbody>
        </table>
      </div>
      <div class="cost-summary">
        <!-- JS will populate subtotal, contingency, total -->
      </div>
    </div>
  </section>

  <!-- SEC 15: CALCULATOR -->
  <section id="sec-calculator" class="section">
    <h2>Construction Calculator</h2>
    <p>Specialized tools for concrete, area/coverage, materials, and custom formulas.</p>

    <div class="tab-nav">
      <button class="tab-button active" data-tab="calc-concrete-tab">Concrete</button>
      <button class="tab-button" data-tab="calc-area-tab">Area/Coverage</button>
      <button class="tab-button" data-tab="calc-material-tab">Material Estimating</button>
      <button class="tab-button" data-tab="calc-custom-tab">Custom Formula</button>
    </div>

    <div id="calc-concrete-tab" class="tab-content active">
      <div class="calculator-group">
        <h3>Footing Calculator</h3>
        <div class="calc-inputs">
          <label>Length (ft): <input type="number" class="calc-input"></label>
          <label>Width (ft): <input type="number" class="calc-input"></label>
          <label>Depth (ft): <input type="number" class="calc-input"></label>
          <button class="btn-primary">Calculate Volume</button>
        </div>
        <div class="calc-result"></div>
      </div>
      <div class="calculator-group">
        <h3>SOG Calculator</h3>
        <div class="calc-inputs">
          <label>Area (SF): <input type="number" class="calc-input"></label>
          <label>Depth (in): <input type="number" class="calc-input"></label>
          <button class="btn-primary">Calculate Volume</button>
        </div>
        <div class="calc-result"></div>
      </div>
      <div class="calculator-group">
        <h3>Wall Calculator</h3>
        <div class="calc-inputs">
          <label>Height (ft): <input type="number" class="calc-input"></label>
          <label>Length (ft): <input type="number" class="calc-input"></label>
          <label>Thickness (in): <input type="number" class="calc-input"></label>
          <button class="btn-primary">Calculate Volume</button>
        </div>
        <div class="calc-result"></div>
      </div>
      <div class="calculator-group">
        <h3>Beam/Pier Calculator</h3>
        <div class="calc-inputs">
          <label>Length (ft): <input type="number" class="calc-input"></label>
          <label>Width (in): <input type="number" class="calc-input"></label>
          <label>Height (in): <input type="number" class="calc-input"></label>
          <button class="btn-primary">Calculate Volume</button>
        </div>
        <div class="calc-result"></div>
      </div>
    </div>

    <div id="calc-area-tab" class="tab-content" style="display:none;">
      <div class="calculator-group">
        <h3>Paint Coverage</h3>
        <div class="calc-inputs">
          <label>Area (SF): <input type="number" class="calc-input"></label>
          <label>Coverage Rate (SF/gal): <input type="number" class="calc-input" value="350"></label>
          <label>Coats: <input type="number" class="calc-input" value="1"></label>
          <button class="btn-primary">Calculate Gallons</button>
        </div>
        <div class="calc-result"></div>
      </div>
      <div class="calculator-group">
        <h3>Flooring Coverage</h3>
        <div class="calc-inputs">
          <label>Area (SF): <input type="number" class="calc-input"></label>
          <label>Unit (per SF / per SY / per tile): <select><option>SF</option><option>SY</option><option>Tile</option></select></label>
          <button class="btn-primary">Calculate Qty</button>
        </div>
        <div class="calc-result"></div>
      </div>
      <div class="calculator-group">
        <h3>Insulation Coverage</h3>
        <div class="calc-inputs">
          <label>Area (SF): <input type="number" class="calc-input"></label>
          <label>R-Value: <input type="number" class="calc-input"></label>
          <button class="btn-primary">Calculate Batts/Rolls</button>
        </div>
        <div class="calc-result"></div>
      </div>
      <div class="calculator-group">
        <h3>GWB / Ceiling Coverage</h3>
        <div class="calc-inputs">
          <label>Area (SF): <input type="number" class="calc-input"></label>
          <label>Sheet Size (SF): <input type="number" class="calc-input" value="32"></label>
          <label>Waste %: <input type="number" class="calc-input" value="10"></label>
          <button class="btn-primary">Calculate Sheets</button>
        </div>
        <div class="calc-result"></div>
      </div>
      <div class="calculator-group">
        <h3>Vapor Barrier Coverage</h3>
        <div class="calc-inputs">
          <label>Area (SF): <input type="number" class="calc-input"></label>
          <label>Mil Thickness: <input type="number" class="calc-input" value="6"></label>
          <button class="btn-primary">Calculate Qty</button>
        </div>
        <div class="calc-result"></div>
      </div>
    </div>

    <div id="calc-material-tab" class="tab-content" style="display:none;">
      <div class="calculator-group">
        <h3>Material Estimating</h3>
        <div class="calc-inputs">
          <label>Material: <input type="text" class="calc-input" placeholder="e.g., Rebar, Lumber, Steel"></label>
          <label>Quantity: <input type="number" class="calc-input"></label>
          <label>Unit (LB, LF, EA, etc): <input type="text" class="calc-input"></label>
          <label>Unit Cost: $<input type="number" class="calc-input" step="0.01"></label>
          <label>Waste Factor (%): <input type="number" class="calc-input" value="5"></label>
          <button class="btn-primary">Calculate Total</button>
        </div>
        <div class="calc-result"></div>
      </div>
    </div>

    <div id="calc-custom-tab" class="tab-content" style="display:none;">
      <div class="calculator-group">
        <h3>Custom Formula</h3>
        <div class="calc-inputs">
          <label>Expression: <input type="text" class="calc-input" placeholder="e.g., (length * width) * depth / 27"></label>
          <div id="custom-variables" class="variables-list">
            <!-- JS will populate variable inputs -->
          </div>
          <button class="btn-primary">Calculate</button>
          <button class="btn-secondary">Save Formula</button>
          <button class="btn-secondary">Load Formula</button>
        </div>
        <div class="calc-result"></div>
      </div>
    </div>
  </section>

  <!-- SEC 16: FINANCIALS -->
  <section id="sec-financials" class="section">
    <h2>Project Financials Summary</h2>
    <p>Budget tracking, cost tracking, and financial forecasting.</p>

    <div id="financial-cards" class="card-grid">
      <!-- Summary cards: contract, committed, pending, CO exposure, billed, retainage: JS will populate -->
    </div>

    <div id="financial-waterfall" class="chart-container">
      <!-- Waterfall chart: JS will populate -->
    </div>

    <div id="financial-trade-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Trade</th>
            <th>Contract Value</th>
            <th>Committed</th>
            <th>Pending</th>
            <th>Billed</th>
            <th>Retainage</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate trade-by-trade breakdown -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 17: SUBCONTRACTS -->
  <section id="sec-subcontracts" class="section">
    <h2>Subcontracts & POs</h2>
    <p>All subcontractor agreements and material purchase orders.</p>

    <div id="sub-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Subcontractor</th>
            <th>Trade</th>
            <th>Contract #</th>
            <th>Date</th>
            <th>Value</th>
            <th>COs</th>
            <th>Revised Value</th>
            <th>Billed</th>
            <th>Retainage</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate subcontract rows -->
        </tbody>
      </table>
    </div>

    <div id="po-table" class="table-container">
      <h3>Material Purchase Orders</h3>
      <table>
        <thead>
          <tr>
            <th>Supplier</th>
            <th>Material</th>
            <th>PO #</th>
            <th>Value</th>
            <th>Delivery Date</th>
            <th>Received</th>
            <th>Invoice Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate PO rows -->
        </tbody>
      </table>
    </div>

    <div id="unawarded-trades" class="alerts-panel">
      <h3>Unawarded Trades / Pending Approvals</h3>
      <!-- Flagged action items: JS will populate -->
    </div>
  </section>

  <!-- SEC 18: CHANGEORDERS -->
  <section id="sec-changeorders" class="section">
    <h2>Change Orders</h2>
    <p>All change orders, pending approvals, and cost/schedule impacts.</p>

    <div id="co-cards" class="card-grid">
      <!-- Summary: approved count/value, pending count/value: JS will populate -->
    </div>

    <div id="co-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>CO #</th>
            <th>Description</th>
            <th>Status</th>
            <th>Cost Impact</th>
            <th>Schedule Impact (Days)</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate change order rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 19: PAYAPPS -->
  <section id="sec-payapps" class="section">
    <h2>Pay Applications</h2>
    <p>Payment application tracking and status by period.</p>

    <div id="payapp-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Period</th>
            <th>Application #</th>
            <th>Gross Amount</th>
            <th>Retainage</th>
            <th>Net Payment</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate pay application rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 20: SPECS -->
  <section id="sec-specs" class="section">
    <h2>Specifications</h2>
    <p>Specification sections cross-referenced to related submittals and materials.</p>

    <div class="search-bar">
      <input type="text" id="specs-search" placeholder="Search specification sections...">
    </div>

    <div id="specs-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Division / Section Code</th>
            <th>Section Name</th>
            <th>Description</th>
            <th>Related Submittals</th>
            <th>Processed</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate specification rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 21: MIXDESIGNS -->
  <section id="sec-mixdesigns" class="section">
    <h2>Concrete Mix Designs</h2>
    <p>Approved concrete mix designs, strength grades, and approval status.</p>

    <div id="mix-active-banner" class="info-banner">
      <!-- Highlighted mix for today's pour, if applicable: JS will populate -->
    </div>

    <div id="mix-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Mix ID</th>
            <th>Strength (PSI)</th>
            <th>Cement (lbs)</th>
            <th>W/C Ratio</th>
            <th>Air (%)</th>
            <th>Slump (in)</th>
            <th>Admixtures</th>
            <th>Use</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate mix design rows -->
        </tbody>
      </table>
    </div>

    <div id="mix-detail-panel" class="expandable-panels">
      <!-- Expandable: full detail per mix: JS will populate -->
    </div>
  </section>

  <!-- SEC 22: TOLERANCES -->
  <section id="sec-tolerances" class="section">
    <h2>Field Tolerances</h2>
    <p>Allowable tolerances by trade and construction stage.</p>

    <div id="tolerance-groups" class="accordion-cards">
      <!-- Accordion/cards grouped by trade (Concrete, Steel/PEMB, CFS, Earthwork, MEP): JS will populate -->
      <!-- Each group: cards with parameter, range, standard, notes -->
    </div>
  </section>

  <!-- SEC 23: WEATHER -->
  <section id="sec-weather" class="section">
    <h2>Weather Thresholds</h2>
    <p>Environmental restrictions and seasonal work requirements by activity.</p>

    <div id="weather-cards" class="card-grid">
      <!-- Threshold cards by activity type (Concrete, Earthwork, PEMB Erection, Roof Panels, etc.): JS will populate -->
    </div>
  </section>

  <!-- SEC 24: HOLDPOINTS -->
  <section id="sec-holdpoints" class="section">
    <h2>Hold Points & Inspections</h2>
    <p>Mandatory inspection hold points and notification requirements.</p>

    <div id="holdpoint-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Hold Point ID</th>
            <th>Description</th>
            <th>Trade / Authority</th>
            <th>Notice Required (hrs)</th>
            <th>Status</th>
            <th>Inspection Date</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate hold point rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 25: SCHEDULE -->
  <section id="sec-schedule" class="section">
    <h2>Schedule & Critical Path</h2>
    <p>Project milestones, critical path analysis, and Gantt visualization.</p>

    <div id="schedule-cards" class="card-grid">
      <!-- Milestones summary: JS will populate -->
    </div>

    <div id="schedule-timeline" class="chart-container">
      <!-- Milestone visualization: JS will populate -->
    </div>

    <div id="schedule-critical-path" class="ordered-list">
      <!-- Ordered list of critical path activities: JS will populate -->
    </div>

    <div id="schedule-gantt" class="chart-container">
      <!-- Gantt chart: JS will populate -->
    </div>
  </section>

  <!-- SEC 26: PROCUREMENT -->
  <section id="sec-procurement" class="section">
    <h2>Procurement</h2>
    <p>Material and equipment procurement timeline and delivery tracking.</p>

    <div id="procurement-gantt" class="chart-container">
      <!-- Horizontal Gantt: JS will populate -->
    </div>

    <div id="procurement-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Supplier</th>
            <th>Status</th>
            <th>Order Date</th>
            <th>Delivery Date</th>
            <th>Urgency</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate procurement items -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 27: SUBMITTALS -->
  <section id="sec-submittals" class="section">
    <h2>Submittals Pipeline</h2>
    <p>Submittal status tracking from draft through approval.</p>

    <div id="submittal-pipeline" class="pipeline-visual">
      <!-- Visual pipeline: draft ‚Üí submitted ‚Üí in review ‚Üí approved/rejected: JS will populate -->
    </div>

    <div id="submittal-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>SUB #</th>
            <th>Item</th>
            <th>Supplier</th>
            <th>Days in Review</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate submittal rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 28: RFIS -->
  <section id="sec-rfis" class="section">
    <h2>RFIs</h2>
    <p>Request for Information tracking and resolution status.</p>

    <div id="rfi-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>RFI #</th>
            <th>Subject</th>
            <th>To (Discipline)</th>
            <th>Date Sent</th>
            <th>Due Date</th>
            <th>Status</th>
            <th>Response Date</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate RFI rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 29: PERMITS -->
  <section id="sec-permits" class="section">
    <h2>Permit Compliance</h2>
    <p>Permits, corrections, and compliance tracking by permit authority.</p>

    <div id="permit-cards" class="card-grid">
      <!-- One card per permit: number, type, date, authority, status: JS will populate -->
    </div>

    <div id="permit-checklists" class="accordion-cards">
      <!-- Interactive correction/condition checklists per permit: JS will populate -->
    </div>
  </section>

  <!-- SEC 30: SHEETINDEX -->
  <section id="sec-sheetindex" class="section">
    <h2>Sheet Cross-Reference Index</h2>
    <p>Plan sheet inventory and revision control by discipline.</p>

    <div class="tab-nav">
      <button class="tab-button active" data-tab="sheets-arch-tab">Architectural</button>
      <button class="tab-button" data-tab="sheets-struct-tab">Structural</button>
      <button class="tab-button" data-tab="sheets-civil-tab">Civil</button>
      <button class="tab-button" data-tab="sheets-mech-tab">Mechanical</button>
      <button class="tab-button" data-tab="sheets-elec-tab">Electrical</button>
      <button class="tab-button" data-tab="sheets-plumb-tab">Plumbing</button>
      <button class="tab-button" data-tab="sheets-other-tab">Other</button>
    </div>

    <div id="sheets-arch-tab" class="tab-content active">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sheet #</th>
              <th>Title</th>
              <th>Pages</th>
              <th>Data Extracted</th>
              <th>Revision</th>
              <th>Processed Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate architectural sheets -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="sheets-struct-tab" class="tab-content" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sheet #</th>
              <th>Title</th>
              <th>Pages</th>
              <th>Data Extracted</th>
              <th>Revision</th>
              <th>Processed Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate structural sheets -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="sheets-civil-tab" class="tab-content" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sheet #</th>
              <th>Title</th>
              <th>Pages</th>
              <th>Data Extracted</th>
              <th>Revision</th>
              <th>Processed Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate civil sheets -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="sheets-mech-tab" class="tab-content" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sheet #</th>
              <th>Title</th>
              <th>Pages</th>
              <th>Data Extracted</th>
              <th>Revision</th>
              <th>Processed Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate mechanical sheets -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="sheets-elec-tab" class="tab-content" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sheet #</th>
              <th>Title</th>
              <th>Pages</th>
              <th>Data Extracted</th>
              <th>Revision</th>
              <th>Processed Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate electrical sheets -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="sheets-plumb-tab" class="tab-content" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sheet #</th>
              <th>Title</th>
              <th>Pages</th>
              <th>Data Extracted</th>
              <th>Revision</th>
              <th>Processed Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate plumbing sheets -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="sheets-other-tab" class="tab-content" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sheet #</th>
              <th>Title</th>
              <th>Pages</th>
              <th>Data Extracted</th>
              <th>Revision</th>
              <th>Processed Date</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS will populate other sheets -->
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- SEC 31: OVERLAY -->
  <section id="sec-overlay" class="section">
    <h2>Plan Sheet Overlay Viewer</h2>
    <p>Multi-layer plan sheet visualization with discipline filtering and opacity control.</p>

    <div id="overlay-controls" class="overlay-control-panel">
      <h3>Layer Controls</h3>
      <div class="discipline-checkboxes">
        <!-- Discipline checkboxes: JS will populate -->
      </div>
      <div class="opacity-sliders">
        <!-- Opacity sliders per discipline: JS will populate -->
      </div>
      <div class="color-tint-selectors">
        <!-- Color tint selectors: JS will populate -->
      </div>
    </div>

    <div id="overlay-canvas" class="canvas-container">
      <!-- Fabric.js canvas: 100% width, 600px height -->
    </div>

    <div id="overlay-fallback" class="placeholder-message">
      <!-- Shown when no images: Upload plan sheet images to enable overlay viewer -->
      Upload plan sheet images to enable overlay viewer.
    </div>
  </section>

  <!-- SEC 32: CORRELATION -->
  <section id="sec-correlation" class="section">
    <h2>Spatial Data Correlation</h2>
    <p>Cross-reference rooms, doors, MEP equipment, specs, submittals, and subcontractors.</p>

    <div class="correlation-controls">
      <label>Entity Type: <select id="correlation-entity-type">
        <option value="">Select entity type...</option>
        <option value="room">Room</option>
        <option value="door">Door</option>
        <option value="mep">MEP Equipment</option>
        <option value="spec">Specification</option>
        <option value="submittal">Submittal</option>
        <option value="subcontractor">Subcontractor</option>
      </select></label>

      <label>Entity: <select id="correlation-entity-selector">
        <!-- JS will populate based on entity type selection -->
      </select></label>

      <div class="view-toggle">
        <button class="toggle-btn active" data-view="table">Table Mode</button>
        <button class="toggle-btn" data-view="graph">Graph Mode</button>
      </div>
    </div>

    <div id="correlation-table" class="table-container" style="display:block;">
      <table>
        <thead>
          <tr>
            <th>Related Entity Type</th>
            <th>Related Entity</th>
            <th>Relationship</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate related entities -->
        </tbody>
      </table>
    </div>

    <div id="correlation-graph" class="chart-container" style="display:none;">
      <!-- D3 force-directed graph: JS will populate -->
    </div>
  </section>

  <!-- SEC 33: PROGRESS -->
  <section id="sec-progress" class="section">
    <h2>Progress Tracking</h2>
    <p>Installation progress, earned value, and S-curve analysis.</p>

    <div id="progress-bars" class="progress-grid">
      <!-- Quantity progress: installed vs total per item: JS will populate -->
    </div>

    <div id="progress-scurve" class="chart-container">
      <!-- S-curve chart: JS will populate -->
    </div>

    <div id="progress-ev" class="card-grid">
      <!-- Earned value metrics cards, if financial data exists: JS will populate -->
    </div>
  </section>

  <!-- SEC 34: RENDERINGS -->
  <section id="sec-renderings" class="section">
    <h2>Rendering Gallery</h2>
    <p>Project visualizations, diagrams, and AI-generated renderings.</p>

    <div id="rendering-gallery" class="image-grid">
      <!-- Image grid with thumbnails and metadata: JS will populate -->
    </div>

    <div id="rendering-svg-diagrams" class="diagram-grid">
      <!-- Built-in SVG: floor plan, site plan, isometric: JS will populate -->
    </div>

    <div id="rendering-generate-form" class="form-group">
      <h3>Generate Rendering</h3>
      <label>Type: <select>
        <option value="">Select type...</option>
        <option value="floor-plan">Floor Plan</option>
        <option value="3d-isometric">3D Isometric</option>
        <option value="site-plan">Site Plan</option>
        <option value="elevation">Elevation</option>
        <option value="detail">Detail</option>
      </select></label>
      <label>Style: <select>
        <option value="technical">Technical</option>
        <option value="photorealistic">Photorealistic</option>
        <option value="watercolor">Watercolor</option>
      </select></label>
      <label>Lighting: <select>
        <option value="day">Day</option>
        <option value="night">Night</option>
        <option value="sunset">Sunset</option>
      </select></label>
      <label>API Selector: <input type="text" placeholder="API configuration or preset"></label>
      <button class="btn-primary">Generate Rendering</button>
    </div>
  </section>

  <!-- SEC 35: DELAYS -->
  <section id="sec-delays" class="section">
    <h2>Delays</h2>
    <p>Project delays, root cause, and schedule impact tracking.</p>

    <div id="delay-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Type</th>
            <th>Impact (Days)</th>
            <th>Duration (Days)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate delay rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 36: PUNCHLIST -->
  <section id="sec-punchlist" class="section">
    <h2>Punch List</h2>
    <p>Remaining work items and deficiencies for final completion.</p>

    <div id="punch-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Item #</th>
            <th>Location</th>
            <th>Description</th>
            <th>Trade</th>
            <th>Status</th>
            <th>Photo</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate punch list items -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 37: MEETINGS -->
  <section id="sec-meetings" class="section">
    <h2>Meeting Notes</h2>
    <p>Project meeting minutes, attendees, and action items.</p>

    <div id="meeting-table" class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Attendees</th>
            <th>Action Items</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate meeting rows -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- SEC 38: GEOTECH -->
  <section id="sec-geotech" class="section">
    <h2>Geotechnical</h2>
    <p>Soil conditions, bearing capacity, compaction, and settlement analysis.</p>

    <div id="geotech-detail" class="kv-grid">
      <!-- Bearing, compaction, fill requirements, settlement, dewatering, frost: JS will populate -->
    </div>
  </section>

  <!-- SEC 39: SWPPP -->
  <section id="sec-swppp" class="section">
    <h2>SWPPP</h2>
    <p>Stormwater Pollution Prevention Plan: BMPs and inspection schedule.</p>

    <div id="swppp-bmps" class="table-container">
      <table>
        <thead>
          <tr>
            <th>BMP Type</th>
            <th>Location</th>
            <th>Quantity</th>
            <th>Status</th>
            <th>Last Inspected</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS will populate BMP rows -->
        </tbody>
      </table>
    </div>

    <div id="swppp-inspections" class="schedule-detail">
      <!-- Inspection schedule: JS will populate -->
    </div>
  </section>

  <!-- OVERLAY: COMMAND PALETTE -->
  <div id="command-palette" class="modal-overlay" style="display:none;">
    <div class="modal-content command-palette-modal">
      <h3>Command Palette</h3>
      <input type="text" id="command-search" class="command-search-input" placeholder="Search commands...">
      <div id="command-results" class="command-results-list">
        <!-- JS will populate command results -->
      </div>
      <div class="keyboard-hints">
        <p>Keyboard Navigation:</p>
        <ul>
          <li>‚Üë‚Üì: Navigate results</li>
          <li>Enter: Execute command</li>
          <li>Esc: Close</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- OVERLAY: CHAT PANEL -->
  <div id="chat-panel" class="chat-panel-wrapper">
    <div class="chat-panel-collapsed">
      <button class="chat-toggle-btn">Chat</button>
    </div>
    <div class="chat-panel-expanded" style="display:none;">
      <div class="chat-header">
        <h3>Project Assistant</h3>
        <button class="chat-minimize-btn">_</button>
        <button class="chat-close-btn">√ó</button>
      </div>
      <div id="chat-message-list" class="chat-message-list">
        <!-- JS will populate chat messages -->
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" class="chat-input-field" placeholder="Ask a question...">
        <button class="chat-send-btn">Send</button>
      </div>
      <div id="chat-suggestions" class="chat-suggestions">
        <!-- JS will populate suggested questions -->
      </div>
    </div>
  </div>

</div>
<!-- END sections-container -->

<script>

// ===========================
// PART 3A: CORE JAVASCRIPT
// ===========================
// Data loading, helpers, navigation, command palette, and core renderers

// 1. DATA PLACEHOLDERS & API KEYS
// ===============================
// These are replaced at generation time by the /data command
// In template+data injection mode, these come from the external data.js file
const PROJECT_DATA = window.PROJECT_DATA || {};
const API_KEYS = window.API_KEYS || {};
const DATA_MANIFEST = window.DATA_MANIFEST || {};
let ACTIVE_ROLE = localStorage.getItem('foreman_role') || window.ACTIVE_ROLE || 'superintendent';

// Track which sections have been rendered to avoid re-rendering
const renderedSections = new Set();

// 2. HELPER FUNCTIONS
// ===================

/**
 * Shortcut for getElementById
 */
function $(id) {
  return document.getElementById(id);
}

/**
 * HTML escape and null coalescing
 */
function esc(s) {
  if (s === null || s === undefined || s === '') return '‚Äî';
  const div = document.createElement('div');
  div.textContent = String(s);
  return div.innerHTML;
}

/**
 * Returns CSS class based on status string
 */
function statusClass(s) {
  if (!s) return 'status-default';
  const status = String(s).toLowerCase();
  if (status === 'complete' || status === 'approved' || status === 'executed') return 'status-complete';
  if (status === 'pending' || status === 'in_progress' || status === 'in progress') return 'status-pending';
  if (status === 'at_risk' || status === 'delayed') return 'status-warning';
  if (status === 'critical' || status === 'overdue') return 'status-critical';
  return 'status-default';
}

/**
 * Returns HTML badge span with status styling
 */
function statusBadge(s) {
  if (!s) return '<span class="badge status-default">Unknown</span>';
  const cls = statusClass(s);
  return `<span class="badge ${cls}">${esc(s)}</span>`;
}

/**
 * Returns urgency badge (high=red, medium=amber, low=green)
 */
function urgencyBadge(u) {
  if (!u) return '';
  const level = String(u).toLowerCase();
  let cls = 'urgency-low';
  if (level === 'high' || level === 'critical') cls = 'urgency-high';
  else if (level === 'medium' || level === 'amber') cls = 'urgency-medium';
  return `<span class="badge ${cls}">${esc(u)}</span>`;
}

/**
 * Counts array items by a specific status field
 */
function countByStatus(arr, field) {
  if (!Array.isArray(arr)) return {};
  const counts = {};
  arr.forEach(item => {
    const status = item[field] || 'unknown';
    counts[status] = (counts[status] || 0) + 1;
  });
  return counts;
}

/**
 * Returns summary card HTML with optional icon
 */
function cardHTML(label, value, sub, icon) {
  const iconHtml = icon ? `<div class="card-icon">${icon}</div>` : '';
  const subHtml = sub ? `<p class="card-sub">${esc(sub)}</p>` : '';
  return `<div class="card">
    ${iconHtml}
    <label>${esc(label)}</label>
    <p class="card-value">${esc(value)}</p>
    ${subHtml}
  </div>`;
}

/**
 * Returns single key-value row HTML
 */
function kvRow(label, value) {
  return `<div class="kv-row">
    <label>${esc(label)}</label>
    <span>${esc(value)}</span>
  </div>`;
}

/**
 * Takes array of [label, value] pairs, returns full kv-grid HTML
 */
function kvGrid(pairs) {
  if (!Array.isArray(pairs) || pairs.length === 0) return '';
  return `<div class="kv-grid">
    ${pairs.map(([label, value]) => kvRow(label, value)).join('')}
  </div>`;
}

/**
 * Populates tbody from array of objects with specified columns
 */
function tableRows(tbody, rows, columns) {
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!Array.isArray(rows) || rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="${columns.length}" style="text-align:center;padding:2em;">No data</td></tr>`;
    return;
  }
  rows.forEach(row => {
    const tr = document.createElement('tr');
    columns.forEach(col => {
      const td = document.createElement('td');
      td.textContent = esc(row[col]);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/**
 * Counts non-empty array items
 */
function arrLen(a) {
  return Array.isArray(a) ? a.filter(x => x).length : 0;
}

/**
 * Returns empty state HTML with optional action guidance
 */
function emptyState(icon, title, desc, action) {
  const actionHtml = action ? `<p class="empty-action">${esc(action)}</p>` : '';
  return `<div class="empty-state">
    <div class="empty-icon">${icon}</div>
    <h3>${esc(title)}</h3>
    <p>${esc(desc)}</p>
    ${actionHtml}
  </div>`;
}

/**
 * Formats number with comma separators
 */
function formatNumber(n) {
  if (n === null || n === undefined || n === '') return '‚Äî';
  return Number(n).toLocaleString();
}

/**
 * Formats number as currency with dollar sign
 */
function formatCurrency(n) {
  if (n === null || n === undefined || n === '') return '‚Äî';
  return '$' + Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/**
 * Formats date string as "Feb 19, 2026" style
 */
function formatDate(d) {
  if (!d) return '‚Äî';
  try {
    const date = new Date(d);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  } catch (e) {
    return esc(d);
  }
}

/**
 * Parses dimension strings to decimal feet ("26'-8\"" ‚Üí 26.667)
 */
function parseNum(s) {
  if (!s) return 0;
  const str = String(s).trim();
  // Match pattern: X'-Y" or just X or X.X
  const match = str.match(/^(\d+(?:\.\d+)?)\s*'?(?:\s*(\d+(?:\.\d+)?)\s*")?/);
  if (!match) return 0;
  const feet = parseFloat(match[1]) || 0;
  const inches = parseFloat(match[2]) || 0;
  return feet + (inches / 12);
}

/**
 * Converts decimal feet to inches
 */
function feetToInches(ft) {
  return ft * 12;
}

/**
 * Cubic feet to cubic yards (√∑27)
 */
function cubicFeetToCY(cf) {
  return cf / 27;
}

/**
 * Square feet to square yards (√∑9)
 */
function sfToSY(sf) {
  return sf / 9;
}

/**
 * Percentage calculation with 1 decimal place
 */
function pct(part, whole) {
  if (whole === null || whole === undefined || whole === 0) return '‚Äî';
  return (((part || 0) / whole) * 100).toFixed(1) + '%';
}

/**
 * Safely traverse object path like "spatial.pemb_envelope.width"
 */
function safeGet(obj, path, fallback) {
  if (!obj || !path) return fallback;
  const keys = String(path).split('.');
  let current = obj;
  for (const key of keys) {
    if (current === null || current === undefined) return fallback;
    current = current[key];
  }
  return current ?? fallback;
}

// 3. SIDEBAR NAVIGATION SYSTEM
// ============================

const NAV_ITEMS = [
  // MAIN
  { id: 'overview', label: 'Overview', section: 'overview' },
  { id: 'alerts', label: 'Alerts', section: 'alerts', badge: 'alert-count' },

  // DESIGN & SPATIAL
  { id: 'nav-spatial', label: 'Design & Spatial', isGroup: true },
  { id: 'rooms', label: 'Rooms & Schedule', section: 'rooms', badge: 'room-count' },
  { id: 'doors', label: 'Doors & Hardware', section: 'doors', badge: 'door-count' },
  { id: 'gridlines', label: 'Gridlines', section: 'gridlines' },
  { id: 'areas', label: 'Areas', section: 'areas' },
  { id: 'pemb', label: 'PEMB Structure', section: 'pemb' },
  { id: 'mep', label: 'MEP Systems', section: 'mep', badge: 'mep-count' },
  { id: 'site', label: 'Site & Civil', section: 'site' },

  // REFERENCE
  { id: 'nav-reference', label: 'Reference & Specs', isGroup: true },
  { id: 'specs', label: 'Specifications', section: 'specs', badge: 'spec-count' },
  { id: 'sheetindex', label: 'Sheet Index', section: 'sheetindex' },
  { id: 'mixdesigns', label: 'Concrete Mix Designs', section: 'mixdesigns' },
  { id: 'tolerances', label: 'Tolerances & Finishes', section: 'tolerances' },
  { id: 'geotech', label: 'Geotechnical', section: 'geotech' },
  { id: 'swppp', label: 'SWPPP', section: 'swppp' },

  // FINANCIAL
  { id: 'nav-financial', label: 'Financial & Commercial', isGroup: true },
  { id: 'financials', label: 'Financials', section: 'financials' },
  { id: 'subcontracts', label: 'Subcontracts', section: 'subcontracts', badge: 'sub-count' },
  { id: 'bidding', label: 'Bidding & Procurement', section: 'bidding' },
  { id: 'procurement', label: 'Procurement Alerts', section: 'procurement', badge: 'procure-alert' },
  { id: 'changeorders', label: 'Change Orders', section: 'changeorders', badge: 'co-count' },
  { id: 'payapps', label: 'Pay Applications', section: 'payapps' },

  // PROJECT CONTROL
  { id: 'nav-control', label: 'Project Control', isGroup: true },
  { id: 'schedule', label: 'Schedule', section: 'schedule' },
  { id: 'submittals', label: 'Submittals', section: 'submittals', badge: 'submittal-overdue' },
  { id: 'rfis', label: 'RFIs', section: 'rfis', badge: 'rfi-count' },
  { id: 'holdpoints', label: 'Hold Points & Inspections', section: 'holdpoints', badge: 'hp-pending' },
  { id: 'permits', label: 'Permits', section: 'permits' },
  { id: 'weather', label: 'Weather & Conditions', section: 'weather' },

  // ANALYSIS & TRACKING
  { id: 'nav-analysis', label: 'Analysis & Tracking', isGroup: true },
  { id: 'completeness', label: 'Data Completeness', section: 'completeness' },
  { id: 'progress', label: 'Project Progress', section: 'progress' },
  { id: 'delays', label: 'Delays & Issues', section: 'delays' },
  { id: 'punchlist', label: 'Punch List', section: 'punchlist' },
  { id: 'revisions', label: 'Revisions & ASIs', section: 'revisions' },

  // TOOLS & UTILITIES
  { id: 'nav-tools', label: 'Tools & Utilities', isGroup: true },
  { id: 'takeoff', label: 'Material Takeoff', section: 'takeoff' },
  { id: 'materials', label: 'Materials & Equipment', section: 'materials' },
  { id: 'calculator', label: 'Calculator', section: 'calculator' },
  { id: 'renderings', label: 'Renderings & 3D', section: 'renderings' },
  { id: 'meetings', label: 'Meeting Notes', section: 'meetings' },
  { id: 'correlation', label: 'Plan Correlation', section: 'correlation' },
  { id: 'overlay', label: 'Plan Overlay Tool', section: 'overlay' }
];

function initSidebar() {
  const navLinks = document.querySelectorAll('.sidebar-nav-link');
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const sectionId = link.getAttribute('data-section');
      if (sectionId) {
        showSection(sectionId);
      }
    });
  });
}

function showSection(sectionId) {
  // Hide all sections
  const sections = document.querySelectorAll('.section');
  sections.forEach(s => s.classList.remove('active'));

  // Show target section
  const targetSection = $(`section-${sectionId}`);
  if (targetSection) {
    targetSection.classList.add('active');
  }

  // Update sidebar active state
  const navLinks = document.querySelectorAll('.sidebar-nav-link');
  navLinks.forEach(link => link.classList.remove('active'));
  const activeLink = document.querySelector(`[data-section="${sectionId}"]`);
  if (activeLink) {
    activeLink.classList.add('active');
  }

  // Update URL hash
  window.location.hash = sectionId;

  // Render section if needed
  renderSectionIfNeeded(sectionId);
}

function renderSectionIfNeeded(sectionId) {
  if (renderedSections.has(sectionId)) return;
  renderedSections.add(sectionId);

  const renderers = {
    'overview': renderOverview,
    'alerts': renderAlerts,
    'completeness': renderCompleteness,
    'revisions': renderRevisions,
    'gridlines': renderGridLines,
    'areas': renderAreas,
    'rooms': renderRooms,
    'doors': renderDoors,
    'pemb': renderPEMB,
    'mep': renderMEP,
    'site': renderSite,
    'takeoff': renderTakeoff,
    'materials': renderMaterials,
    'bidding': renderBidding,
    'calculator': renderCalculator,
    'financials': renderFinancials,
    'subcontracts': renderSubcontracts,
    'changeorders': renderChangeOrders,
    'payapps': renderPayApps,
    'specs': renderSpecs,
    'mixdesigns': renderMixDesigns,
    'tolerances': renderTolerances,
    'weather': renderWeather,
    'holdpoints': renderHoldPoints,
    'schedule': renderSchedule,
    'procurement': renderProcurement,
    'submittals': renderSubmittals,
    'rfis': renderRFIs,
    'permits': renderPermits,
    'sheetindex': renderSheetIndex,
    'overlay': renderOverlay,
    'correlation': renderCorrelation,
    'progress': renderProgress,
    'renderings': renderRenderings,
    'delays': renderDelays,
    'punchlist': renderPunchList,
    'meetings': renderMeetings,
    'geotech': renderGeotech,
    'swppp': renderSWPPP
  };

  if (renderers[sectionId]) {
    renderers[sectionId]();
  }
}

// 4. AUTO-HIDE SIDEBAR ITEMS WITH NO DATA
// ========================================

function updateSidebarVisibility() {
  const navLinks = document.querySelectorAll('.sidebar-nav-link');

  const dataChecks = {
    'gridlines': () => safeGet(PROJECT_DATA, 'spatial.gridlines') !== undefined,
    'areas': () => safeGet(PROJECT_DATA, 'spatial.area_schedule') !== undefined,
    'rooms': () => safeGet(PROJECT_DATA, 'spatial.room_schedule') !== undefined,
    'doors': () => safeGet(PROJECT_DATA, 'spatial.door_schedule') !== undefined,
    'pemb': () => safeGet(PROJECT_DATA, 'spatial.pemb_envelope') !== undefined,
    'mep': () => safeGet(PROJECT_DATA, 'mep') !== undefined,
    'site': () => safeGet(PROJECT_DATA, 'spatial.site_parameters') !== undefined,
    'specs': () => safeGet(PROJECT_DATA, 'config.spec_sections') !== undefined,
    'mixdesigns': () => safeGet(PROJECT_DATA, 'config.concrete_intelligence.mix_designs') !== undefined,
    'geotech': () => safeGet(PROJECT_DATA, 'config.geotech') !== undefined,
    'swppp': () => safeGet(PROJECT_DATA, 'config.swppp') !== undefined,
    'subcontracts': () => arrLen(safeGet(PROJECT_DATA, 'subcontractors', [])) > 0,
    'bidding': () => safeGet(PROJECT_DATA, 'config.suppliers') !== undefined,
    'procurement': () => safeGet(PROJECT_DATA, 'config.procurement_alerts') !== undefined,
    'submittals': () => arrLen(safeGet(PROJECT_DATA, 'config.submittals_log', [])) > 0,
    'rfis': () => arrLen(safeGet(PROJECT_DATA, 'config.rfis_log', [])) > 0,
    'holdpoints': () => arrLen(safeGet(PROJECT_DATA, 'config.hold_points', [])) > 0,
    'permits': () => arrLen(safeGet(PROJECT_DATA, 'config.permits', [])) > 0,
    'materials': () => safeGet(PROJECT_DATA, 'config.suppliers') !== undefined,
    'meetings': () => arrLen(safeGet(PROJECT_DATA, 'config.meetings', [])) > 0
  };

  navLinks.forEach(link => {
    const section = link.getAttribute('data-section');
    if (dataChecks[section]) {
      const hasData = dataChecks[section]();
      link.style.display = hasData ? '' : 'none';
    }
  });

  // Update badge counts
  updateBadgeCounts();
}

function updateBadgeCounts() {
  const rooms = safeGet(PROJECT_DATA, 'spatial.room_schedule', {});
  const roomCount = arrLen(safeGet(rooms, 'resident_rooms', [])) +
                    arrLen(safeGet(rooms, 'common_areas', [])) +
                    arrLen(safeGet(rooms, 'support_spaces', [])) +
                    arrLen(safeGet(rooms, 'restrooms', []));
  const roomCountEl = document.querySelector('[data-badge="room-count"]');
  if (roomCountEl && roomCount > 0) roomCountEl.textContent = roomCount;

  const doors = safeGet(PROJECT_DATA, 'spatial.door_schedule', []);
  const doorCountEl = document.querySelector('[data-badge="door-count"]');
  if (doorCountEl && doors.length > 0) doorCountEl.textContent = doors.length;

  const submittals = safeGet(PROJECT_DATA, 'config.submittals_log', []);
  const overdueSubmittals = submittals.filter(s => safeGet(s, 'status', '').toLowerCase() === 'overdue').length;
  const submittalEl = document.querySelector('[data-badge="submittal-overdue"]');
  if (submittalEl && overdueSubmittals > 0) submittalEl.textContent = overdueSubmittals;

  const procurementAlerts = safeGet(PROJECT_DATA, 'config.procurement_alerts', []);
  const procureEl = document.querySelector('[data-badge="procure-alert"]');
  if (procureEl && procurementAlerts.length > 0) procureEl.textContent = procurementAlerts.length;

  const mepEquipment = safeGet(PROJECT_DATA, 'mep.equipment', []);
  const mepCountEl = document.querySelector('[data-badge="mep-count"]');
  if (mepCountEl && mepEquipment.length > 0) mepCountEl.textContent = mepEquipment.length;
}

// 5. ROLE-BASED VIEW SYSTEM
// =========================

function initRoleSelector() {
  const roleSelect = document.getElementById('role-selector');
  if (!roleSelect) return;

  // Populate roles
  const roles = ['superintendent', 'pm', 'owner', 'architect', 'engineer'];
  roleSelect.innerHTML = roles.map(r =>
    `<option value="${r}" ${ACTIVE_ROLE === r ? 'selected' : ''}>${r.charAt(0).toUpperCase() + r.slice(1)}</option>`
  ).join('');

  roleSelect.addEventListener('change', (e) => {
    ACTIVE_ROLE = e.target.value;
    localStorage.setItem('foreman_role', ACTIVE_ROLE);
    renderOverview(); // Re-render overview with new role's data
  });
}

function getRoleLanding(role) {
  const landings = {
    'superintendent': ['overview', 'alerts', 'weather', 'holdpoints', 'tolerances', 'mixdesigns', 'rooms', 'procurement'],
    'pm': ['overview', 'alerts', 'financials', 'schedule', 'submittals', 'rfis', 'subcontracts', 'changeorders', 'procurement'],
    'owner': ['overview', 'progress', 'financials', 'schedule', 'changeorders', 'delays', 'meetings'],
    'architect': ['overview', 'revisions', 'specs', 'permits', 'rfis', 'submittals', 'gridlines', 'doors', 'rooms'],
    'engineer': ['overview', 'geotech', 'tolerances', 'mixdesigns', 'holdpoints', 'pemb', 'mep', 'site']
  };
  return landings[role] || landings['superintendent'];
}

// 6. SEARCH INDEX & COMMAND PALETTE
// ==================================

let searchIndex = [];

function buildSearchIndex() {
  searchIndex = [];

  // Add sections
  NAV_ITEMS.forEach(item => {
    if (!item.isGroup && item.section) {
      searchIndex.push({
        text: item.label,
        type: 'section',
        action: item.section,
        data: item
      });
    }
  });

  // Add rooms
  const rooms = safeGet(PROJECT_DATA, 'spatial.room_schedule', {});
  ['resident_rooms', 'common_areas', 'support_spaces', 'restrooms', 'entries_corridors'].forEach(category => {
    const roomList = safeGet(rooms, category, []);
    if (Array.isArray(roomList)) {
      roomList.forEach(room => {
        searchIndex.push({
          text: `${esc(room.mark || room.name || '')} (${category.replace(/_/g, ' ')})`,
          type: 'room',
          action: `room:${room.mark || room.name}`,
          data: room
        });
      });
    }
  });

  // Add spec sections
  const specSections = safeGet(PROJECT_DATA, 'config.spec_sections', []);
  if (Array.isArray(specSections)) {
    specSections.forEach(spec => {
      searchIndex.push({
        text: `Spec: ${esc(spec.number || '')} ${esc(spec.title || '')}`,
        type: 'spec',
        action: `spec:${spec.number}`,
        data: spec
      });
    });
  }

  // Add subcontractors
  const subs = safeGet(PROJECT_DATA, 'subcontractors', []);
  if (Array.isArray(subs)) {
    subs.forEach(sub => {
      searchIndex.push({
        text: `Subcontractor: ${esc(sub.name || '')} (${esc(sub.trade || '')})`,
        type: 'sub',
        action: `sub:${sub.id}`,
        data: sub
      });
    });
  }

  // Add suppliers
  const suppliers = safeGet(PROJECT_DATA, 'config.suppliers', []);
  if (Array.isArray(suppliers)) {
    suppliers.forEach(supplier => {
      searchIndex.push({
        text: `Supplier: ${esc(supplier.name || '')} (${esc(supplier.material || '')})`,
        type: 'supplier',
        action: `supplier:${supplier.id}`,
        data: supplier
      });
    });
  }

  // Add submittals
  const submittals = safeGet(PROJECT_DATA, 'config.submittals_log', []);
  if (Array.isArray(submittals)) {
    submittals.forEach(sub => {
      searchIndex.push({
        text: `Submittal: ${esc(sub.item || '')} (${esc(sub.supplier || '')})`,
        type: 'submittal',
        action: `submittal:${sub.id}`,
        data: sub
      });
    });
  }

  // Add doors
  const doors = safeGet(PROJECT_DATA, 'spatial.door_schedule', []);
  if (Array.isArray(doors)) {
    doors.forEach(door => {
      searchIndex.push({
        text: `Door: ${esc(door.mark || '')} (${esc(door.type || '')})`,
        type: 'door',
        action: `door:${door.mark}`,
        data: door
      });
    });
  }

  // Add MEP equipment
  const mepEquip = safeGet(PROJECT_DATA, 'mep.equipment', []);
  if (Array.isArray(mepEquip)) {
    mepEquip.forEach(equip => {
      searchIndex.push({
        text: `Equipment: ${esc(equip.tag || '')} (${esc(equip.category || '')})`,
        type: 'equipment',
        action: `equipment:${equip.tag}`,
        data: equip
      });
    });
  }
}

function initCommandPalette() {
  const paletteInput = document.getElementById('command-palette-input');
  const paletteResults = document.getElementById('command-palette-results');
  const paletteContainer = document.getElementById('command-palette');

  if (!paletteInput || !paletteResults) return;

  let selectedIndex = 0;
  let filteredResults = [];

  // Open/close with Ctrl+K or Cmd+K
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      paletteContainer.classList.toggle('active');
      if (paletteContainer.classList.contains('active')) {
        paletteInput.focus();
        paletteInput.value = '';
        selectedIndex = 0;
        showFilteredResults('');
      }
    }

    // Close with Escape
    if (e.key === 'Escape') {
      paletteContainer.classList.remove('active');
    }
  });

  // Filter on input
  paletteInput.addEventListener('input', (e) => {
    const query = e.target.value;
    selectedIndex = 0;
    showFilteredResults(query);
  });

  function showFilteredResults(query) {
    filteredResults = filterSearch(query);
    paletteResults.innerHTML = '';

    if (filteredResults.length === 0) {
      paletteResults.innerHTML = '<div class="palette-empty">No results found</div>';
      return;
    }

    // Group by type
    const grouped = {};
    filteredResults.slice(0, 10).forEach(result => {
      if (!grouped[result.type]) grouped[result.type] = [];
      grouped[result.type].push(result);
    });

    Object.entries(grouped).forEach(([type, items]) => {
      const group = document.createElement('div');
      group.className = 'palette-group';

      const label = document.createElement('div');
      label.className = 'palette-group-label';
      label.textContent = type.charAt(0).toUpperCase() + type.slice(1);
      group.appendChild(label);

      items.forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = 'palette-result';
        div.textContent = item.text;
        div.addEventListener('click', () => activateResult(item));
        group.appendChild(div);
      });

      paletteResults.appendChild(group);
    });
  }

  // Arrow key navigation
  paletteInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, filteredResults.length - 1);
      updateSelectedResult();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, 0);
      updateSelectedResult();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (filteredResults[selectedIndex]) {
        activateResult(filteredResults[selectedIndex]);
      }
    }
  });

  function updateSelectedResult() {
    const results = paletteResults.querySelectorAll('.palette-result');
    results.forEach((r, i) => r.classList.toggle('selected', i === selectedIndex));
  }

  function activateResult(result) {
    if (result.action.startsWith('section:') || !result.action.includes(':')) {
      showSection(result.action.replace('section:', ''));
    } else {
      // Handle other action types (room, door, etc.) as needed
      console.log('Navigate to:', result.action);
    }
    paletteContainer.classList.remove('active');
  }
}

function filterSearch(query) {
  if (!query.trim()) return searchIndex.slice(0, 10);

  const q = query.toLowerCase();
  return searchIndex.filter(item =>
    item.text.toLowerCase().includes(q)
  ).slice(0, 10);
}

// 7. PROCUREMENT ALERT BANNER
// ===========================

function renderProcurementBanner() {
  const bannerContainer = document.getElementById('procurement-banner-container');
  if (!bannerContainer) return;

  // Check if dismissed in session
  if (sessionStorage.getItem('procure-banner-closed')) {
    bannerContainer.style.display = 'none';
    return;
  }

  const alerts = safeGet(PROJECT_DATA, 'config.procurement_alerts', []);
  if (!Array.isArray(alerts) || alerts.length === 0) {
    bannerContainer.style.display = 'none';
    return;
  }

  // Categorize by urgency/timing
  const now = alerts.filter(a => String(a.timing || '').toLowerCase() === 'now');
  const twoWeeks = alerts.filter(a => String(a.timing || '').toLowerCase().includes('2 week'));
  const fourWeeks = alerts.filter(a => String(a.timing || '').toLowerCase().includes('4 week'));

  let html = '<div class="procurement-banner">';
  html += '<div class="procurement-banner-content">';

  if (now.length > 0) {
    html += `<div class="procurement-item critical">‚ö†Ô∏è NOW: ${esc(now.map(a => a.item).join(', '))}</div>`;
  }
  if (twoWeeks.length > 0) {
    html += `<div class="procurement-item warning">‚è±Ô∏è 2 WEEKS: ${esc(twoWeeks.map(a => a.item).join(', '))}</div>`;
  }
  if (fourWeeks.length > 0) {
    html += `<div class="procurement-item info">‚ÑπÔ∏è 4+ WEEKS: ${esc(fourWeeks.map(a => a.item).join(', '))}</div>`;
  }

  html += '</div>';
  html += '<button class="procurement-banner-close" onclick="sessionStorage.setItem(\'procure-banner-closed\', \'true\'); document.getElementById(\'procurement-banner-container\').style.display = \'none\';">‚úï</button>';
  html += '</div>';

  bannerContainer.innerHTML = html;
  bannerContainer.style.display = 'block';
}

// 8. CORE RENDERERS
// =================

/**
 * renderOverview - Main dashboard overview
 */
function renderOverview() {
  const container = $('section-overview');
  if (!container) return;

  const projectName = safeGet(PROJECT_DATA, 'config.project_name', 'Morehead One Senior Care');
  const buildingSF = safeGet(PROJECT_DATA, 'config.building_sf', '9,980');
  const rooms = safeGet(PROJECT_DATA, 'spatial.room_schedule', {});
  const roomCount = arrLen(safeGet(rooms, 'resident_rooms', [])) +
                    arrLen(safeGet(rooms, 'common_areas', [])) +
                    arrLen(safeGet(rooms, 'support_spaces', []));
  const doors = safeGet(PROJECT_DATA, 'spatial.door_schedule', []);
  const scheduleDays = safeGet(PROJECT_DATA, 'config.schedule_baseline_days', '151');
  const nextMilestone = safeGet(PROJECT_DATA, 'config.next_milestone', 'PEMB Erection');

  // Get alerts
  const allAlerts = gatherAllAlerts();
  const criticalAlerts = allAlerts.filter(a => a.level === 'critical').length;
  const warningAlerts = allAlerts.filter(a => a.level === 'warning').length;

  // Calculate data completeness
  const completeness = calculateDataCompleteness();
  const completenessPct = Math.round((completeness.populated / (completeness.populated + completeness.total)) * 100);

  // Role-specific landing
  const roleLanding = getRoleLanding(ACTIVE_ROLE);

  let html = `<div class="overview-container">
    <div class="overview-header">
      <h1>${esc(projectName)}</h1>
      <p class="subtitle">Dashboard powered by Foreman OS | Role: ${esc(ACTIVE_ROLE)}</p>
    </div>

    <div class="alert-summary">
      ${criticalAlerts > 0 ? `<div class="alert-item critical"><strong>${criticalAlerts}</strong> Critical</div>` : ''}
      ${warningAlerts > 0 ? `<div class="alert-item warning"><strong>${warningAlerts}</strong> Warnings</div>` : ''}
      ${criticalAlerts === 0 && warningAlerts === 0 ? '<div class="alert-item info">No active alerts</div>' : ''}
    </div>

    <div class="cards-grid">
      ${cardHTML('Building Size', formatNumber(buildingSF) + ' SF', 'Gross building area', 'üìê')}
      ${cardHTML('Rooms & Spaces', formatNumber(roomCount), 'Total rooms scheduled', 'üè†')}
      ${cardHTML('Doors & Hardware', formatNumber(doors.length), 'Total door openings', 'üö™')}
      ${cardHTML('Schedule', formatNumber(scheduleDays) + ' days', 'Baseline duration', 'üìÖ')}
      ${cardHTML('Next Milestone', esc(nextMilestone), 'Critical path activity', 'üéØ')}
      ${cardHTML('Data Completeness', completenessPct + '%', 'Information populated', 'üìä')}
    </div>

    <div class="overview-sections">
      <div class="section-column">
        <h2>Project Status</h2>
        <div class="kv-grid">
          ${kvRow('Current Phase', safeGet(PROJECT_DATA, 'config.current_phase', 'Foundation / Sitework'))}
          ${kvRow('Days Elapsed', calculateDaysElapsed())}
          ${kvRow('Progress to Schedule', calculateScheduleProgress() + '%')}
          ${kvRow('Status', getProjectStatus())}
        </div>
      </div>

      <div class="section-column">
        <h2>Quick Alerts</h2>
        ${allAlerts.slice(0, 5).map(a =>
          `<div class="alert-row alert-${a.level}">
            <strong>${esc(a.title)}</strong>
            <p>${esc(a.description)}</p>
          </div>`
        ).join('') || '<p class="text-muted">No alerts</p>'}
      </div>
    </div>

    <div class="completeness-widget">
      <h2>Data Completeness</h2>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${completenessPct}%"></div>
      </div>
      <p class="text-muted">${completeness.populated} of ${completeness.populated + completeness.total} fields populated</p>
    </div>
  </div>`;

  container.innerHTML = html;
}

/**
 * renderAlerts - Comprehensive alerts view
 */
function renderAlerts() {
  const container = $('section-alerts');
  if (!container) return;

  const allAlerts = gatherAllAlerts();

  if (allAlerts.length === 0) {
    container.innerHTML = emptyState('‚úì', 'No Active Alerts', 'All systems normal. Keep monitoring project conditions.');
    return;
  }

  const criticalAlerts = allAlerts.filter(a => a.level === 'critical');
  const warningAlerts = allAlerts.filter(a => a.level === 'warning');
  const infoAlerts = allAlerts.filter(a => a.level === 'info');

  let html = '<div class="alerts-container">';

  if (criticalAlerts.length > 0) {
    html += '<div class="alerts-section"><h2>Critical Issues</h2>';
    criticalAlerts.forEach(alert => {
      html += `<div class="alert-card alert-critical">
        <div class="alert-header">
          <h3>${esc(alert.title)}</h3>
          <span class="badge status-critical">${esc(alert.source)}</span>
        </div>
        <p>${esc(alert.description)}</p>
        <div class="alert-actions">
          ${alert.link ? `<a href="#${esc(alert.link)}" class="btn-small">View Details</a>` : ''}
        </div>
      </div>`;
    });
    html += '</div>';
  }

  if (warningAlerts.length > 0) {
    html += '<div class="alerts-section"><h2>Warnings</h2>';
    warningAlerts.forEach(alert => {
      html += `<div class="alert-card alert-warning">
        <div class="alert-header">
          <h3>${esc(alert.title)}</h3>
          <span class="badge status-warning">${esc(alert.source)}</span>
        </div>
        <p>${esc(alert.description)}</p>
        <div class="alert-actions">
          ${alert.link ? `<a href="#${esc(alert.link)}" class="btn-small">View Details</a>` : ''}
        </div>
      </div>`;
    });
    html += '</div>';
  }

  if (infoAlerts.length > 0) {
    html += '<div class="alerts-section"><h2>Information</h2>';
    infoAlerts.forEach(alert => {
      html += `<div class="alert-card alert-info">
        <div class="alert-header">
          <h3>${esc(alert.title)}</h3>
          <span class="badge">${esc(alert.source)}</span>
        </div>
        <p>${esc(alert.description)}</p>
        <div class="alert-actions">
          ${alert.link ? `<a href="#${esc(alert.link)}" class="btn-small">View Details</a>` : ''}
        </div>
      </div>`;
    });
    html += '</div>';
  }

  html += '</div>';
  container.innerHTML = html;
}

/**
 * renderCompleteness - Data completeness tracking
 */
function renderCompleteness() {
  const container = $('section-completeness');
  if (!container) return;

  const categories = [
    { name: 'Rooms & Areas', key: 'rooms', populated: arrLen(safeGet(PROJECT_DATA, 'spatial.room_schedule.resident_rooms', [])), total: 16 },
    { name: 'Doors & Hardware', key: 'doors', populated: arrLen(safeGet(PROJECT_DATA, 'spatial.door_schedule', [])), total: 52 },
    { name: 'MEP Equipment', key: 'mep', populated: arrLen(safeGet(PROJECT_DATA, 'mep.equipment', [])), total: 15 },
    { name: 'Submittals Logged', key: 'submittals', populated: arrLen(safeGet(PROJECT_DATA, 'config.submittals_log', [])), total: 10 },
    { name: 'Specifications', key: 'specs', populated: arrLen(safeGet(PROJECT_DATA, 'config.spec_sections', [])), total: 20 },
    { name: 'Contract Values', key: 'financials', populated: safeGet(PROJECT_DATA, 'config.financial_summary.total_contract') ? 1 : 0, total: 1 },
    { name: 'Schedule Dates', key: 'schedule', populated: safeGet(PROJECT_DATA, 'config.schedule') ? 1 : 0, total: 1 },
    { name: 'Contact Information', key: 'contacts', populated: arrLen(safeGet(PROJECT_DATA, 'config.team_contacts', [])), total: 8 }
  ];

  let html = '<div class="completeness-container"><h2>Data Completeness By Category</h2>';

  categories.forEach(cat => {
    const pct = cat.total > 0 ? Math.round((cat.populated / cat.total) * 100) : 0;
    const status = pct >= 80 ? 'complete' : pct >= 50 ? 'partial' : 'incomplete';

    html += `<div class="completeness-row">
      <label>${esc(cat.name)}</label>
      <div class="completeness-bar">
        <div class="bar-fill status-${status}" style="width: ${pct}%"></div>
      </div>
      <span class="pct-label">${pct}% (${cat.populated}/${cat.total})</span>
    </div>`;
  });

  html += `<div class="completeness-guidance">
    <h3>Next Steps</h3>
    <ul>
      <li>Use /daily-report to log work and activities</li>
      <li>Use /submittal-review to track submittals</li>
      <li>Use /prepare-rfi for open questions</li>
      <li>Use /update to add missing project data</li>
    </ul>
  </div></div>`;

  container.innerHTML = html;
}

/**
 * renderRevisions - ASI and revision tracking
 */
function renderRevisions() {
  const container = $('section-revisions');
  if (!container) return;

  const asiLog = safeGet(PROJECT_DATA, 'config.asi_log', []);

  if (!Array.isArray(asiLog) || asiLog.length === 0) {
    container.innerHTML = emptyState('üìã', 'No Revisions', 'No ASIs or revisions logged yet.');
    return;
  }

  let html = '<div class="revisions-container"><h2>ASI & Revision Log</h2>';
  html += '<table class="table"><thead><tr>';
  html += '<th>ASI #</th><th>Date</th><th>Title</th><th>Status</th><th>Affected Docs</th></tr></thead><tbody>';

  asiLog.forEach(asi => {
    html += `<tr>
      <td>${esc(asi.number || asi.id)}</td>
      <td>${formatDate(asi.date)}</td>
      <td>${esc(asi.title || asi.description)}</td>
      <td>${statusBadge(asi.status)}</td>
      <td>${esc((Array.isArray(asi.sheets) ? asi.sheets.join(', ') : asi.sheets) || '‚Äî')}</td>
    </tr>`;
  });

  html += '</tbody></table></div>';
  container.innerHTML = html;
}

// Helper functions for gathering alerts and completeness
function gatherAllAlerts() {
  const alerts = [];

  // Overdue submittals
  const submittals = safeGet(PROJECT_DATA, 'config.submittals_log', []);
  submittals.forEach(s => {
    if (String(s.status || '').toLowerCase() === 'overdue') {
      alerts.push({
        level: 'critical',
        title: `Submittal Overdue: ${s.item}`,
        description: `${s.supplier} submission overdue for ${s.days_in_review} days`,
        source: 'Submittals',
        link: 'submittals'
      });
    }
  });

  // Unawarded contracts
  const subs = safeGet(PROJECT_DATA, 'subcontractors', []);
  subs.forEach(s => {
    if (String(s.status || '').toLowerCase() === 'pending' || !s.contract_number) {
      alerts.push({
        level: 'warning',
        title: `Subcontract Not Executed: ${s.trade}`,
        description: `${s.name} contract pending award`,
        source: 'Procurement',
        link: 'subcontracts'
      });
    }
  });

  // Procurement alerts
  const procAlerts = safeGet(PROJECT_DATA, 'config.procurement_alerts', []);
  procAlerts.forEach(p => {
    const timing = String(p.timing || '').toLowerCase();
    const level = timing === 'now' ? 'critical' : timing.includes('2 week') ? 'warning' : 'info';
    alerts.push({
      level,
      title: `Procurement Alert: ${p.item}`,
      description: `Action needed: ${p.timing}`,
      source: 'Procurement',
      link: 'procurement'
    });
  });

  // Missing data
  if (!safeGet(PROJECT_DATA, 'spatial.room_schedule')) {
    alerts.push({
      level: 'info',
      title: 'Room Schedule Not Loaded',
      description: 'Room and area data incomplete',
      source: 'Data',
      link: 'rooms'
    });
  }

  return alerts;
}

function calculateDataCompleteness() {
  let populated = 0, total = 0;

  // Check various data categories
  const checks = [
    safeGet(PROJECT_DATA, 'spatial.room_schedule') ? 2 : 0,
    safeGet(PROJECT_DATA, 'spatial.door_schedule') ? 1 : 0,
    safeGet(PROJECT_DATA, 'mep.equipment') ? 1 : 0,
    safeGet(PROJECT_DATA, 'config.submittals_log') ? 1 : 0,
    safeGet(PROJECT_DATA, 'config.spec_sections') ? 1 : 0,
    safeGet(PROJECT_DATA, 'config.schedule') ? 1 : 0,
    safeGet(PROJECT_DATA, 'config.permits') ? 1 : 0,
    safeGet(PROJECT_DATA, 'config.geotech') ? 1 : 0
  ];

  populated = checks.filter(c => c > 0).length;
  total = checks.length;

  return { populated, total };
}

function calculateDaysElapsed() {
  const ntp = safeGet(PROJECT_DATA, 'config.ntp_date');
  if (!ntp) return '‚Äî';
  const start = new Date(ntp);
  const today = new Date();
  const days = Math.floor((today - start) / (1000 * 60 * 60 * 24));
  return days + ' days';
}

function calculateScheduleProgress() {
  const baselineDays = safeGet(PROJECT_DATA, 'config.schedule_baseline_days', 151);
  const daysElapsed = Math.floor((new Date() - new Date(safeGet(PROJECT_DATA, 'config.ntp_date'))) / (1000 * 60 * 60 * 24));
  if (baselineDays === 0) return 0;
  return Math.min(Math.round((daysElapsed / baselineDays) * 100), 100);
}

function getProjectStatus() {
  const phase = safeGet(PROJECT_DATA, 'config.current_phase', '');
  if (phase.toLowerCase().includes('complete')) return 'Complete';
  if (phase.toLowerCase().includes('finish')) return 'Finishing';
  if (phase.toLowerCase().includes('rough')) return 'Rough-In';
  if (phase.toLowerCase().includes('erect')) return 'Erection';
  if (phase.toLowerCase().includes('found')) return 'Foundation';
  return 'Active';
}

// 9. TAB SYSTEM UTILITY
// ====================

function initTabs(containerId) {
  const container = $(containerId);
  if (!container) return;

  const buttons = container.querySelectorAll('.tab-btn');
  const contents = container.querySelectorAll('.tab-content');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-tab');

      // Deactivate all tabs
      buttons.forEach(b => b.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));

      // Activate clicked tab
      btn.classList.add('active');
      const target = $(`tab-${targetId}`);
      if (target) target.classList.add('active');
    });
  });
}

// 10. PLACEHOLDER RENDERERS
// =========================
// These are minimal stubs; full implementations follow in Part 3B+

function renderGridLines() { renderPlaceholder('section-gridlines', 'Gridlines & Layout'); }
function renderAreas() { renderPlaceholder('section-areas', 'Areas & Zones'); }
function renderRooms() { renderPlaceholder('section-rooms', 'Rooms & Schedule'); }
function renderDoors() { renderPlaceholder('section-doors', 'Doors & Hardware'); }
function renderPEMB() { renderPlaceholder('section-pemb', 'PEMB Structure'); }
function renderMEP() { renderPlaceholder('section-mep', 'MEP Systems'); }
function renderSite() { renderPlaceholder('section-site', 'Site & Civil'); }
function renderTakeoff() { renderPlaceholder('section-takeoff', 'Material Takeoff'); }
function renderMaterials() { renderPlaceholder('section-materials', 'Materials & Equipment'); }
function renderBidding() { renderPlaceholder('section-bidding', 'Bidding & Procurement'); }
function renderCalculator() { renderPlaceholder('section-calculator', 'Calculator'); }
function renderFinancials() { renderPlaceholder('section-financials', 'Financials'); }
function renderSubcontracts() { renderPlaceholder('section-subcontracts', 'Subcontracts'); }
function renderChangeOrders() { renderPlaceholder('section-changeorders', 'Change Orders'); }
function renderPayApps() { renderPlaceholder('section-payapps', 'Pay Applications'); }
function renderSpecs() { renderPlaceholder('section-specs', 'Specifications'); }
function renderMixDesigns() { renderPlaceholder('section-mixdesigns', 'Mix Designs'); }
function renderTolerances() { renderPlaceholder('section-tolerances', 'Tolerances'); }
function renderWeather() { renderPlaceholder('section-weather', 'Weather'); }
function renderHoldPoints() { renderPlaceholder('section-holdpoints', 'Hold Points'); }
function renderSchedule() { renderPlaceholder('section-schedule', 'Schedule'); }
function renderProcurement() { renderPlaceholder('section-procurement', 'Procurement'); }
function renderSubmittals() { renderPlaceholder('section-submittals', 'Submittals'); }
function renderRFIs() { renderPlaceholder('section-rfis', 'RFIs'); }
function renderPermits() { renderPlaceholder('section-permits', 'Permits'); }
function renderSheetIndex() { renderPlaceholder('section-sheetindex', 'Sheet Index'); }
function renderOverlay() { renderPlaceholder('section-overlay', 'Plan Overlay'); }
function renderCorrelation() { renderPlaceholder('section-correlation', 'Correlation'); }
function renderProgress() { renderPlaceholder('section-progress', 'Progress'); }
function renderRenderings() { renderPlaceholder('section-renderings', 'Renderings'); }
function renderDelays() { renderPlaceholder('section-delays', 'Delays'); }
function renderPunchList() { renderPlaceholder('section-punchlist', 'Punch List'); }
function renderMeetings() { renderPlaceholder('section-meetings', 'Meetings'); }
function renderGeotech() { renderPlaceholder('section-geotech', 'Geotechnical'); }
function renderSWPPP() { renderPlaceholder('section-swppp', 'SWPPP'); }

function renderPlaceholder(elementId, title) {
  const el = $(elementId);
  if (el) {
    el.innerHTML = `<div class="placeholder-section"><h2>${esc(title)}</h2><p>Content coming in Part 3B...</p></div>`;
  }
}

// 11. INIT FUNCTION
// =================

function initDashboard() {
  buildSearchIndex();
  initSidebar();
  initRoleSelector();
  initCommandPalette();
  updateSidebarVisibility();
  renderProcurementBanner();
  renderOverview();

  // Check URL hash for direct section navigation
  if (window.location.hash) {
    const section = window.location.hash.substring(1);
    showSection(section);
  }
}

// Initialize when DOM is ready and PROJECT_DATA is loaded
document.addEventListener('DOMContentLoaded', () => {
  if (typeof PROJECT_DATA !== 'undefined' && Object.keys(PROJECT_DATA).length > 0) {
    initDashboard();
  } else {
    // Wait for external data.js to load
    window.addEventListener('projectDataLoaded', initDashboard);
  }
});

// ===========================
// PART 3B: SPATIAL RENDERERS
// ===========================
// Production-quality renderer functions for spatial sections:
// gridlines, areas, rooms, doors, pemb, mep, site
// These populate HTML sections from Part 2 using PROJECT_DATA
// All helper functions (esc, cardHTML, kvGrid, etc.) are defined in Part 3A

// ============================================================================
// 1. RENDER GRID LINES
// ============================================================================
/**
 * renderGridLines() - Structural grid visualization and bay dimensions
 * Pull from PROJECT_DATA.spatial.grid_lines
 * Shows: X/Y grid counts, spacing table, SVG visualization with labels
 */
function renderGridLines() {
  const container = $('section-gridlines');
  if (!container) return;

  const gridData = safeGet(PROJECT_DATA, 'spatial.grid_lines');
  if (!gridData) {
    container.innerHTML = emptyState('üìê', 'No Grid Data', 'Grid lines and dimensions not available.');
    return;
  }

  const xGrids = safeGet(gridData, 'x_grids', []);
  const yGrids = safeGet(gridData, 'y_grids', []);
  const dimensions = safeGet(gridData, 'grid_dimensions', {});

  // Build kv-grid summary
  const gridDetailPairs = [
    ['X-Grids', arrLen(xGrids) + ' (Lines ' + (xGrids.join(', ') || '‚Äî') + ')'],
    ['Y-Grids', arrLen(yGrids) + ' (Lines ' + (yGrids.join(', ') || '‚Äî') + ')'],
    ['Building Length', esc(safeGet(dimensions, 'total_length', '‚Äî'))],
    ['Building Width', esc(safeGet(dimensions, 'total_width', '‚Äî'))]
  ];

  let html = '<div class="gridlines-container">';

  // Grid detail kv-grid
  const detailEl = $('grid-detail');
  if (detailEl) {
    detailEl.innerHTML = kvGrid(gridDetailPairs);
  }

  // Grid spacing table
  const spacingTbody = document.querySelector('#grid-spacing-table tbody');
  if (spacingTbody) {
    const spacingRows = [];

    // X-direction spacings
    for (let i = 0; i < xGrids.length - 1; i++) {
      const from = xGrids[i];
      const to = xGrids[i + 1];
      const key = from + '_to_' + to;
      const dim = dimensions[key] || '‚Äî';
      spacingRows.push({
        bay: 'X' + from + ' ‚Üí X' + to,
        dimension: esc(dim)
      });
    }

    // End spacing if exists
    const endSpacing = safeGet(dimensions, '5_to_beyond');
    if (endSpacing) {
      spacingRows.push({
        bay: 'X5 ‚Üí Beyond (end)',
        dimension: esc(endSpacing)
      });
    }

    tableRows(spacingTbody, spacingRows, ['bay', 'dimension']);
  }

  // SVG Grid Visualization
  const svgContainer = $('grid-svg');
  if (svgContainer) {
    renderGridSVG(svgContainer, xGrids, yGrids, dimensions);
  }

  container.innerHTML = html || '';
}

/**
 * renderGridSVG() - Draw proportional grid in SVG
 * Scales to fit viewBox, includes labels and dimensions
 */
function renderGridSVG(container, xGrids, yGrids, dimensions) {
  if (!xGrids || !yGrids || xGrids.length === 0 || yGrids.length === 0) {
    container.innerHTML = emptyState('‚úó', 'Cannot render', 'Insufficient grid data');
    return;
  }

  // Parse dimensions to get total size
  const totalLength = parseNum(safeGet(dimensions, 'total_length', '100'));
  const totalWidth = parseNum(safeGet(dimensions, 'total_width', '75'));
  const scale = 500 / totalLength; // Scale to fit 500pt width

  // Viewbox is roughly 20% padding
  const padding = 60;
  const svgWidth = totalLength * scale + padding * 2;
  const svgHeight = totalWidth * scale + padding * 2;

  let svg = `<svg viewBox="0 0 ${svgWidth} ${svgHeight}" class="grid-svg" preserveAspectRatio="xMidYMid meet">`;
  svg += '<defs><style>';
  svg += '.grid-line { stroke: #333; stroke-width: 1.5; } ';
  svg += '.grid-label { font-size: 12px; text-anchor: middle; fill: #333; font-weight: bold; } ';
  svg += '.grid-dim { font-size: 10px; text-anchor: middle; fill: #666; } ';
  svg += '</style></defs>';

  // Draw X-grid lines (vertical)
  let xOffset = padding;
  xGrids.forEach((gridLabel, idx) => {
    svg += `<line class="grid-line" x1="${xOffset}" y1="${padding}" x2="${xOffset}" y2="${svgHeight - padding}" />`;
    svg += `<text class="grid-label" x="${xOffset}" y="${svgHeight - 10}">X${gridLabel}</text>`;

    // Draw dimension between grids
    if (idx < xGrids.length - 1) {
      const nextOffset = xOffset + (parseNum(dimensions[gridLabel + '_to_' + xGrids[idx + 1]] || '26.667') * scale);
      const midX = (xOffset + nextOffset) / 2;
      svg += `<text class="grid-dim" x="${midX}" y="${15}">${dimensions[gridLabel + '_to_' + xGrids[idx + 1]] || '‚Äî'}</text>`;
      xOffset = nextOffset;
    }
  });

  // Draw Y-grid lines (horizontal)
  let yOffset = padding;
  yGrids.forEach((gridLabel) => {
    svg += `<line class="grid-line" x1="${padding}" y1="${yOffset}" x2="${svgWidth - padding}" y2="${yOffset}" />`;
    svg += `<text class="grid-label" x="20" y="${yOffset + 4}">Y${gridLabel}</text>`;
    yOffset += (totalWidth * scale) / (yGrids.length - 1);
  });

  // Building outline
  svg += `<rect x="${padding}" y="${padding}" width="${totalLength * scale}" height="${totalWidth * scale}" fill="none" stroke="#999" stroke-width="2" stroke-dasharray="5,5" />`;

  svg += '</svg>';
  container.innerHTML = svg;
}

// ============================================================================
// 2. RENDER AREAS
// ============================================================================
/**
 * renderAreas() - Building areas and zone breakdown
 * Pull from PROJECT_DATA.spatial.building_areas
 * Shows: summary cards (total SF, footprint, stories, type) + breakdown table
 */
function renderAreas() {
  const container = $('section-areas');
  if (!container) return;

  const areaData = safeGet(PROJECT_DATA, 'spatial.building_areas');
  if (!areaData) {
    container.innerHTML = emptyState('üìè', 'No Area Data', 'Building area information not available.');
    return;
  }

  const grossSF = safeGet(areaData, 'gross_building_area_sf');
  const footprint = safeGet(areaData, 'building_footprint');
  const stories = safeGet(areaData, 'stories', '1');
  const constructionType = safeGet(areaData, 'construction_type');
  const occupancy = safeGet(areaData, 'occupancy');
  const occupantLoad = safeGet(areaData, 'occupant_load');
  const ffe = safeGet(areaData, 'ffe');

  // Summary cards
  const cardsEl = $('area-cards');
  if (cardsEl) {
    let cardsHtml = '';
    cardsHtml += cardHTML('Gross Building Area', formatNumber(grossSF) + ' SF', 'Total enclosed space', 'üìê');
    cardsHtml += cardHTML('Footprint', esc(footprint), 'Building perimeter dimensions', '‚ñ¢');
    cardsHtml += cardHTML('Stories', esc(stories), 'Number of floor levels', 'üìä');
    cardsHtml += cardHTML('Construction Type', esc(constructionType), 'Building code classification', 'üèóÔ∏è');
    cardsHtml += cardHTML('Occupancy Class', esc(occupancy), 'Primary use type', 'üë•');
    cardsHtml += cardHTML('Occupant Load', formatNumber(occupantLoad), 'Maximum occupancy', 'üö™');

    cardsEl.innerHTML = cardsHtml;
  }

  // Breakdown table (by type if available)
  const breakdownTbody = document.querySelector('#area-breakdown tbody');
  if (breakdownTbody) {
    const breakdownRows = [
      {
        area_type: 'Gross Building Area',
        square_feet: formatNumber(grossSF),
        percentage: '100.0%',
        rooms: '‚Äî'
      },
      {
        area_type: 'Construction Type',
        square_feet: '‚Äî',
        percentage: '‚Äî',
        rooms: esc(constructionType)
      },
      {
        area_type: 'Occupancy Class',
        square_feet: '‚Äî',
        percentage: '‚Äî',
        rooms: esc(occupancy)
      }
    ];

    tableRows(breakdownTbody, breakdownRows, ['area_type', 'square_feet', 'percentage', 'rooms']);
  }
}

// ============================================================================
// 3. RENDER ROOMS (COMPLEX - Enhanced Room Browser)
// ============================================================================
/**
 * renderRooms() - Interactive room browser with floor plan visualization
 * Features:
 * - Summary bar: total rooms, total SF, avg SF
 * - SVG floor plan (color-coded by type)
 * - Searchable/filterable table
 * - Click room ‚Üí detail fact sheet
 */
function renderRooms() {
  const container = $('section-rooms');
  if (!container) return;

  const roomData = safeGet(PROJECT_DATA, 'spatial.room_schedule');
  if (!roomData) {
    container.innerHTML = emptyState('üè†', 'No Room Data', 'Room schedule not available.');
    return;
  }

  // Gather all rooms from all categories
  const allRooms = [];
  const categories = ['resident_rooms', 'common_areas', 'support_spaces', 'restrooms', 'entries_corridors'];
  const roomsByCategory = safeGet(roomData, 'rooms_by_area', {});

  categories.forEach(cat => {
    const roomList = safeGet(roomsByCategory, cat, []);
    if (Array.isArray(roomList)) {
      roomList.forEach(room => {
        allRooms.push({
          ...room,
          type: getCategoryLabel(cat)
        });
      });
    }
  });

  if (allRooms.length === 0) {
    container.innerHTML = emptyState('üè†', 'No Rooms', 'Room schedule is empty.');
    return;
  }

  // Calculate stats
  const totalRooms = allRooms.length;
  const totalSF = allRooms.reduce((sum, r) => sum + (parseNum(r.area_sf) || 0), 0);
  const avgSF = totalRooms > 0 ? (totalSF / totalRooms).toFixed(1) : 0;

  // Update summary bar
  const summaryEl = $('room-summary-stats');
  if (summaryEl) {
    const summaryPairs = [
      ['Total Rooms', formatNumber(totalRooms)],
      ['Total SF (Scheduled)', formatNumber(totalSF) + ' SF'],
      ['Average Room Size', formatNumber(avgSF) + ' SF']
    ];
    summaryEl.innerHTML = kvGrid(summaryPairs);
  }

  // Render floor plan SVG
  const floorplanEl = $('room-floorplan');
  if (floorplanEl) {
    renderRoomFloorplan(floorplanEl, allRooms);
  }

  // Populate room type and floor filters
  const typeSelect = document.querySelector('#room-filter-type');
  if (typeSelect) {
    const types = [...new Set(allRooms.map(r => r.type))].sort();
    types.forEach(type => {
      const opt = document.createElement('option');
      opt.value = type;
      opt.textContent = type;
      typeSelect.appendChild(opt);
    });
  }

  // Populate room table with all rooms
  const roomTbody = document.querySelector('#room-table tbody');
  if (roomTbody) {
    populateRoomTable(roomTbody, allRooms);

    // Add search/filter listeners
    const searchInput = document.querySelector('#room-search-text');
    const typeFilter = document.querySelector('#room-filter-type');

    if (searchInput || typeFilter) {
      const updateTable = () => {
        const searchTerm = (searchInput?.value || '').toLowerCase();
        const selectedType = typeFilter?.value || '';

        const filtered = allRooms.filter(r => {
          const matchSearch = !searchTerm ||
            String(r.room).toLowerCase().includes(searchTerm) ||
            String(r.name).toLowerCase().includes(searchTerm);
          const matchType = !selectedType || r.type === selectedType;
          return matchSearch && matchType;
        });

        populateRoomTable(roomTbody, filtered);
        attachRoomClickHandlers();
      };

      if (searchInput) searchInput.addEventListener('input', updateTable);
      if (typeFilter) typeFilter.addEventListener('change', updateTable);
    }

    // Attach click handlers to show detail panel
    attachRoomClickHandlers();
  }
}

/**
 * renderRoomFloorplan() - SVG grid layout of rooms, color-coded by type
 */
function renderRoomFloorplan(container, rooms) {
  // Simple grid layout: arrange rooms in rows
  const cols = 5;
  const roomWidth = 120;
  const roomHeight = 100;
  const padding = 20;

  const svgWidth = cols * roomWidth + padding * 2;
  const svgHeight = Math.ceil(rooms.length / cols) * roomHeight + padding * 2;

  let svg = `<svg viewBox="0 0 ${svgWidth} ${svgHeight}" class="room-floorplan-svg">`;
  svg += '<defs><style>';
  svg += '.room-rect { stroke: #333; stroke-width: 1.5; cursor: pointer; } ';
  svg += '.room-rect-bedroom { fill: #6db3f2; opacity: 0.7; } ';
  svg += '.room-rect-common { fill: #98c272; opacity: 0.7; } ';
  svg += '.room-rect-support { fill: #f4b084; opacity: 0.7; } ';
  svg += '.room-rect-restroom { fill: #93c5d5; opacity: 0.7; } ';
  svg += '.room-rect-corridor { fill: #d5d5d5; opacity: 0.7; } ';
  svg += '.room-label { font-size: 11px; text-anchor: middle; fill: #333; font-weight: bold; } ';
  svg += '.room-label-small { font-size: 9px; text-anchor: middle; fill: #666; } ';
  svg += '.room-rect:hover { opacity: 1 !important; stroke-width: 2.5; } ';
  svg += '</style></defs>';

  // Draw rooms
  rooms.forEach((room, idx) => {
    const col = idx % cols;
    const row = Math.floor(idx / cols);
    const x = padding + col * roomWidth;
    const y = padding + row * roomHeight;

    const rectClass = getRoomTypeClass(room.type);
    svg += `<rect class="room-rect ${rectClass}" x="${x}" y="${y}" width="${roomWidth - 8}" height="${roomHeight - 8}" data-room-id="${esc(room.room || idx)}" />`;
    svg += `<text class="room-label" x="${x + (roomWidth - 8) / 2}" y="${y + (roomHeight - 8) / 2 - 5}">${esc(room.room || '')}</text>`;
    svg += `<text class="room-label-small" x="${x + (roomWidth - 8) / 2}" y="${y + (roomHeight - 8) / 2 + 10}">${esc(room.name || '').substring(0, 15)}</text>`;
  });

  svg += '</svg>';
  container.innerHTML = svg;

  // Attach click handlers to SVG rooms
  const svgRects = container.querySelectorAll('.room-rect');
  svgRects.forEach(rect => {
    rect.addEventListener('click', function() {
      const roomId = this.getAttribute('data-room-id');
      const room = rooms.find(r => String(r.room) === roomId);
      if (room) showRoomDetail(room);
    });
  });
}

/**
 * populateRoomTable() - Fill room table tbody with rows
 */
function populateRoomTable(tbody, rooms) {
  const rows = rooms.map(r => ({
    room_num: esc(r.room || '‚Äî'),
    name: esc(r.name || '‚Äî'),
    type: esc(r.type || '‚Äî'),
    area_sf: r.area_sf ? formatNumber(r.area_sf) : '‚Äî',
    floor: esc(r.floor || '1'),
    ceiling_ht: esc(r.ceiling_height || '9\''),
    doors: esc(r.doors || '‚Äî')
  }));

  const tbody_el = tbody;
  tbody_el.innerHTML = '';

  if (rows.length === 0) {
    tbody_el.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2em;">No rooms match filters</td></tr>';
    return;
  }

  rows.forEach((row, idx) => {
    const tr = document.createElement('tr');
    tr.className = 'room-row';
    tr.setAttribute('data-room-id', String(rooms[idx].room || idx));
    tr.style.cursor = 'pointer';

    tr.innerHTML = `
      <td>${row.room_num}</td>
      <td>${row.name}</td>
      <td>${row.type}</td>
      <td>${row.area_sf}</td>
      <td>${row.floor}</td>
      <td>${row.ceiling_ht}</td>
      <td>${row.doors}</td>
    `;

    tr.addEventListener('click', () => showRoomDetail(rooms[idx]));
    tbody_el.appendChild(tr);
  });
}

/**
 * attachRoomClickHandlers() - Attach click handlers to room rows
 */
function attachRoomClickHandlers() {
  const rows = document.querySelectorAll('.room-row');
  rows.forEach(row => {
    row.addEventListener('click', function() {
      const roomId = this.getAttribute('data-room-id');
      // Handler is already attached during populateRoomTable
    });
  });
}

/**
 * showRoomDetail() - Display room fact sheet in detail panel
 * Enhanced with finishes, doors, MEP, specs, furniture, and specialties
 */
function showRoomDetail(room) {
  const panel = $('room-detail-panel');
  if (!panel) return;

  const roomNum = room.room || room;
  const roomData = safeGet(PROJECT_DATA, 'spatial.room_schedule');
  const finishSchedule = safeGet(roomData, 'finish_schedule', {});
  const specsData = safeGet(PROJECT_DATA, 'specs', {});

  // Determine finish category based on room type
  let finishKey = 'corridor';
  const roomTypeStr = String(room.type || '').toLowerCase();
  if (roomTypeStr.includes('bedroom')) finishKey = 'typical_bedroom';
  else if (roomTypeStr.includes('kitchen')) finishKey = 'kitchen';
  else if (roomTypeStr.includes('restroom')) finishKey = 'restroom';
  else if (roomTypeStr.includes('mechanical')) finishKey = 'mechanical';
  else if (roomTypeStr.includes('common')) finishKey = 'great_room';
  else if (roomTypeStr.includes('support')) finishKey = 'support_space';

  const finishes = safeGet(finishSchedule, finishKey, {});

  let html = '<div class="room-fact-sheet">';
  html += `<button onclick="$('room-detail-panel').style.display='none'" style="float:right;background:none;border:none;cursor:pointer;font-size:18px;">‚úï</button>`;
  html += `<h2>ROOM ${esc(roomNum)} ‚Äî ${esc(room.name || '‚Äî')}</h2>`;
  html += `<p class="fact-sheet-meta">Type: <strong>${esc(room.type || '‚Äî')}</strong> | Area: <strong>${room.area_sf ? formatNumber(room.area_sf) + ' SF' : '‚Äî'}</strong> | Ceiling: <strong>${esc(room.ceiling_height || '9\'-0"')}</strong></p>`;

  // FINISHES SECTION
  if (Object.keys(finishes).length > 0) {
    html += '<h3>Finishes</h3>';
    html += kvGrid([
      ['Floor', esc(safeGet(finishes, 'floor', '‚Äî'))],
      ['Walls', esc(safeGet(finishes, 'walls', '‚Äî'))],
      ['Ceiling', esc(safeGet(finishes, 'ceiling', '‚Äî'))],
      ['Base', esc(safeGet(finishes, 'base', '‚Äî'))],
      ['Special', esc(safeGet(finishes, 'special', '‚Äî'))]
    ]);
  } else {
    html += '<h3>Finishes</h3>';
    html += '<p style="font-style:italic;color:#999;">Run /process-docs on architectural drawings to populate finish schedule</p>';
  }

  // DOORS SECTION
  const doorSchedule = safeGet(PROJECT_DATA, 'spatial.door_schedule');
  const doorsForThisRoom = findDoorsForRoom(room, doorSchedule);
  if (doorsForThisRoom && doorsForThisRoom.length > 0) {
    html += '<h3>Doors</h3>';
    const doorRows = doorsForThisRoom.map(d => ({
      mark: esc(d.type || d.mark || '‚Äî'),
      description: esc(d.description || '‚Äî'),
      size: esc(d.size || '3\'-0" x 7\'-0"'),
      fire_rating: esc(d.fire_rating || '‚Äî'),
      hardware_set: esc(d.hardware_set || 'Per type')
    }));
    html += `<table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead><tr style="background:#f5f5f5;">
        <th style="border:1px solid #ddd;padding:6px;">Mark</th>
        <th style="border:1px solid #ddd;padding:6px;">Description</th>
        <th style="border:1px solid #ddd;padding:6px;">Size</th>
        <th style="border:1px solid #ddd;padding:6px;">Rating</th>
        <th style="border:1px solid #ddd;padding:6px;">Hardware</th>
      </tr></thead>
      <tbody>`;
    doorRows.forEach(d => {
      html += `<tr><td style="border:1px solid #ddd;padding:6px;">${d.mark}</td>
        <td style="border:1px solid #ddd;padding:6px;">${d.description}</td>
        <td style="border:1px solid #ddd;padding:6px;">${d.size}</td>
        <td style="border:1px solid #ddd;padding:6px;">${d.fire_rating}</td>
        <td style="border:1px solid #ddd;padding:6px;">${d.hardware_set}</td></tr>`;
    });
    html += '</tbody></table>';
  } else {
    html += '<h3>Doors</h3>';
    html += '<p style="font-style:italic;color:#999;">No doors found for this room. Check door schedule cross-references.</p>';
  }

  // CASEWORK SECTION
  html += '<h3>Casework & Built-ins</h3>';
  const cabinetSchedule = safeGet(specsData, 'cabinet_schedule', {});
  const cabinetForThisRoom = cabinetSchedule[String(room.room)] || null;
  if (cabinetForThisRoom) {
    html += kvGrid([
      ['Type', esc(cabinetForThisRoom.type || '‚Äî')],
      ['Location', esc(cabinetForThisRoom.location || '‚Äî')],
      ['Finish', esc(cabinetForThisRoom.finish || '‚Äî')],
      ['Hardware', esc(cabinetForThisRoom.hardware || '‚Äî')]
    ]);
  } else {
    html += '<p style="font-style:italic;color:#999;">Not yet documented. Run /process-docs on spec submittal SC-825021-03.</p>';
  }

  // MEP SECTION
  html += '<h3>MEP Systems</h3>';
  const mepXref = findMEPForRoom(room, safeGet(PROJECT_DATA, 'spatial.mep_equipment', {}));
  if (mepXref && (mepXref.hvac || mepXref.lighting || mepXref.outlets || mepXref.plumbing)) {
    html += kvGrid([
      ['HVAC Zone', esc(mepXref.hvac || 'TBD')],
      ['Lighting Fixtures', esc(mepXref.lighting || 'TBD')],
      ['Electrical Outlets', esc(mepXref.outlets || 'TBD')],
      ['Plumbing Fixtures', esc(mepXref.plumbing || 'TBD')]
    ]);
  } else {
    html += '<p style="font-style:italic;color:#999;">Run /process-docs on MEP drawings to populate MEP cross-references.</p>';
  }

  // SPECIALTIES SECTION (based on room type)
  const specialties = inferSpecialtiesForRoom(room);
  if (specialties.length > 0) {
    html += '<h3>Specialties & Accessories</h3>';
    html += '<ul>';
    specialties.forEach(s => {
      html += `<li>${esc(s)}</li>`;
    });
    html += '</ul>';
  }

  // FURNITURE SECTION (inferred from room type)
  const furniture = inferFurnitureForRoom(room);
  if (furniture.length > 0) {
    html += '<h3>Typical Furniture & Equipment</h3>';
    html += '<ul>';
    furniture.forEach(f => {
      html += `<li>${esc(f)}</li>`;
    });
    html += '</ul>';
  }

  // CSI SPEC SECTIONS
  html += '<h3>Relevant CSI Specification Sections</h3>';
  const csiSections = inferCSISectionsForRoom(room);
  html += '<p style="font-size:12px;color:#555;">' + csiSections.join(' | ') + '</p>';

  html += '</div>';

  panel.innerHTML = html;
  panel.style.display = 'block';

  // Scroll to panel
  setTimeout(() => panel.scrollIntoView({ behavior: 'smooth' }), 100);
}

/**
 * findDoorsForRoom() - Cross-reference doors that serve a room
 */
function findDoorsForRoom(room, doorSchedule) {
  if (!doorSchedule) return [];

  const doorsForThisRoom = [];
  const doorTypes = safeGet(doorSchedule, 'door_types', {});
  const exterior = safeGet(doorTypes, 'exterior', []);
  const interior = safeGet(doorTypes, 'interior', []);
  const allDoors = [...(Array.isArray(exterior) ? exterior : []), ...(Array.isArray(interior) ? interior : [])];

  // Attempt to cross-ref by room number in door description
  const roomStr = String(room.room || '');
  allDoors.forEach(door => {
    const desc = String(door.description || door.name || '').toLowerCase();
    if (desc.includes(roomStr) || desc.includes(String(room.name || '').toLowerCase())) {
      doorsForThisRoom.push(door);
    }
  });

  return doorsForThisRoom;
}

/**
 * findMEPForRoom() - Cross-reference MEP systems for a room
 */
function findMEPForRoom(room, mepData) {
  if (!mepData) return null;

  const mepXref = {
    hvac: null,
    lighting: null,
    outlets: null,
    plumbing: null
  };

  // HVAC: find zone that includes this room
  const hvacUnits = safeGet(mepData, 'hvac_units', []);
  if (Array.isArray(hvacUnits) && hvacUnits.length > 0) {
    const matchingUnit = hvacUnits.find(u => {
      const rooms = safeGet(u, 'rooms_served', []);
      return Array.isArray(rooms) && rooms.includes(String(room.room));
    });
    if (matchingUnit) mepXref.hvac = esc(safeGet(matchingUnit, 'tag', ''));
  }

  // Lighting & outlets: count by room type
  if (room.type && room.type.toLowerCase().includes('bedroom')) {
    mepXref.lighting = '4-6 fixtures';
    mepXref.outlets = '8-10 outlets';
  } else if (room.type && room.type.toLowerCase().includes('restroom')) {
    mepXref.lighting = '2-3 fixtures';
    mepXref.outlets = '2-3 outlets + exhaust fan';
  } else {
    mepXref.lighting = 'Per plan';
    mepXref.outlets = 'Per plan';
  }

  // Plumbing: infer from room type
  if (room.type && room.type.toLowerCase().includes('restroom')) {
    mepXref.plumbing = 'Toilet, lavatory, grab bars';
  } else if (room.type && room.type.toLowerCase().includes('kitchen')) {
    mepXref.plumbing = 'Sink, hot water, waste';
  }

  return mepXref;
}

/**
 * inferSpecialtiesForRoom() - Infer specialties based on room type
 */
function inferSpecialtiesForRoom(room) {
  const specialties = [];
  const roomType = String(room.type || '').toLowerCase();

  if (roomType.includes('restroom')) {
    specialties.push('Grab bars (ADA compliant)');
    specialties.push('Toilet seat covers');
    specialties.push('Paper dispensers');
    specialties.push('Soap dispensers');
    specialties.push('Hand dryers');
    specialties.push('Mirrors');
    specialties.push('Signage (ADA + Braille)');
  }

  if (roomType.includes('bedroom')) {
    specialties.push('Call button or intercom');
    specialties.push('Outlet covers & safety plates');
    specialties.push('Grab bars if required');
  }

  if (roomType.includes('kitchen') || roomType.includes('common')) {
    specialties.push('Signage & wayfinding');
    specialties.push('Bulletin boards if applicable');
  }

  return specialties;
}

/**
 * inferFurnitureForRoom() - Infer typical furniture based on room type
 */
function inferFurnitureForRoom(room) {
  const furniture = [];
  const roomType = String(room.type || '').toLowerCase();

  if (roomType.includes('bedroom')) {
    furniture.push('Hospital/residential bed with rails');
    furniture.push('Nightstand');
    furniture.push('Dresser or storage unit');
    furniture.push('Visitor chair');
    furniture.push('Recessed closet');
  } else if (roomType.includes('restroom')) {
    furniture.push('Toilet');
    furniture.push('Lavatory sink');
    furniture.push('Grab bars');
  } else if (roomType.includes('common')) {
    furniture.push('Seating (chairs, sofas)');
    furniture.push('Coffee table');
    furniture.push('TV stand or media console');
    furniture.push('Shelving or bookcases');
  } else if (roomType.includes('kitchen')) {
    furniture.push('Counters & cabinetry');
    furniture.push('Stove/cooktop');
    furniture.push('Refrigerator');
    furniture.push('Dining table & chairs');
  }

  return furniture;
}

/**
 * inferCSISectionsForRoom() - Infer relevant CSI divisions
 */
function inferCSISectionsForRoom(room) {
  const sections = [];
  const roomType = String(room.type || '').toLowerCase();

  // Base sections (always applicable)
  sections.push('01 00 00 General Requirements');
  sections.push('03 30 00 Cast-in-Place Concrete');
  sections.push('05 12 00 Structural Steel Framing');

  // Framing & drywall
  sections.push('06 10 00 Rough Carpentry');
  sections.push('09 21 00 Gypsum Board');

  // Finishes
  sections.push('09 30 00 Tiling');
  sections.push('09 65 00 Resilient Flooring');
  sections.push('09 90 00 Painting and Coatings');

  // Doors & windows
  sections.push('08 11 00 Metal Doors and Frames');
  sections.push('08 14 00 Wood Doors');

  // Room-specific
  if (roomType.includes('restroom')) {
    sections.push('10 28 00 Toilet Accessories');
    sections.push('10 17 00 Urinal Screens');
  }

  if (roomType.includes('kitchen')) {
    sections.push('11 41 00 Residential Kitchen Appliances');
    sections.push('12 36 00 Countertops');
  }

  // Plumbing & MEP (if not mechanical room)
  if (!roomType.includes('mechanical')) {
    sections.push('15 00 00 Mechanical');
    sections.push('16 00 00 Electrical');
  }

  return sections;
}

/**
 * getCategoryLabel() - Human-readable category name
 */
function getCategoryLabel(category) {
  const labels = {
    'resident_rooms': 'Bedroom',
    'common_areas': 'Common Area',
    'support_spaces': 'Support Space',
    'restrooms': 'Restroom',
    'entries_corridors': 'Corridor'
  };
  return labels[category] || category;
}

/**
 * getRoomTypeClass() - CSS class for room type color
 */
function getRoomTypeClass(type) {
  if (!type) return 'room-rect-corridor';
  type = String(type).toLowerCase();
  if (type.includes('bedroom')) return 'room-rect-bedroom';
  if (type.includes('common')) return 'room-rect-common';
  if (type.includes('support')) return 'room-rect-support';
  if (type.includes('restroom')) return 'room-rect-restroom';
  if (type.includes('corridor') || type.includes('entry')) return 'room-rect-corridor';
  return 'room-rect-corridor';
}

// ============================================================================
// 4. RENDER DOORS
// ============================================================================
/**
 * renderDoors() - Three-tabbed section: Schedule, Hardware, Frames
 * With financial header (PO value, submittal status)
 */
function renderDoors() {
  const container = $('section-doors');
  if (!container) return;

  const doorData = safeGet(PROJECT_DATA, 'spatial.door_schedule');
  if (!doorData) {
    container.innerHTML = emptyState('üö™', 'No Door Data', 'Door schedule not available.');
    return;
  }

  // Financial header
  const financialEl = $('doors-financial-header');
  if (financialEl) {
    const supplier = safeGet(doorData, 'supplier', '‚Äî');
    const po = safeGet(doorData, 'po_number', '‚Äî');
    const value = safeGet(doorData, 'po_value', 0);

    let financialHtml = '';
    financialHtml += cardHTML('Supplier', esc(supplier), 'Door & frame supplier', 'üè¢');
    financialHtml += cardHTML('PO Number', esc(po), 'Purchase order reference', 'üìÑ');
    financialHtml += cardHTML('PO Value', formatCurrency(value), 'Total contract value', 'üí∞');

    // Check submittal status
    const submittals = safeGet(PROJECT_DATA, 'submittals', []);
    const doorSubmittals = submittals.filter(s => String(s.item || '').toLowerCase().includes('door'));
    if (doorSubmittals.length > 0) {
      const doorSub = doorSubmittals[0];
      financialHtml += cardHTML('Submittal Status', statusBadge(safeGet(doorSub, 'status')), 'Latest door submittal', '‚úì');
    }

    financialEl.innerHTML = financialHtml;
  }

  // Initialize tabs
  setTimeout(() => initTabs('sec-doors'), 100);

  // Door Schedule tab
  populateDoorScheduleTab(doorData);

  // Hardware Schedule tab (if specs data available)
  populateHardwareTab(doorData);

  // Frame Schedule tab (if frame data available)
  populateFrameTab(doorData);
}

/**
 * populateDoorScheduleTab() - Populate door schedule tab
 */
function populateDoorScheduleTab(doorData) {
  const typeGroups = safeGet(doorData, 'door_types', {});
  const exterior = safeGet(typeGroups, 'exterior', []);
  const interior = safeGet(typeGroups, 'interior', []);

  const allDoors = [];
  if (Array.isArray(exterior)) exterior.forEach(d => allDoors.push({ ...d, group: 'Exterior' }));
  if (Array.isArray(interior)) interior.forEach(d => allDoors.push({ ...d, group: 'Interior' }));

  const summaryTbody = document.querySelector('#door-schedule-tab tbody');
  if (summaryTbody) {
    const rows = allDoors.map(d => ({
      mark: esc(d.type || '‚Äî'),
      type: esc(d.description || '‚Äî'),
      size: esc(d.size || '‚Äî'),
      rating: esc(d.fire_rating || '‚Äî'),
      qty: formatNumber(d.quantity || 0),
      status: 'Spec'
    }));

    tableRows(summaryTbody, rows, ['mark', 'type', 'size', 'rating', 'qty', 'status']);
  }

  // Summary cards
  const totalDoors = allDoors.reduce((sum, d) => sum + (d.quantity || 0), 0);
  const extCount = (Array.isArray(exterior) ? exterior : []).reduce((sum, d) => sum + (d.quantity || 0), 0);
  const intCount = (Array.isArray(interior) ? interior : []).reduce((sum, d) => sum + (d.quantity || 0), 0);

  // Add summary stats (if container available)
  const summaryContainer = document.querySelector('#door-schedule-tab .summary-stats');
  if (summaryContainer) {
    let summaryHtml = '';
    summaryHtml += cardHTML('Total Doors', formatNumber(totalDoors), 'All openings', 'üö™');
    summaryHtml += cardHTML('Exterior', formatNumber(extCount), 'Exterior doors', 'üî¥');
    summaryHtml += cardHTML('Interior', formatNumber(intCount), 'Interior doors', 'üîµ');
    summaryContainer.innerHTML = summaryHtml;
  }
}

/**
 * populateHardwareTab() - Populate hardware schedule (grouped by door type)
 */
function populateHardwareTab(doorData) {
  const typeGroups = safeGet(doorData, 'door_types', {});
  const exterior = safeGet(typeGroups, 'exterior', []);
  const interior = safeGet(typeGroups, 'interior', []);

  const allDoors = [];
  if (Array.isArray(exterior)) exterior.forEach(d => allDoors.push({ ...d, group: 'Exterior' }));
  if (Array.isArray(interior)) interior.forEach(d => allDoors.push({ ...d, group: 'Interior' }));

  const hardwareContainer = document.querySelector('#hardware-schedule-tab');
  if (hardwareContainer) {
    if (allDoors.length === 0) {
      hardwareContainer.innerHTML = emptyState('üîß', 'No Hardware Data', 'Door hardware schedule not yet defined.');
      return;
    }

    let html = '<div class="hardware-cards">';

    allDoors.forEach(door => {
      html += `<div class="hardware-card" data-door-type="${esc(door.type)}">`;
      html += `<h4>Type ${esc(door.type)} Hardware ‚Äî ${esc(door.description || '')}</h4>`;
      html += '<dl>';
      html += `<dt>Lockset:</dt><dd>${door.group === 'Exterior' ? 'Exterior grade, weather-resistant' : 'Interior passage or privacy'}</dd>`;
      html += `<dt>Closer:</dt><dd>ADA compliant door closer, adjustable force</dd>`;
      html += `<dt>Hinges:</dt><dd>${door.group === 'Exterior' ? 'Stainless steel, 316' : 'Standard steel, ball bearing'}</dd>`;
      html += `<dt>Threshold:</dt><dd>${door.group === 'Exterior' ? 'ADA accessible beveled' : 'Aluminum or none'}</dd>`;
      html += `<dt>Weatherstrip:</dt><dd>${door.group === 'Exterior' ? 'EPDM gasket seal' : 'Not applicable'}</dd>`;
      html += `<dt>Kick Plate:</dt><dd>${door.group === 'Exterior' ? 'Stainless steel, 10" height' : 'Standard or stainless'}</dd>`;
      html += '</dl>';
      html += '</div>';
    });

    html += '</div>';
    hardwareContainer.innerHTML = html;
  }
}

/**
 * populateFrameTab() - Populate frame schedule
 */
function populateFrameTab(doorData) {
  const frameContainer = document.querySelector('#frame-schedule-tab tbody');
  if (frameContainer) {
    // Frame types from door types
    const typeGroups = safeGet(doorData, 'door_types', {});
    const exterior = safeGet(typeGroups, 'exterior', []);
    const interior = safeGet(typeGroups, 'interior', []);

    const allDoors = [];
    if (Array.isArray(exterior)) exterior.forEach(d => allDoors.push({ ...d, group: 'Exterior' }));
    if (Array.isArray(interior)) interior.forEach(d => allDoors.push({ ...d, group: 'Interior' }));

    if (allDoors.length === 0) {
      frameContainer.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2em;">No frame data</td></tr>';
      return;
    }

    const rows = allDoors.map(d => ({
      type: 'HM Type ' + esc(d.type),
      size: esc(d.size || '3\'x7\' (typical)'),
      rating: d.group === 'Exterior' ? '20-min fire' : '20-min fire',
      material: 'Hollow Metal (16 ga)',
      qty: formatNumber(d.quantity || 0)
    }));

    tableRows(frameContainer, rows, ['type', 'size', 'rating', 'material', 'qty']);
  }
}

// ============================================================================
// 5. RENDER PEMB
// ============================================================================
/**
 * renderPEMB() - PEMB structure: envelope, reactions, foundation, SOG, interior framing
 */
function renderPEMB() {
  const container = $('section-pemb');
  if (!container) return;

  const pembData = safeGet(PROJECT_DATA, 'spatial.pemb_envelope');
  const structData = safeGet(PROJECT_DATA, 'spatial.structural_systems', {});

  if (!pembData) {
    container.innerHTML = emptyState('üèóÔ∏è', 'No PEMB Data', 'PEMB envelope specifications not available.');
    return;
  }

  // Summary cards
  const cardsEl = $('pemb-cards');
  if (cardsEl) {
    const width = safeGet(pembData, 'width');
    const length = safeGet(pembData, 'length');
    const eave = safeGet(pembData, 'eave_height');
    const frames = safeGet(pembData, 'number_of_frames');
    const wind = safeGet(pembData, 'design_loads.wind_speed_ultimate');

    let cardsHtml = '';
    cardsHtml += cardHTML('Width √ó Length', esc(width) + ' √ó ' + esc(length), 'Building envelope', 'üì¶');
    cardsHtml += cardHTML('Eave Height', esc(eave), 'Vertical clearance', 'üìè');
    cardsHtml += cardHTML('Frames', formatNumber(frames), 'Clear span rigid frames', 'üîó');
    cardsHtml += cardHTML('Design Wind', esc(wind) + ' (Ult.)', 'Ultimate wind speed', 'üí®');

    cardsEl.innerHTML = cardsHtml;
  }

  // PEMB Envelope kv-grid
  const envelopeEl = $('pemb-envelope');
  if (envelopeEl) {
    const designLoads = safeGet(pembData, 'design_loads', {});

    const envelopePairs = [
      ['Manufacturer', esc(safeGet(pembData, 'manufacturer'))],
      ['Project #', esc(safeGet(pembData, 'project_number'))],
      ['Width', esc(safeGet(pembData, 'width'))],
      ['Length', esc(safeGet(pembData, 'length'))],
      ['Eave Height', esc(safeGet(pembData, 'eave_height'))],
      ['Roof Slope', esc(safeGet(pembData, 'roof_slope'))],
      ['Frame Type', esc(safeGet(pembData, 'frame_type'))],
      ['Number of Frames', formatNumber(safeGet(pembData, 'number_of_frames'))],
      ['Bay Spacing', esc(safeGet(pembData, 'bay_spacing'))],
      ['Wind Speed (ASD)', esc(safeGet(designLoads, 'wind_speed_asd'))],
      ['Wind Speed (Ultimate)', esc(safeGet(designLoads, 'wind_speed_ultimate'))],
      ['Wind Exposure Category', esc(safeGet(designLoads, 'wind_exposure'))],
      ['Snow Load', esc(safeGet(designLoads, 'snow_load_ground'))],
      ['Seismic Design Category', esc(safeGet(designLoads, 'seismic_design_category'))],
      ['Risk Category', esc(safeGet(designLoads, 'risk_category'))]
    ];

    envelopeEl.innerHTML = kvGrid(envelopePairs);
  }

  // Column Reactions table (FIXED: handle both object and array formats)
  const reactionsEl = document.querySelector('#pemb-reactions tbody');
  if (reactionsEl) {
    const reactions = safeGet(pembData, 'column_reactions', {});
    let reactionRows = [];

    // Handle object format: {grid_1_left: {vertical_max_kips, ...}}
    if (typeof reactions === 'object' && !Array.isArray(reactions)) {
      Object.entries(reactions).forEach(([gridKey, reaction]) => {
        if (reaction && typeof reaction === 'object') {
          reactionRows.push({
            grid_location: esc(gridKey.replace(/_/g, ' ')),
            vertical_kips: formatNumber(safeGet(reaction, 'vertical_max_kips')) || '‚Äî',
            horizontal_kips: formatNumber(safeGet(reaction, 'horizontal_max_kips')) || '‚Äî',
            bolt_type: esc(safeGet(reaction, 'anchor_bolts')) || '‚Äî',
            qty: '‚Äî'
          });
        }
      });
    }
    // Handle array format: [{grid_location, vertical_kips, ...}]
    else if (Array.isArray(reactions)) {
      reactionRows = reactions.map(r => ({
        grid_location: esc(r.grid_location || '‚Äî'),
        vertical_kips: formatNumber(r.vertical_kips) || '‚Äî',
        horizontal_kips: formatNumber(r.horizontal_kips) || '‚Äî',
        bolt_type: esc(r.anchor_bolts) || '‚Äî',
        qty: '‚Äî'
      }));
    }

    tableRows(reactionsEl, reactionRows, ['grid_location', 'vertical_kips', 'horizontal_kips', 'bolt_type', 'qty']);
  }

  // Foundation kv-grid
  const foundationEl = $('pemb-foundation');
  if (foundationEl) {
    const foundation = safeGet(structData, 'foundation', {});

    const foundationPairs = [
      ['Foundation Type', esc(safeGet(foundation, 'type'))],
      ['Footing Concrete', esc(safeGet(foundation, 'concrete_strength_footings'))],
      ['Bearing Capacity', '2000 PSF'],
      ['Frost Depth', esc(safeGet(foundation, 'frost_depth'))],
      ['Reinforcement', esc(safeGet(foundation, 'rebar', 'ASTM A615 Grade 60'))]
    ];

    foundationEl.innerHTML = kvGrid(foundationPairs);
  }

  // Footing Schedule table (if available)
  const footingSchedule = safeGet(structData, 'foundation.footing_schedule');
  if (footingSchedule && Object.keys(footingSchedule).length > 0) {
    const footingContainer = document.querySelector('#pemb-footing-schedule tbody');
    if (footingContainer) {
      const footingRows = Object.entries(footingSchedule).map(([key, footing]) => ({
        footing_type: esc(key),
        size: esc(safeGet(footing, 'size') || '‚Äî'),
        rebar: esc(safeGet(footing, 'rebar') || '‚Äî'),
        bearing_psf: formatNumber(safeGet(footing, 'bearing') || '‚Äî')
      }));

      tableRows(footingContainer, footingRows, ['footing_type', 'size', 'rebar', 'bearing_psf']);
    }
  }

  // SOG kv-grid
  const sogEl = $('pemb-sog');
  if (sogEl) {
    const sog = safeGet(structData, 'slab_on_grade', {});

    const sogPairs = [
      ['Thickness', esc(safeGet(sog, 'thickness'))],
      ['Interior Strength', esc(safeGet(sog, 'concrete_strength'))],
      ['Exterior Strength', esc(safeGet(sog, 'exterior_strength', '4500 PSI'))],
      ['Reinforcement', esc(safeGet(sog, 'reinforcement'))],
      ['Vapor Barrier', esc(safeGet(sog, 'vapor_barrier'))],
      ['Control Joints', esc(safeGet(sog, 'joints'))]
    ];

    sogEl.innerHTML = kvGrid(sogPairs);
  }

  // Interior Framing kv-grid (CFS)
  const framingEl = $('pemb-interior-framing');
  if (framingEl) {
    const framing = safeGet(structData, 'interior_framing', {});

    const framingPairs = [
      ['Type', esc(safeGet(framing, 'type', 'Cold-Formed Steel (CFS)'))],
      ['Stud Sizes', esc(safeGet(framing, 'studs'))],
      ['Stud Gauge', esc(safeGet(framing, 'gauge', '20 GA minimum'))],
      ['Spacing', esc(safeGet(framing, 'spacing'))],
      ['Headers', esc(safeGet(framing, 'headers') || 'Structural per plan')],
      ['Ceiling Framing', esc(safeGet(framing, 'ceiling_framing') || 'Suspended grid')]
    ];

    framingEl.innerHTML = kvGrid(framingPairs);
  }
}

// ============================================================================
// 6. RENDER MEP
// ============================================================================
/**
 * renderMEP() - Three-tabbed MEP section: Mechanical, Electrical, Plumbing
 */
function renderMEP() {
  const container = $('section-mep');
  if (!container) return;

  const mepData = safeGet(PROJECT_DATA, 'spatial.mep_equipment');
  if (!mepData) {
    container.innerHTML = emptyState('‚öôÔ∏è', 'No MEP Data', 'MEP equipment specifications not available.');
    return;
  }

  // Initialize tabs
  setTimeout(() => initTabs('sec-mep'), 100);

  // Mechanical Tab
  const mechanicalData = safeGet(mepData, 'mechanical', {});
  populateMechanicalTab(mechanicalData, mepData);

  // Electrical Tab
  const electricalData = safeGet(mepData, 'electrical', {});
  populateElectricalTab(electricalData);

  // Plumbing Tab
  const plumbingData = safeGet(mepData, 'plumbing', {});
  populatePlumbingTab(plumbingData);
}

/**
 * populateMechanicalTab() - HVAC, ductwork, controls
 */
function populateMechanicalTab(mechanicalData, mepData) {
  // HVAC Equipment table
  const hvacTbody = document.querySelector('#mep-mechanical-tab tbody');
  const hvacUnits = safeGet(mechanicalData, 'hvac_units', []) || safeGet(mepData, 'hvac_units', []);
  if (hvacTbody && Array.isArray(hvacUnits) && hvacUnits.length > 0) {
    const rows = hvacUnits.map(unit => ({
      equipment_id: esc(unit.tag || unit.id || '‚Äî'),
      type: esc(unit.type || '‚Äî'),
      model: esc(unit.model || unit.manufacturer || '‚Äî'),
      capacity: esc(unit.capacity || '‚Äî'),
      location: esc(unit.location || '‚Äî')
    }));

    tableRows(hvacTbody, rows, ['equipment_id', 'type', 'model', 'capacity', 'location']);
  } else if (hvacTbody) {
    hvacTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2em;">No HVAC equipment data</td></tr>';
  }

  // Ductwork specs
  const ductworkEl = $('mep-ductwork-detail');
  if (ductworkEl) {
    const ductwork = safeGet(mechanicalData, 'ductwork') || safeGet(mepData, 'ductwork');
    if (ductwork && Object.keys(ductwork).length > 0) {
      const ductPairs = [
        ['Supply Material', esc(safeGet(ductwork, 'supply', 'Galvanized sheet metal'))],
        ['Return Material', esc(safeGet(ductwork, 'return', 'Galvanized sheet metal'))],
        ['Insulation', esc(safeGet(ductwork, 'insulation', 'R-6 rigid insulation'))],
        ['Diffusers', esc(safeGet(ductwork, 'diffusers', 'Per schedule'))]
      ];
      ductworkEl.innerHTML = kvGrid(ductPairs);
    } else {
      ductworkEl.innerHTML = '<p style="font-style:italic;color:#999;">Ductwork specifications not yet documented.</p>';
    }
  }

  // Controls specs
  const controlsEl = $('mep-controls-detail');
  if (controlsEl) {
    const controlPairs = [
      ['System', 'Programmable thermostat with occupancy sensors'],
      ['Setpoints', '68-72¬∞F heating, 74-78¬∞F cooling'],
      ['Override', 'Manual override at thermostat'],
      ['Integration', 'Standalone or building automation ready']
    ];

    controlsEl.innerHTML = kvGrid(controlPairs);
  }
}

/**
 * populateElectricalTab() - Panels, lighting, low-voltage systems
 */
function populateElectricalTab(electricalData) {
  // Panel Schedule table
  const panelTbody = document.querySelector('#mep-electrical-tab tbody');
  const panels = safeGet(electricalData, 'panels', []);
  if (panelTbody && Array.isArray(panels) && panels.length > 0) {
    const rows = panels.map(panel => ({
      panel: esc(panel.tag || panel.id || '‚Äî'),
      type: esc(panel.type || 'Main / Sub'),
      voltage: esc(panel.voltage || '208V'),
      phase: esc(panel.phase || '3-phase'),
      amps: esc(panel.amps || '‚Äî'),
      location: esc(panel.location || '‚Äî')
    }));

    tableRows(panelTbody, rows, ['panel', 'type', 'voltage', 'phase', 'amps', 'location']);
  } else if (panelTbody) {
    panelTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2em;">No panel data</td></tr>';
  }

  // Lighting specs
  const lightingEl = $('mep-lighting-detail');
  if (lightingEl) {
    const lighting = safeGet(electricalData, 'lighting');
    if (lighting && Object.keys(lighting).length > 0) {
      const lightPairs = [
        ['Total Fixtures', formatNumber(safeGet(lighting, 'total_fixtures')) || '120+'],
        ['Manufacturers', esc((safeGet(lighting, 'manufacturers') || []).join(', ') || 'TBD')],
        ['Types', esc((safeGet(lighting, 'types') || []).slice(0, 3).join(', ') || 'LED recessed, panels, strips')],
        ['Control', 'Occupancy sensors & manual switches'],
        ['Dimming', 'Per occupancy and daylight availability']
      ];
      lightingEl.innerHTML = kvGrid(lightPairs);
    } else {
      lightingEl.innerHTML = '<p style="font-style:italic;color:#999;">Lighting schedule not yet documented.</p>';
    }
  }

  // Low-voltage systems
  const lowVoltEl = $('mep-lowvoltage-detail');
  if (lowVoltEl) {
    const lv = safeGet(electricalData, 'low_voltage', {});
    const lvPairs = [
      ['Fire Alarm', esc(safeGet(lv, 'fire_alarm', 'Addressable system'))],
      ['Nurse Call', esc(safeGet(lv, 'nurse_call', 'Wireless or hard-wired'))],
      ['Access Control', esc(safeGet(lv, 'access_control', 'Card readers on exterior doors'))],
      ['Data/Telecom', esc(safeGet(lv, 'data', 'Cat6 to all rooms'))]
    ];

    lowVoltEl.innerHTML = kvGrid(lvPairs);
  }
}

/**
 * populatePlumbingTab() - Fixtures, water systems
 */
function populatePlumbingTab(plumbingData) {
  // Fixture Schedule table
  const fixtureTbody = document.querySelector('#mep-plumbing-tab tbody');
  const fixtureTypes = safeGet(plumbingData, 'fixture_types', []);
  if (fixtureTbody && Array.isArray(fixtureTypes) && fixtureTypes.length > 0) {
    const rows = fixtureTypes.map((type, idx) => ({
      fixture_type: esc(type),
      qty: idx === 0 ? formatNumber(safeGet(plumbingData, 'total_fixtures') || 35) : '‚Äî',
      model: esc(safeGet(plumbingData, 'fixture_models.' + type) || 'TBD'),
      rough_in: 'Per code',
      locations: 'Per schedule'
    }));

    tableRows(fixtureTbody, rows, ['fixture_type', 'qty', 'model', 'rough_in', 'locations']);
  } else if (fixtureTbody) {
    fixtureTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2em;">No fixture data</td></tr>';
  }

  // Water systems specs
  const waterEl = $('mep-water-detail');
  if (waterEl) {
    const wh = safeGet(plumbingData, 'water_heater', {});
    if (wh && Object.keys(wh).length > 0) {
      const waterPairs = [
        ['Water Heater Tag', esc(safeGet(wh, 'tag', 'GWH-1'))],
        ['Type', esc(safeGet(wh, 'type', 'Gas tankless'))],
        ['Capacity', esc(safeGet(wh, 'capacity', '50 gal'))],
        ['Manufacturer', esc(safeGet(wh, 'manufacturer', 'Lochinvar'))],
        ['Location', esc(safeGet(wh, 'location', 'Mechanical room'))],
        ['Supply Material', 'Type L copper'],
        ['DWV Material', 'PVC Schedule 40'],
        ['Rough-in Coordination', 'Per plumbing plans']
      ];

      waterEl.innerHTML = kvGrid(waterPairs);
    } else {
      waterEl.innerHTML = '<p style="font-style:italic;color:#999;">Water system specifications not yet documented.</p>';
    }
  }
}

// ============================================================================
// 7. RENDER SITE
// ============================================================================
/**
 * renderSite() - Site layout, utilities, grading
 */
function renderSite() {
  const container = $('section-site');
  if (!container) return;

  const siteLayout = safeGet(PROJECT_DATA, 'spatial.site_layout');
  const siteUtils = safeGet(PROJECT_DATA, 'spatial.site_utilities');

  if (!siteLayout && !siteUtils) {
    container.innerHTML = emptyState('üåç', 'No Site Data', 'Site information not available.');
    return;
  }

  // Summary cards
  const cardsEl = $('site-cards');
  if (cardsEl && siteLayout) {
    const parking = safeGet(siteLayout, 'parking', {});

    let cardsHtml = '';
    cardsHtml += cardHTML('Parking Spaces', formatNumber(safeGet(parking, 'total_spaces') || 35), 'Total accessible spaces', 'üÖøÔ∏è');
    cardsHtml += cardHTML('ADA Spaces', formatNumber(safeGet(parking, 'ada_spaces') || 2), 'ADA accessible count', '‚ôø');
    cardsHtml += cardHTML('Pavement', '7" total thickness', 'Wearing + binder + base', 'üõ£Ô∏è');
    cardsHtml += cardHTML('Parking Slope', '2% min', 'Drainage slope', '‚ÜóÔ∏è');

    cardsEl.innerHTML = cardsHtml;
  }

  // Site Layout kv-grid
  const layoutEl = $('site-layout');
  if (layoutEl && siteLayout) {
    const parking = safeGet(siteLayout, 'parking', {});
    const paving = safeGet(siteLayout, 'paving', {});
    const grading = safeGet(siteLayout, 'site_grading', {});

    const layoutPairs = [
      ['Parking Spaces', formatNumber(safeGet(parking, 'total_spaces'))],
      ['ADA Parking', formatNumber(safeGet(parking, 'ada_spaces'))],
      ['Surface Material', esc(safeGet(parking, 'surface', 'Asphalt concrete'))],
      ['Pavement Wearing', esc(safeGet(paving, 'wearing_course', '1.5"'))],
      ['Pavement Base', esc(safeGet(paving, 'base', '3.5"'))],
      ['Total Thickness', esc(safeGet(paving, 'total_thickness', '7"'))],
      ['Site FFE', esc(safeGet(grading, 'ffe', 'Per survey'))],
      ['Parking Slope', esc(safeGet(grading, 'parking_slope', '2% min'))],
      ['ADA Route Grade', esc(safeGet(grading, 'ada_route', '1:20 max'))]
    ];

    layoutEl.innerHTML = kvGrid(layoutPairs);
  }

  // Utilities table
  const utilitiesTbody = document.querySelector('#site-utilities tbody');
  if (utilitiesTbody && siteUtils) {
    const rows = [];

    // Storm drainage
    const storm = safeGet(siteUtils, 'storm_drainage', {});
    if (Object.keys(storm).length > 0) {
      rows.push({
        utility: 'Storm Drainage',
        type: esc(safeGet(storm, 'system', 'Underground detention')),
        location: esc(safeGet(storm, 'outfall') || 'Off-site'),
        size_capacity: esc(safeGet(storm, 'capacity', 'TBD')),
        status: 'Designed'
      });
    }

    // Sanitary sewer
    const sanitary = safeGet(siteUtils, 'sanitary_sewer', {});
    if (Object.keys(sanitary).length > 0) {
      rows.push({
        utility: 'Sanitary Sewer',
        type: esc(safeGet(sanitary, 'building_connection', 'Building connection')),
        location: esc(safeGet(sanitary, 'connection_point') || 'Property line'),
        size_capacity: esc(safeGet(sanitary, 'size', '8" PVC SDR 35')),
        status: 'Designed'
      });
    }

    // Water service
    const water = safeGet(siteUtils, 'water_service', {});
    if (Object.keys(water).length > 0) {
      rows.push({
        utility: 'Water Service',
        type: esc(safeGet(water, 'domestic', 'Domestic')),
        location: 'Building connection',
        size_capacity: esc(safeGet(water, 'size', '2" copper')),
        status: 'Designed'
      });
    }

    // Electrical
    const electrical = safeGet(siteUtils, 'electrical_service', {});
    if (Object.keys(electrical).length > 0) {
      rows.push({
        utility: 'Electrical Service',
        type: esc(safeGet(electrical, 'voltage', '208/120V 3-phase')),
        location: 'Pad mount transformer',
        size_capacity: esc(safeGet(electrical, 'service_size', '400A')),
        status: 'Designed'
      });
    }

    if (rows.length > 0) {
      tableRows(utilitiesTbody, rows, ['utility', 'type', 'location', 'size_capacity', 'status']);
    } else {
      utilitiesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2em;">No utility data</td></tr>';
    }
  }

  // Grading detail
  const gradingEl = $('site-grading');
  if (gradingEl && siteLayout) {
    const grading = safeGet(siteLayout, 'site_grading', {});
    const paving = safeGet(siteLayout, 'paving', {});

    const gradingPairs = [
      ['Finished Floor Elev.', esc(safeGet(grading, 'ffe', 'Per survey'))],
      ['Parking Slope', esc(safeGet(grading, 'parking_slope', '2% min'))],
      ['ADA Slope Max', esc(safeGet(grading, 'ada_route', '1:20'))],
      ['Subgrade Prep', esc(safeGet(paving, 'subgrade_prep', 'Per geotech compaction testing'))],
      ['Stormwater Management', esc(safeGet(grading, 'stormwater', 'Per SWPPP'))]
    ];

    gradingEl.innerHTML = kvGrid(gradingPairs);
  }
}

// ============================================================================
// END OF PART 3B
// ============================================================================
// All rendering functions are now defined and ready to be called by
// renderSectionIfNeeded() in Part 3A.
//
// Key functions exported:
// - renderGridLines()
// - renderAreas()
// - renderRooms()
// - renderDoors()
// - renderPEMB()
// - renderMEP()
// - renderSite()
//
// Plus helper functions for:
// - Room detail panel with finishes, doors, MEP, specs, furniture
// - SVG visualizations for grid and room floor plans
// - Cross-referencing between sections

// ===========================
// PART 3C: QUANTITIES & SPECS
// ===========================
// Production-quality renderer functions for:
// Takeoff, Materials, Bidding, Calculator, Specs, Mix Designs, Tolerances, Weather, Hold Points
// These populate HTML sections from Part 2 using PROJECT_DATA
// All helper functions imported from Part 3A (esc, cardHTML, kvGrid, kvRow, tableRows, emptyState, etc.)

// ============================================================================
// 1. RENDER TAKEOFF
// ============================================================================
/**
 * renderTakeoff() - Material takeoff by CSI division
 * Pull from PROJECT_DATA.spatial.quantities
 * Shows: Division cards (collapsible), item counts, key quantities, source attribution
 * Master summary table: Item, Quantity, Unit, Division, Source, Confidence
 */
function renderTakeoff() {
  const container = $('section-takeoff');
  if (!container) return;

  const quantities = safeGet(PROJECT_DATA, 'spatial.quantities', {});
  const roomSchedule = safeGet(PROJECT_DATA, 'spatial.room_schedule', []);
  const doorSchedule = safeGet(PROJECT_DATA, 'spatial.door_schedule', []);
  const mepEquipment = safeGet(PROJECT_DATA, 'spatial.mep_equipment', {});

  // CSI Division data structure with dynamic population
  const divisions = {
    '03': {
      name: 'Concrete',
      items: [
        { code: '03.1', name: 'Footing Concrete', qty: safeGet(quantities, 'footing_cy'), unit: 'CY', source: 'Structural' },
        { code: '03.2', name: 'SOG Concrete', qty: safeGet(quantities, 'sog_cy'), unit: 'CY', source: 'Structural' },
        { code: '03.3', name: 'Wall Concrete', qty: safeGet(quantities, 'wall_cy'), unit: 'CY', source: 'Structural' },
        { code: '03.4', name: 'Rebar Steel', qty: safeGet(quantities, 'rebar_tons'), unit: 'Tons', source: 'Structural' },
        { code: '03.5', name: 'Concrete Forms', qty: safeGet(quantities, 'form_sf'), unit: 'SF', source: 'Structural' }
      ]
    },
    '05': {
      name: 'Metals',
      items: [
        { code: '05.1', name: 'PEMB Package', qty: safeGet(PROJECT_DATA, 'spatial.pemb_envelope.area_sf'), unit: 'SF', source: 'PEMB' },
        { code: '05.2', name: 'Anchor Bolts', qty: safeGet(quantities, 'anchor_bolts_count'), unit: 'Each', source: 'Structural' },
        { code: '05.3', name: 'Misc Metal Framing', qty: safeGet(quantities, 'misc_metal_lbs'), unit: 'Lbs', source: 'Structural' }
      ]
    },
    '07': {
      name: 'Thermal & Moisture',
      items: [
        { code: '07.1', name: 'Roof Panels', qty: safeGet(PROJECT_DATA, 'spatial.pemb_envelope.roof_area_sf'), unit: 'SF', source: 'PEMB' },
        { code: '07.2', name: 'Wall Panels', qty: safeGet(PROJECT_DATA, 'spatial.pemb_envelope.wall_area_sf'), unit: 'SF', source: 'PEMB' },
        { code: '07.3', name: 'Insulation', qty: safeGet(quantities, 'insulation_sf'), unit: 'SF', source: 'MEP' },
        { code: '07.4', name: 'Vapor Barrier', qty: safeGet(quantities, 'vapor_barrier_sf'), unit: 'SF', source: 'Structural' }
      ]
    },
    '08': {
      name: 'Openings',
      items: [
        { code: '08.1', name: 'HM Doors', qty: safeGet(quantities, 'doors_hm_count'), unit: 'Each', source: 'Door Schedule' },
        { code: '08.2', name: 'Wood Doors', qty: safeGet(quantities, 'doors_wood_count'), unit: 'Each', source: 'Door Schedule' },
        { code: '08.3', name: 'Glazing', qty: safeGet(quantities, 'glazing_sf'), unit: 'SF', source: 'Door Schedule' },
        { code: '08.4', name: 'Hardware Sets', qty: arrLen(doorSchedule), unit: 'Sets', source: 'Door Schedule' }
      ]
    },
    '09': {
      name: 'Finishes',
      items: [
        { code: '09.1', name: 'Flooring - LVP', qty: safeGet(quantities, 'flooring_lvp_sf'), unit: 'SF', source: 'Finishes' },
        { code: '09.2', name: 'Flooring - Tile', qty: safeGet(quantities, 'flooring_tile_sf'), unit: 'SF', source: 'Finishes' },
        { code: '09.3', name: 'Drywall', qty: safeGet(quantities, 'drywall_sf'), unit: 'SF', source: 'Finishes' },
        { code: '09.4', name: 'Ceiling Tile', qty: safeGet(quantities, 'ceiling_sf'), unit: 'SF', source: 'Finishes' },
        { code: '09.5', name: 'Paint', qty: safeGet(quantities, 'paint_sf'), unit: 'SF', source: 'Finishes' },
        { code: '09.6', name: 'Base/Trim', qty: safeGet(quantities, 'base_lf'), unit: 'LF', source: 'Finishes' }
      ]
    },
    '22': {
      name: 'Plumbing',
      items: [
        { code: '22.1', name: 'Water Heater', qty: 1, unit: 'Each', source: 'MEP Equipment' },
        { code: '22.2', name: 'Fixtures', qty: safeGet(quantities, 'plumbing_fixtures_count'), unit: 'Each', source: 'MEP Equipment' },
        { code: '22.3', name: 'Piping - Copper', qty: safeGet(quantities, 'copper_pipe_lf'), unit: 'LF', source: 'MEP Drawings' },
        { code: '22.4', name: 'Piping - PVC DWV', qty: safeGet(quantities, 'pvc_pipe_lf'), unit: 'LF', source: 'MEP Drawings' }
      ]
    },
    '23': {
      name: 'HVAC',
      items: [
        { code: '23.1', name: 'Air Handler Units', qty: safeGet(quantities, 'ahu_count'), unit: 'Each', source: 'MEP Equipment' },
        { code: '23.2', name: 'AC Units', qty: safeGet(quantities, 'ac_units_count'), unit: 'Each', source: 'MEP Equipment' },
        { code: '23.3', name: 'Exhaust Fans', qty: safeGet(quantities, 'exhaust_fans_count'), unit: 'Each', source: 'MEP Equipment' },
        { code: '23.4', name: 'Ductwork', qty: safeGet(quantities, 'ductwork_lf'), unit: 'LF', source: 'MEP Drawings' },
        { code: '23.5', name: 'Diffusers & Registers', qty: safeGet(quantities, 'diffusers_count'), unit: 'Each', source: 'MEP Drawings' }
      ]
    },
    '26': {
      name: 'Electrical',
      items: [
        { code: '26.1', name: 'Panels', qty: safeGet(quantities, 'electrical_panels_count'), unit: 'Each', source: 'Electrical' },
        { code: '26.2', name: 'Outlets', qty: safeGet(quantities, 'outlets_count'), unit: 'Each', source: 'Electrical' },
        { code: '26.3', name: 'Switches', qty: safeGet(quantities, 'switches_count'), unit: 'Each', source: 'Electrical' },
        { code: '26.4', name: 'Light Fixtures', qty: safeGet(quantities, 'light_fixtures_count'), unit: 'Each', source: 'Electrical' },
        { code: '26.5', name: 'Fire Alarm', qty: 1, unit: 'System', source: 'Electrical' },
        { code: '26.6', name: 'Emergency Lighting', qty: safeGet(quantities, 'emergency_lights_count'), unit: 'Each', source: 'Electrical' }
      ]
    },
    '31': {
      name: 'Earthwork',
      items: [
        { code: '31.1', name: 'Excavation', qty: safeGet(quantities, 'excavation_cy'), unit: 'CY', source: 'Civil' },
        { code: '31.2', name: 'Fill & Compaction', qty: safeGet(quantities, 'fill_cy'), unit: 'CY', source: 'Civil' },
        { code: '31.3', name: 'Subgrade Prep', qty: safeGet(PROJECT_DATA, 'spatial.building_areas.total_building_sf'), unit: 'SF', source: 'Civil' },
        { code: '31.4', name: 'Topsoil & Seeding', qty: safeGet(quantities, 'landscape_sf'), unit: 'SF', source: 'Civil' }
      ]
    },
    '32': {
      name: 'Exterior Improvements',
      items: [
        { code: '32.1', name: 'Asphalt Paving', qty: safeGet(quantities, 'paving_sf'), unit: 'SF', source: 'Civil' },
        { code: '32.2', name: 'Concrete Walks', qty: safeGet(quantities, 'sidewalk_sf'), unit: 'SF', source: 'Civil' },
        { code: '32.3', name: 'Site Drainage', qty: safeGet(quantities, 'drainage_lf'), unit: 'LF', source: 'Civil' }
      ]
    }
  };

  let html = '<div class="takeoff-container">';
  html += '<h2>Material Takeoff by CSI Division</h2>';

  // Collapsible division cards
  Object.entries(divisions).forEach(([divCode, divData]) => {
    const itemCount = divData.items.filter(i => i.qty).length;
    if (itemCount === 0) return; // Skip empty divisions

    const divId = `div-${divCode}`;
    html += `<div class="takeoff-card" id="${divId}">
      <div class="card-header clickable" onclick="toggleDivisionItems('${divId}')">
        <span class="card-title">${divCode} ‚Äî ${esc(divData.name)}</span>
        <span class="card-count">${itemCount} item${itemCount !== 1 ? 's' : ''}</span>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-content" style="display:none;">
        <table class="table table-compact">
          <thead>
            <tr><th>Item</th><th>Quantity</th><th>Unit</th><th>Source</th></tr>
          </thead>
          <tbody>`;

    divData.items.forEach(item => {
      if (!item.qty) return;
      html += `<tr>
        <td>${esc(item.name)}</td>
        <td>${formatNumber(item.qty)}</td>
        <td>${esc(item.unit)}</td>
        <td><small>${esc(item.source)}</small></td>
      </tr>`;
    });

    html += `</tbody></table>
      </div>
    </div>`;
  });

  // Master summary table below divisions
  html += '<h3 style="margin-top:2em;">Complete Takeoff Summary</h3>';
  html += '<table class="table"><thead><tr><th>Item</th><th>Quantity</th><th>Unit</th><th>Division</th><th>Source</th></tr></thead><tbody>';

  const allItems = [];
  Object.entries(divisions).forEach(([divCode, divData]) => {
    divData.items.forEach(item => {
      if (item.qty) {
        allItems.push({
          name: item.name,
          qty: item.qty,
          unit: item.unit,
          division: divCode + ' ‚Äî ' + divData.name,
          source: item.source
        });
      }
    });
  });

  tableRows(
    (() => {
      const tBody = document.createElement('tbody');
      allItems.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(item.name)}</td>
          <td style="text-align:right;">${formatNumber(item.qty)}</td>
          <td>${esc(item.unit)}</td>
          <td><small>${esc(item.division)}</small></td>
          <td><small>${esc(item.source)}</small></td>
        `;
        tBody.appendChild(tr);
      });
      return tBody;
    })(),
    allItems,
    ['name', 'qty', 'unit', 'division', 'source']
  );

  if (allItems.length === 0) {
    html += '<tr><td colspan="5" style="text-align:center;padding:2em;">No items quantified yet</td></tr>';
  }

  html += '</tbody></table></div>';
  container.innerHTML = html;

  // Attach toggle handler
  window.toggleDivisionItems = function(divId) {
    const div = $(divId);
    if (!div) return;
    const content = div.querySelector('.card-content');
    const icon = div.querySelector('.toggle-icon');
    if (content) {
      const isHidden = content.style.display === 'none';
      content.style.display = isHidden ? 'block' : 'none';
      if (icon) icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
    }
  };
}

// ============================================================================
// 2. RENDER MATERIALS
// ============================================================================
/**
 * renderMaterials() - Searchable material database
 * Pull from specs.materials and spatial data
 * Material cards showing: name, spec section, grade/type, testing requirements, manufacturers
 * Search filters by name or spec section
 * Categories: Concrete, Steel/Metals, Framing, Finishes, MEP, Earthwork
 */
function renderMaterials() {
  const container = $('section-materials');
  if (!container) return;

  const materials = safeGet(PROJECT_DATA, 'specs.materials', []);
  const specsData = safeGet(PROJECT_DATA, 'specs', {});

  let html = '<div class="materials-container">';
  html += '<h2>Materials & Equipment</h2>';

  // Search bar
  html += `<div class="search-bar">
    <input type="text" id="material-search" placeholder="Search materials by name or spec..." style="width:100%;padding:0.75em;border:1px solid #ccc;border-radius:4px;font-size:1em;" onkeyup="filterMaterials()">
  </div>`;

  // Category filter tabs
  const categories = ['All', 'Concrete', 'Steel/Metals', 'Framing', 'Finishes', 'MEP', 'Earthwork'];
  html += '<div class="tabs" style="margin:1em 0;">';
  categories.forEach((cat, i) => {
    const isActive = i === 0 ? ' active' : '';
    html += `<button class="tab-btn${isActive}" onclick="filterMaterialsByCategory('${cat}')">${cat}</button>`;
  });
  html += '</div>';

  // Material cards grid
  html += '<div id="materials-grid" class="materials-grid">';

  if (!Array.isArray(materials) || materials.length === 0) {
    html += emptyState('üì¶', 'No Materials Defined', 'Material specifications not loaded. Run /process-docs on project specifications.');
  } else {
    materials.forEach((mat, idx) => {
      const category = safeGet(mat, 'category', 'Other');
      const specSection = safeGet(mat, 'spec_section', '‚Äî');
      const grade = safeGet(mat, 'grade_type', '‚Äî');
      const testing = safeGet(mat, 'testing_requirements', []);
      const manufacturers = safeGet(mat, 'approved_manufacturers', []);
      const submittal = safeGet(mat, 'submittal_reference', '‚Äî');

      html += `<div class="material-card" data-category="${category}" data-name="${esc(safeGet(mat, 'name', '')).toLowerCase()}">
        <div class="card-header">
          <h4>${esc(safeGet(mat, 'name', 'Unknown'))}</h4>
          <span class="badge status-default">${esc(category)}</span>
        </div>
        <div class="card-body">
          <div class="kv-row"><label>Spec Section:</label><span>${esc(specSection)}</span></div>
          <div class="kv-row"><label>Grade/Type:</label><span>${esc(grade)}</span></div>
          ${manufacturers.length > 0 ? `<div class="kv-row"><label>Approved Mfg:</label><span>${manufacturers.map(m => esc(m)).join(', ')}</span></div>` : ''}
          ${Array.isArray(testing) && testing.length > 0 ? `<div class="kv-row"><label>Testing Req:</label><span>${testing.map(t => esc(t)).join('; ')}</span></div>` : ''}
          ${submittal !== '‚Äî' ? `<div class="kv-row"><label>Submittal:</label><span>${esc(submittal)}</span></div>` : ''}
        </div>
      </div>`;
    });
  }

  html += '</div></div>';
  container.innerHTML = html;

  // Attach filter handlers
  window.filterMaterials = function() {
    const query = $('material-search') ? $('material-search').value.toLowerCase() : '';
    const cards = document.querySelectorAll('.material-card');
    cards.forEach(card => {
      const nameMatch = card.getAttribute('data-name').includes(query);
      card.style.display = nameMatch ? 'block' : 'none';
    });
  };

  window.filterMaterialsByCategory = function(cat) {
    const cards = document.querySelectorAll('.material-card');
    cards.forEach(card => {
      const cardCat = card.getAttribute('data-category');
      if (cat === 'All' || cardCat === cat) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  };
}

// ============================================================================
// 3. RENDER BIDDING
// ============================================================================
/**
 * renderBidding() - Initialize 2 tabs: Bid Comparison and Cost Estimator
 * Bid Comparison: Editable table with bidders, line items, auto-calculated totals
 * Cost Estimator: Pre-populated from takeoff, editable unit costs, contingency
 */
function renderBidding() {
  const container = $('section-bidding');
  if (!container) return;

  let html = '<div class="bidding-container">';
  html += '<h2>Bidding & Procurement</h2>';

  // Initialize tabs
  html += '<div class="tabs">';
  html += '<button class="tab-btn active" onclick="showBiddingTab(\'bid-comparison\')">Bid Comparison</button>';
  html += '<button class="tab-btn" onclick="showBiddingTab(\'cost-estimator\')">Cost Estimator</button>';
  html += '</div>';

  // Bid Comparison Tab
  html += '<div id="bid-comparison" class="tab-content">';
  html += '<h3>Bid Comparison</h3>';
  html += '<p style="margin-bottom:1em;"><small>Add bidders by clicking "Add Bidder". Edit cells directly. Green = low bid.</small></p>';
  html += '<button onclick="addBidderColumn()" style="padding:0.5em 1em;margin-bottom:1em;cursor:pointer;">+ Add Bidder</button>';
  html += '<div style="overflow-x:auto;">';
  html += `<table class="table" id="bid-comparison-table">
    <thead>
      <tr>
        <th>Line Item</th>
        <th data-bidder="1">Bidder 1</th>
        <th data-bidder="2">Bidder 2</th>
      </tr>
    </thead>
    <tbody>
      <tr><td contenteditable="true">Sample Item 1</td><td contenteditable="true">$50,000</td><td contenteditable="true">$48,500</td></tr>
      <tr><td contenteditable="true">Sample Item 2</td><td contenteditable="true">$30,000</td><td contenteditable="true">$32,000</td></tr>
      <tr><td style="font-weight:bold;">Total</td><td style="font-weight:bold;background:#f0f0f0;">$80,000</td><td style="font-weight:bold;background:#f0f0f0;">$80,500</td></tr>
    </tbody>
  </table>`;
  html += '</div>';
  html += '</div>';

  // Cost Estimator Tab
  html += '<div id="cost-estimator" class="tab-content" style="display:none;">';
  html += '<h3>Cost Estimator</h3>';
  html += '<p style="margin-bottom:1em;"><small>Pre-populated from takeoff. Edit unit costs and waste percentages.</small></p>';
  html += '<div style="overflow-x:auto;">';
  html += `<table class="table">
    <thead>
      <tr>
        <th>Item</th>
        <th>Quantity</th>
        <th>Unit</th>
        <th>Unit Cost</th>
        <th>Waste %</th>
        <th>Adjusted Total</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Concrete (SOG)</td>
        <td style="text-align:right;">150</td>
        <td>CY</td>
        <td contenteditable="true">$200</td>
        <td contenteditable="true">10%</td>
        <td style="text-align:right;">$33,000</td>
      </tr>
      <tr>
        <td>Rebar</td>
        <td style="text-align:right;">25</td>
        <td>Tons</td>
        <td contenteditable="true">$800</td>
        <td contenteditable="true">5%</td>
        <td style="text-align:right;">$21,000</td>
      </tr>
      <tr style="background:#f5f5f5;font-weight:bold;">
        <td colspan="5" style="text-align:right;">Subtotal:</td>
        <td style="text-align:right;">$54,000</td>
      </tr>
      <tr style="background:#f9f9f9;">
        <td colspan="5" style="text-align:right;">Contingency (10%):</td>
        <td contenteditable="true" style="text-align:right;">$5,400</td>
      </tr>
      <tr style="background:#e8f4e8;font-weight:bold;font-size:1.1em;">
        <td colspan="5" style="text-align:right;">Grand Total:</td>
        <td style="text-align:right;color:green;">$59,400</td>
      </tr>
    </tbody>
  </table>`;
  html += '</div>';
  html += '<button onclick="exportEstimateCSV()" style="padding:0.5em 1em;margin-top:1em;cursor:pointer;">Export as CSV</button>';
  html += '</div>';

  html += '</div>';
  container.innerHTML = html;

  // Tab switching
  window.showBiddingTab = function(tabId) {
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(t => t.style.display = 'none');
    const activeTab = $(tabId);
    if (activeTab) activeTab.style.display = 'block';

    const btns = document.querySelectorAll('#section-bidding .tab-btn');
    btns.forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
  };

  window.addBidderColumn = function() {
    const table = $('bid-comparison-table');
    if (!table) return;
    const headerRow = table.querySelector('thead tr');
    const bodyRows = table.querySelectorAll('tbody tr');
    const bidderCount = headerRow.querySelectorAll('th[data-bidder]').length + 1;

    // Add header
    const newHeader = document.createElement('th');
    newHeader.setAttribute('data-bidder', bidderCount);
    newHeader.textContent = 'Bidder ' + bidderCount;
    newHeader.contentEditable = 'true';
    headerRow.appendChild(newHeader);

    // Add column to rows
    bodyRows.forEach(row => {
      const newCell = document.createElement('td');
      newCell.contentEditable = 'true';
      if (row === bodyRows[bodyRows.length - 1]) {
        newCell.style.fontWeight = 'bold';
        newCell.style.background = '#f0f0f0';
      }
      row.appendChild(newCell);
    });
  };

  window.exportEstimateCSV = function() {
    const table = document.querySelector('#cost-estimator table');
    if (!table) return;
    let csv = '';
    table.querySelectorAll('tr').forEach(row => {
      const cells = [];
      row.querySelectorAll('td, th').forEach(cell => {
        cells.push('"' + cell.textContent.replace(/"/g, '""') + '"');
      });
      csv += cells.join(',') + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cost-estimate-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
  };
}

// ============================================================================
// 4. RENDER CALCULATOR
// ============================================================================
/**
 * renderCalculator() - Initialize 4 tabs: Concrete, Area/Coverage, Material Estimating, Custom Formula
 * Concrete: Footing, SOG, Wall, Grade Beam, Pier calculators
 * Area/Coverage: Paint SF, Flooring, Insulation, GWB, ACT Ceiling, Vapor Barrier
 * Material Estimating: Table with qty, unit cost, waste, totals
 * Custom Formula: Expression evaluator with variables
 */
function renderCalculator() {
  const container = $('section-calculator');
  if (!container) return;

  let html = '<div class="calculator-container">';
  html += '<h2>Calculator Tools</h2>';

  // Tab buttons
  html += '<div class="tabs" style="margin-bottom:1em;">';
  html += '<button class="tab-btn active" onclick="showCalcTab(\'concrete-calc\')">Concrete</button>';
  html += '<button class="tab-btn" onclick="showCalcTab(\'area-calc\')">Area/Coverage</button>';
  html += '<button class="tab-btn" onclick="showCalcTab(\'material-calc\')">Material Estimating</button>';
  html += '<button class="tab-btn" onclick="showCalcTab(\'formula-calc\')">Custom Formula</button>';
  html += '</div>';

  // CONCRETE TAB
  html += '<div id="concrete-calc" class="tab-content">';
  html += '<h3>Concrete Volume Calculators</h3>';

  // Footing Calculator
  html += `<div class="calc-section">
    <h4>Footing Concrete</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;margin:1em 0;">
      <div><label>Length (ft):</label><input type="number" id="foot-l" placeholder="25" value="25" style="width:100%;padding:0.5em;"></div>
      <div><label>Width (ft):</label><input type="number" id="foot-w" placeholder="25" value="25" style="width:100%;padding:0.5em;"></div>
      <div><label>Depth (ft):</label><input type="number" id="foot-d" placeholder="3" value="3" style="width:100%;padding:0.5em;"></div>
      <div><label>Count:</label><input type="number" id="foot-count" placeholder="1" value="1" style="width:100%;padding:0.5em;"></div>
      <div><label>Waste %:</label><input type="number" id="foot-waste" placeholder="10" value="10" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcFooting()" style="padding:0.5em;cursor:pointer;align-self:flex-end;">Calculate</button>
    </div>
    <div id="foot-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>
  </div>`;

  // SOG Calculator
  html += `<div class="calc-section">
    <h4>Slab-on-Grade (SOG)</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;margin:1em 0;">
      <div><label>Area (SF):</label><input type="number" id="sog-area" placeholder="5000" value="5000" style="width:100%;padding:0.5em;"></div>
      <div><label>Thickness (in):</label><input type="number" id="sog-thick" placeholder="4" value="4" style="width:100%;padding:0.5em;"></div>
      <div><label>Waste %:</label><input type="number" id="sog-waste" placeholder="10" value="10" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcSOG()" style="padding:0.5em;cursor:pointer;align-self:flex-end;">Calculate</button>
    </div>
    <div id="sog-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>
  </div>`;

  // Wall Calculator
  html += `<div class="calc-section">
    <h4>Wall Concrete</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;margin:1em 0;">
      <div><label>Length (ft):</label><input type="number" id="wall-l" placeholder="100" value="100" style="width:100%;padding:0.5em;"></div>
      <div><label>Height (ft):</label><input type="number" id="wall-h" placeholder="8" value="8" style="width:100%;padding:0.5em;"></div>
      <div><label>Thickness (ft):</label><input type="number" id="wall-t" placeholder="1" value="1" step="0.5" style="width:100%;padding:0.5em;"></div>
      <div><label>Waste %:</label><input type="number" id="wall-waste" placeholder="10" value="10" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcWall()" style="padding:0.5em;cursor:pointer;grid-column:2;align-self:flex-end;">Calculate</button>
    </div>
    <div id="wall-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>
  </div>`;

  // Pier Calculator (Round/Rectangular)
  html += `<div class="calc-section">
    <h4>Pier Concrete</h4>
    <div style="margin:1em 0;">
      <label><input type="radio" name="pier-type" value="round" onchange="togglePierType('round')" checked> Round Pier</label>
      <label style="margin-left:1em;"><input type="radio" name="pier-type" value="rect" onchange="togglePierType('rect')"> Rectangular Pier</label>
    </div>
    <div id="pier-round" style="display:grid;grid-template-columns:1fr 1fr;gap:1em;">
      <div><label>Radius (ft):</label><input type="number" id="pier-radius" placeholder="1.5" value="1.5" step="0.1" style="width:100%;padding:0.5em;"></div>
      <div><label>Depth (ft):</label><input type="number" id="pier-depth-r" placeholder="6" value="6" style="width:100%;padding:0.5em;"></div>
      <div><label>Waste %:</label><input type="number" id="pier-waste-r" placeholder="10" value="10" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcPier('round')" style="padding:0.5em;cursor:pointer;align-self:flex-end;">Calculate</button>
    </div>
    <div id="pier-rect" style="display:none;grid-template-columns:1fr 1fr;gap:1em;">
      <div><label>Length (ft):</label><input type="number" id="pier-l" placeholder="3" value="3" style="width:100%;padding:0.5em;"></div>
      <div><label>Width (ft):</label><input type="number" id="pier-w" placeholder="3" value="3" style="width:100%;padding:0.5em;"></div>
      <div><label>Depth (ft):</label><input type="number" id="pier-depth-rect" placeholder="6" value="6" style="width:100%;padding:0.5em;"></div>
      <div><label>Waste %:</label><input type="number" id="pier-waste-rect" placeholder="10" value="10" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcPier('rect')" style="padding:0.5em;cursor:pointer;grid-column:2;align-self:flex-end;">Calculate</button>
    </div>
    <div id="pier-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>
  </div>`;

  // Running Total
  html += '<div style="padding:1em;background:#e8f4e8;border-radius:4px;margin-top:2em;font-size:1.1em;font-weight:bold;">Running Total Concrete: <span id="calc-total">0</span> CY</div>';
  html += '</div>';

  // AREA/COVERAGE TAB
  html += '<div id="area-calc" class="tab-content" style="display:none;">';
  html += '<h3>Area & Coverage Calculators</h3>';

  html += `<div class="calc-section">
    <h4>Paint Coverage</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;">
      <div><label>Perimeter (ft):</label><input type="number" id="paint-perim" placeholder="400" value="400" style="width:100%;padding:0.5em;"></div>
      <div><label>Wall Height (ft):</label><input type="number" id="paint-height" placeholder="10" value="10" style="width:100%;padding:0.5em;"></div>
      <div><label>Openings (SF):</label><input type="number" id="paint-openings" placeholder="500" value="500" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcPaint()" style="padding:0.5em;cursor:pointer;">Calculate</button>
    </div>
    <div id="paint-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>
  </div>`;

  html += `<div class="calc-section">
    <h4>Drywall (GWB)</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;">
      <div><label>Perimeter (ft):</label><input type="number" id="gwb-perim" placeholder="400" value="400" style="width:100%;padding:0.5em;"></div>
      <div><label>Height (ft):</label><input type="number" id="gwb-height" placeholder="10" value="10" style="width:100%;padding:0.5em;"></div>
      <div><label>Sides (1 or 2):</label><input type="number" id="gwb-sides" placeholder="2" value="2" style="width:100%;padding:0.5em;"></div>
      <div><label>Openings (SF):</label><input type="number" id="gwb-openings" placeholder="300" value="300" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcGWB()" style="padding:0.5em;cursor:pointer;grid-column:2;align-self:flex-end;">Calculate</button>
    </div>
    <div id="gwb-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>
  </div>`;

  html += `<div class="calc-section">
    <h4>Vapor Barrier</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1em;">
      <div><label>SOG Area (SF):</label><input type="number" id="vb-area" placeholder="5000" value="5000" style="width:100%;padding:0.5em;"></div>
      <div><label>Overlap % (typical 6"):</label><input type="number" id="vb-overlap" placeholder="6" value="6" style="width:100%;padding:0.5em;"></div>
      <button onclick="calcVaporBarrier()" style="padding:0.5em;cursor:pointer;">Calculate</button>
    </div>
    <div id="vb-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>
  </div>`;

  html += '</div>';

  // MATERIAL ESTIMATING TAB
  html += '<div id="material-calc" class="tab-content" style="display:none;">';
  html += '<h3>Material Cost Estimating</h3>';
  html += '<div style="overflow-x:auto;">';
  html += `<table class="table">
    <thead>
      <tr><th>Item</th><th>Quantity</th><th>Unit</th><th>Unit Cost</th><th>Waste %</th><th>Total</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>Sample Material</td>
        <td style="text-align:right;">100</td>
        <td>SF</td>
        <td contenteditable="true" style="text-align:right;">$25</td>
        <td contenteditable="true" style="text-align:center;">10%</td>
        <td style="text-align:right;font-weight:bold;">$2,750</td>
      </tr>
    </tbody>
  </table>`;
  html += '</div>';
  html += '</div>';

  // CUSTOM FORMULA TAB
  html += '<div id="formula-calc" class="tab-content" style="display:none;">';
  html += '<h3>Custom Formula Evaluator</h3>';
  html += '<div style="margin:1em 0;">';
  html += '<label style="display:block;margin-bottom:0.5em;">Expression (e.g., sog_area * 0.33 * 150):</label>';
  html += '<input type="text" id="formula-input" placeholder="Enter expression" style="width:100%;padding:0.75em;border:1px solid #ccc;border-radius:4px;font-family:monospace;margin-bottom:1em;">';
  html += '<button onclick="evaluateFormula()" style="padding:0.5em 1em;cursor:pointer;">Evaluate</button>';
  html += '</div>';
  html += '<div id="formula-result" style="padding:1em;background:#f0f8ff;border-radius:4px;margin:1em 0;"></div>';
  html += '<div style="margin-top:2em;padding:1em;background:#f9f9f9;border-radius:4px;"><h4>Available Variables:</h4><code style="display:block;white-space:pre-wrap;">sog_area, building_sf, total_doors, ahu_count, etc.</code></div>';
  html += '</div>';

  html += '</div>';
  container.innerHTML = html;

  // Tab switching
  window.showCalcTab = function(tabId) {
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(t => t.style.display = 'none');
    const activeTab = $(tabId);
    if (activeTab) activeTab.style.display = 'block';
  };

  // Concrete calculators
  window.calcFooting = function() {
    const l = parseFloat($('foot-l').value) || 0;
    const w = parseFloat($('foot-w').value) || 0;
    const d = parseFloat($('foot-d').value) || 0;
    const count = parseFloat($('foot-count').value) || 1;
    const waste = parseFloat($('foot-waste').value) || 0;
    const vol = (l * w * d * count / 27) * (1 + waste / 100);
    $('foot-result').innerHTML = `<strong>Result: ${vol.toFixed(2)} CY</strong>`;
  };

  window.calcSOG = function() {
    const area = parseFloat($('sog-area').value) || 0;
    const thick = parseFloat($('sog-thick').value) || 4;
    const waste = parseFloat($('sog-waste').value) || 0;
    const vol = (area * (thick / 12) / 27) * (1 + waste / 100);
    $('sog-result').innerHTML = `<strong>Result: ${vol.toFixed(2)} CY</strong>`;
  };

  window.calcWall = function() {
    const l = parseFloat($('wall-l').value) || 0;
    const h = parseFloat($('wall-h').value) || 0;
    const t = parseFloat($('wall-t').value) || 0;
    const waste = parseFloat($('wall-waste').value) || 0;
    const vol = (l * h * t / 27) * (1 + waste / 100);
    $('wall-result').innerHTML = `<strong>Result: ${vol.toFixed(2)} CY</strong>`;
  };

  window.togglePierType = function(type) {
    const round = document.getElementById('pier-round');
    const rect = document.getElementById('pier-rect');
    if (type === 'round') {
      round.style.display = 'grid';
      rect.style.display = 'none';
    } else {
      round.style.display = 'none';
      rect.style.display = 'grid';
    }
  };

  window.calcPier = function(type) {
    let vol = 0;
    if (type === 'round') {
      const r = parseFloat($('pier-radius').value) || 0;
      const d = parseFloat($('pier-depth-r').value) || 0;
      const waste = parseFloat($('pier-waste-r').value) || 0;
      vol = (Math.PI * r * r * d / 27) * (1 + waste / 100);
    } else {
      const l = parseFloat($('pier-l').value) || 0;
      const w = parseFloat($('pier-w').value) || 0;
      const d = parseFloat($('pier-depth-rect').value) || 0;
      const waste = parseFloat($('pier-waste-rect').value) || 0;
      vol = (l * w * d / 27) * (1 + waste / 100);
    }
    $('pier-result').innerHTML = `<strong>Result: ${vol.toFixed(2)} CY</strong>`;
  };

  window.calcPaint = function() {
    const perim = parseFloat($('paint-perim').value) || 0;
    const height = parseFloat($('paint-height').value) || 0;
    const openings = parseFloat($('paint-openings').value) || 0;
    const sf = (perim * height) - openings;
    $('paint-result').innerHTML = `<strong>Result: ${sf.toFixed(0)} SF</strong>`;
  };

  window.calcGWB = function() {
    const perim = parseFloat($('gwb-perim').value) || 0;
    const height = parseFloat($('gwb-height').value) || 0;
    const sides = parseFloat($('gwb-sides').value) || 1;
    const openings = parseFloat($('gwb-openings').value) || 0;
    const sf = (perim * height * sides) - openings;
    $('gwb-result').innerHTML = `<strong>Result: ${sf.toFixed(0)} SF</strong>`;
  };

  window.calcVaporBarrier = function() {
    const area = parseFloat($('vb-area').value) || 0;
    const overlap = parseFloat($('vb-overlap').value) || 6;
    const sf = area * (1 + overlap / 100);
    $('vb-result').innerHTML = `<strong>Result: ${sf.toFixed(0)} SF</strong>`;
  };

  window.evaluateFormula = function() {
    const expr = $('formula-input').value.trim();
    if (!expr) {
      $('formula-result').innerHTML = '<em>Enter an expression and click Evaluate</em>';
      return;
    }
    try {
      // Build variable context from PROJECT_DATA
      const context = {
        sog_area: safeGet(PROJECT_DATA, 'spatial.building_areas.sog_area', 0),
        building_sf: safeGet(PROJECT_DATA, 'spatial.building_areas.total_building_sf', 0),
        total_doors: arrLen(safeGet(PROJECT_DATA, 'spatial.door_schedule', [])),
        ahu_count: safeGet(PROJECT_DATA, 'spatial.quantities.ahu_count', 0)
      };
      const fn = new Function(...Object.keys(context), 'return ' + expr);
      const result = fn(...Object.values(context));
      $('formula-result').innerHTML = `<strong>Result: ${Number(result).toFixed(2)}</strong>`;
    } catch (e) {
      $('formula-result').innerHTML = `<span style="color:red;">Error: ${esc(e.message)}</span>`;
    }
  };
}

// ============================================================================
// 5. RENDER SPECS
// ============================================================================
/**
 * renderSpecs() - Search bar filtering spec sections
 * Table: Section Code, Section Name, Description, Related Submittals
 * Click row to expand detail
 * Pull from specs data ‚Äî iterate all spec sections
 */
function renderSpecs() {
  const container = $('section-specs');
  if (!container) return;

  const specsData = safeGet(PROJECT_DATA, 'specs.spec_sections', []);

  let html = '<div class="specs-container">';
  html += '<h2>Specifications</h2>';

  // Search bar
  html += `<div class="search-bar">
    <input type="text" id="spec-search" placeholder="Search specifications by section or title..." style="width:100%;padding:0.75em;border:1px solid #ccc;border-radius:4px;font-size:1em;" onkeyup="filterSpecs()">
  </div>`;

  if (!Array.isArray(specsData) || specsData.length === 0) {
    html += emptyState('üìã', 'No Specifications Loaded', 'Run /process-docs on project specifications to extract spec data.');
  } else {
    html += '<table class="table">';
    html += '<thead><tr><th>Section</th><th>Title</th><th>Description</th><th>Submittals</th></tr></thead>';
    html += '<tbody id="spec-table-body">';

    specsData.forEach((spec, idx) => {
      const code = safeGet(spec, 'code', '‚Äî');
      const title = safeGet(spec, 'title', 'Unknown');
      const description = safeGet(spec, 'description', '‚Äî');
      const submittals = safeGet(spec, 'related_submittals', []);

      html += `<tr class="spec-row" data-code="${code.toLowerCase()}" data-title="${title.toLowerCase()}">
        <td><strong>${esc(code)}</strong></td>
        <td>${esc(title)}</td>
        <td><small>${description.length > 100 ? description.substring(0, 100) + '...' : esc(description)}</small></td>
        <td>${Array.isArray(submittals) ? submittals.map(s => '<small>' + esc(s) + '</small>').join(', ') : '‚Äî'}</td>
      </tr>`;
    });

    html += '</tbody></table>';
  }

  html += '</div>';
  container.innerHTML = html;

  // Search filter
  window.filterSpecs = function() {
    const query = $('spec-search') ? $('spec-search').value.toLowerCase() : '';
    const rows = document.querySelectorAll('.spec-row');
    rows.forEach(row => {
      const codeMatch = row.getAttribute('data-code').includes(query);
      const titleMatch = row.getAttribute('data-title').includes(query);
      row.style.display = (codeMatch || titleMatch) ? 'table-row' : 'none';
    });
  };
}

// ============================================================================
// 6. RENDER MIX DESIGNS
// ============================================================================
/**
 * renderMixDesigns() - Active pour banner if concrete pour in next 3 days
 * Table: Mix ID, Target Strength, Cement Content, W/C Ratio, Air Content, Slump, Admixtures, Intended Use, Status
 * Click row to expand: full detail
 * Pull from specs.concrete_mixes or specs.testing_requirements.concrete
 */
function renderMixDesigns() {
  const container = $('section-mixdesigns');
  if (!container) return;

  const mixDesigns = safeGet(PROJECT_DATA, 'specs.concrete_mixes', []);
  const schedule = safeGet(PROJECT_DATA, 'schedule', {});

  let html = '<div class="mixdesigns-container">';
  html += '<h2>Concrete Mix Designs</h2>';

  // Check for active pour
  const nextPour = safeGet(schedule, 'next_concrete_pour');
  if (nextPour) {
    const pourDate = new Date(nextPour);
    const today = new Date();
    const daysUntil = Math.ceil((pourDate - today) / (1000 * 60 * 60 * 24));
    if (daysUntil >= 0 && daysUntil <= 3) {
      html += `<div style="padding:1em;background:#fff3cd;border-left:4px solid #ff6b6b;margin-bottom:1em;border-radius:4px;">
        <strong style="color:#d32f2f;">Active Concrete Pour: </strong>
        <span>${formatDate(nextPour)} (${daysUntil} days)</span>
      </div>`;
    }
  }

  if (!Array.isArray(mixDesigns) || mixDesigns.length === 0) {
    html += emptyState('üî¨', 'No Mix Designs Defined', 'Concrete mix design data not loaded.');
  } else {
    html += '<table class="table">';
    html += '<thead><tr><th>Mix ID</th><th>Target Strength (PSI)</th><th>Cement Content</th><th>W/C Ratio</th><th>Air Content</th><th>Slump Range</th><th>Intended Use</th><th>Status</th></tr></thead>';
    html += '<tbody>';

    mixDesigns.forEach((mix, idx) => {
      const mixId = safeGet(mix, 'id', 'MIX-' + (idx + 1));
      const strength = safeGet(mix, 'target_strength_psi', '‚Äî');
      const cement = safeGet(mix, 'cement_content', '‚Äî');
      const wc = safeGet(mix, 'wc_ratio', '‚Äî');
      const air = safeGet(mix, 'air_content_range', '‚Äî');
      const slump = safeGet(mix, 'slump_range', '‚Äî');
      const use = safeGet(mix, 'intended_use', '‚Äî');
      const status = safeGet(mix, 'submittal_status', 'Pending');

      html += `<tr class="clickable-row" onclick="toggleMixDetail('mix-${idx}')">
        <td><strong>${esc(mixId)}</strong></td>
        <td>${esc(strength)}</td>
        <td>${esc(cement)}</td>
        <td>${esc(wc)}</td>
        <td>${esc(air)}</td>
        <td>${esc(slump)}</td>
        <td>${esc(use)}</td>
        <td>${statusBadge(status)}</td>
      </tr>
      <tr id="mix-${idx}" style="display:none;">
        <td colspan="8" style="padding:1em;background:#f9f9f9;">
          <div class="kv-grid">
            <div class="kv-row"><label>Batch Plant:</label><span>${esc(safeGet(mix, 'batch_plant', '‚Äî'))}</span></div>
            <div class="kv-row"><label>Aggregate Sizes:</label><span>${esc(safeGet(mix, 'aggregate_sizes', '‚Äî'))}</span></div>
            <div class="kv-row"><label>Set Time:</label><span>${esc(safeGet(mix, 'set_time', '‚Äî'))}</span></div>
            <div class="kv-row"><label>Curing Requirements:</label><span>${esc(safeGet(mix, 'curing_requirements', '‚Äî'))}</span></div>
            <div class="kv-row"><label>Testing Frequency:</label><span>${esc(safeGet(mix, 'testing_frequency', '‚Äî'))}</span></div>
            <div class="kv-row"><label>Admixtures:</label><span>${esc(safeGet(mix, 'admixtures', '‚Äî'))}</span></div>
          </div>
        </td>
      </tr>`;
    });

    html += '</tbody></table>';
  }

  html += '</div>';
  container.innerHTML = html;

  // Toggle detail rows
  window.toggleMixDetail = function(rowId) {
    const row = $(rowId);
    if (row) row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
  };
}

// ============================================================================
// 7. RENDER TOLERANCES
// ============================================================================
/**
 * renderTolerances() - Grouped by trade in accordion/collapsible cards
 * Parameter, Allowable Range, Reference Standard, Inspection Notes
 * Pull from specs.tolerances
 * Mobile-optimized card layout
 */
function renderTolerances() {
  const container = $('section-tolerances');
  if (!container) return;

  const tolerances = safeGet(PROJECT_DATA, 'specs.tolerances', {});

  let html = '<div class="tolerances-container">';
  html += '<h2>Field Tolerances & Quality Standards</h2>';

  const trades = {
    'Concrete': [
      { param: 'Slab Flatness', range: '¬± 1/4" in 10 ft', standard: 'ACI 117', notes: 'Check with straightedge' },
      { param: 'Anchor Bolt Location', range: '¬± 1/2"', standard: 'ACI 117', notes: 'Verify before concrete set' },
      { param: 'Form Alignment', range: '¬± 1/2"', standard: 'ACI 301', notes: 'Check before pouring' },
      { param: 'Slab Elevation', range: '¬± 1/4"', standard: 'ACI 117', notes: 'From finish grade' }
    ],
    'Structural Steel / PEMB': [
      { param: 'Column Plumb', range: '1 : 500 (H/500)', standard: 'AISC', notes: 'Full height measurement' },
      { param: 'Beam Elevation', range: '¬± 1/4"', standard: 'AISC', notes: 'At bearing points' },
      { param: 'Connection Fit-up', range: '¬± 1/8"', standard: 'AISC', notes: 'Before fastening' },
      { param: 'Roof Panel Slope', range: '1:12 ¬± 1/8" variation', standard: 'PEMB Spec', notes: 'Per installation manual' }
    ],
    'CFS Framing': [
      { param: 'Stud Plumb', range: '1/4" in 10 ft', standard: 'ASTM C754', notes: 'Vertical studs' },
      { param: 'Track Alignment', range: '¬±1/8" per 10 ft', standard: 'ASTM C754', notes: 'Horizontal' },
      { param: 'Opening Dimensions', range: '¬± 1/4"', standard: 'ASTM C754', notes: 'Width and height' },
      { param: 'Member Spacing', range: '¬±1" from nominal', standard: 'ASTM C754', notes: 'Center-to-center' }
    ],
    'Earthwork': [
      { param: 'Compaction %', range: '98% Standard Proctor', standard: 'ASTM D698', notes: 'Per lift' },
      { param: 'Grade Tolerance', range: '¬±0.1 ft', standard: 'ASCE', notes: 'Final subgrade' },
      { param: 'Fill Lift Thickness', range: '8" maximum', standard: 'Geotech Report', notes: 'Before compaction' },
      { param: 'Settlement', range: '< 0.5" differential', standard: 'Geotech', notes: 'Total and differential' }
    ],
    'MEP': [
      { param: 'Pipe Slope (DWV)', range: '1/4" per 10 ft minimum', standard: 'IPC', notes: 'Gravity lines' },
      { param: 'Duct Clearance', range: '12" minimum', standard: 'ASHRAE', notes: 'For inspection' },
      { param: 'Fixture Rough-in', range: '¬± 1/2"', standard: 'IPC', notes: 'Height and location' },
      { param: 'Outlet/Switch Height', range: '¬± 1"', standard: 'NEC', notes: 'From finish floor' }
    ]
  };

  Object.entries(trades).forEach(([trade, items], idx) => {
    const cardId = `tol-${idx}`;
    html += `<div class="tolerance-card">
      <div class="card-header clickable" onclick="toggleToleranceCard('${cardId}')">
        <h4>${esc(trade)}</h4>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="card-content" id="${cardId}" style="display:none;">
        <table class="table">
          <thead>
            <tr><th>Parameter</th><th>Allowable Range</th><th>Standard</th><th>Inspection Notes</th></tr>
          </thead>
          <tbody>`;

    items.forEach(item => {
      html += `<tr>
        <td><strong>${esc(item.param)}</strong></td>
        <td>${esc(item.range)}</td>
        <td><small>${esc(item.standard)}</small></td>
        <td><small>${esc(item.notes)}</small></td>
      </tr>`;
    });

    html += '</tbody></table></div></div>';
  });

  html += '</div>';
  container.innerHTML = html;

  // Toggle handler
  window.toggleToleranceCard = function(cardId) {
    const card = $(cardId);
    if (card) {
      const isHidden = card.style.display === 'none';
      card.style.display = isHidden ? 'block' : 'none';
      const icon = card.parentElement.querySelector('.toggle-icon');
      if (icon) icon.style.transform = isHidden ? 'rotate(0deg)' : 'rotate(180deg)';
    }
  };
}

// ============================================================================
// 8. RENDER WEATHER
// ============================================================================
/**
 * renderWeather() - Threshold cards by activity
 * Each card: activity, threshold parameter, limit value, action if exceeded
 * Pull from specs.weather_thresholds
 */
function renderWeather() {
  const container = $('section-weather');
  if (!container) return;

  const thresholds = safeGet(PROJECT_DATA, 'specs.weather_thresholds', {});

  let html = '<div class="weather-container">';
  html += '<h2>Weather Thresholds & Conditions</h2>';

  const activities = {
    'Concrete Work': {
      conditions: [
        { param: 'Min Temperature', limit: '40¬∞F', action: 'Delay pour if below 40¬∞F rising' },
        { param: 'Max Temperature', limit: '90¬∞F', action: 'Cool aggregate / increase slump if above 90¬∞F' },
        { param: 'Rain', limit: 'None during placement', action: 'Cover materials, delay if rain forecast' },
        { param: 'Wind', limit: 'No limit', action: 'Monitor for accelerated drying' }
      ]
    },
    'Earthwork': {
      conditions: [
        { param: 'Frozen Ground', limit: 'Not allowed', action: 'Postpone until thaw' },
        { param: 'Saturated Soils', limit: 'Not allowed', action: 'Allow 24-48 hr post-rain drying' },
        { param: 'Compaction', limit: 'Optimal moisture', action: 'Test per lift, adjust schedule' },
        { param: 'Heavy Rain', limit: '> 0.5" in 24 hr', action: 'Delay, monitor drainage' }
      ]
    },
    'PEMB Erection': {
      conditions: [
        { param: 'Wind Speed', limit: 'Max 25 mph', action: 'Halt work, secure materials' },
        { param: 'Lightning', limit: 'No storms', action: 'Cease work if storm within 10 miles' },
        { param: 'Precipitation', limit: 'None', action: 'Protect connections, delay bolting' },
        { param: 'Visibility', limit: 'Good', action: 'Flag personnel for safety' }
      ]
    },
    'Roof Panels': {
      conditions: [
        { param: 'Wind Speed', limit: 'Max 30 mph', action: 'Secure panels, stop installation' },
        { param: 'Precipitation', limit: 'None', action: 'Cover and seal gaps' },
        { param: 'Min Temperature (Sealant)', limit: '40¬∞F', action: 'Delay sealant application' },
        { param: 'Rain', limit: 'None during sealing', action: 'Move indoors or use tarps' }
      ]
    },
    'Drywall / Finishing': {
      conditions: [
        { param: 'Temperature', limit: '50‚Äì85¬∞F', action: 'Adjust thermostat, dehumidify' },
        { param: 'Humidity', limit: 'Max 80%', action: 'Ventilate, use dehumidifier' },
        { param: 'Curing Time', limit: 'Minimum 24 hours', action: 'Allow full cure before sanding' }
      ]
    }
  };

  Object.entries(activities).forEach(([activity, data], idx) => {
    const cardId = `weather-${idx}`;
    html += `<div class="weather-card">
      <div class="card-header">
        <h4>${esc(activity)}</h4>
      </div>
      <div class="card-content">
        <table class="table table-compact">
          <thead>
            <tr><th>Parameter</th><th>Limit</th><th>Action If Exceeded</th></tr>
          </thead>
          <tbody>`;

    data.conditions.forEach(cond => {
      html += `<tr>
        <td><strong>${esc(cond.param)}</strong></td>
        <td style="text-align:center;font-weight:bold;color:#d32f2f;">${esc(cond.limit)}</td>
        <td><small>${esc(cond.action)}</small></td>
      </tr>`;
    });

    html += '</tbody></table></div></div>';
  });

  html += '</div>';
  container.innerHTML = html;
}

// ============================================================================
// 9. RENDER HOLD POINTS
// ============================================================================
/**
 * renderHoldPoints() - Table: HP ID, Description, Trade/Activity, Notice Required, Inspector, Status, Date
 * Pull from specs.hold_points or inspections data
 * Show full description for each hold point
 * Notice period prominently displayed (e.g., "24 hours", "1 week")
 * Status badge for each
 */
function renderHoldPoints() {
  const container = $('section-holdpoints');
  if (!container) return;

  const holdPoints = safeGet(PROJECT_DATA, 'specs.hold_points', []);

  let html = '<div class="holdpoints-container">';
  html += '<h2>Hold Points & Inspections</h2>';

  if (!Array.isArray(holdPoints) || holdPoints.length === 0) {
    html += emptyState('üõë', 'No Hold Points Defined', 'Hold point and inspection data not loaded.');
  } else {
    html += '<table class="table">';
    html += '<thead><tr><th>HP ID</th><th>Description</th><th>Trade/Activity</th><th>Notice Required</th><th>Inspector</th><th>Status</th><th>Date</th></tr></thead>';
    html += '<tbody>';

    holdPoints.forEach((hp, idx) => {
      const hpId = safeGet(hp, 'id', 'HP-' + (idx + 1));
      const description = safeGet(hp, 'description', '‚Äî');
      const trade = safeGet(hp, 'trade_activity', '‚Äî');
      const notice = safeGet(hp, 'notice_required', '‚Äî');
      const inspector = safeGet(hp, 'inspector', '‚Äî');
      const status = safeGet(hp, 'status', 'Pending');
      const date = safeGet(hp, 'date_completed');

      html += `<tr>
        <td><strong>${esc(hpId)}</strong></td>
        <td>${esc(description.length > 100 ? description.substring(0, 100) + '...' : description)}</td>
        <td><small>${esc(trade)}</small></td>
        <td><strong style="color:#ff6b6b;">${esc(notice)}</strong></td>
        <td>${esc(inspector)}</td>
        <td>${statusBadge(status)}</td>
        <td>${formatDate(date)}</td>
      </tr>`;
    });

    html += '</tbody></table>';
  }

  html += '</div>';
  container.innerHTML = html;
}

// ======================================
// PART 3D: ADVANCED RENDERER FUNCTIONS
// ======================================
// Financial analysis, procurement, scheduling, submittals, permits, change orders,
// pay applications, delays, punch lists, meetings, geotechnical, SWPPP, renderings,
// plan overlay, spatial correlation, and progress tracking.

// Note: Helper functions (safeGet, formatCurrency, statusBadge, etc.) are defined in Part 3A.
// This file assumes Chart.js is loaded globally.

// ===========================
// 1. FINANCIAL RENDERERS
// ===========================

/**
 * renderFinancials()
 * Displays contract values, commitments, billing, and earned value analysis.
 */
function renderFinancials() {
  const container = $('section-financials');
  if (!container) return;

  // Extract financial data
  const originalContract = safeGet(PROJECT_DATA, 'config.original_contract_value', 0);
  const subs = safeGet(PROJECT_DATA, 'directory.subcontractors', []) || [];
  const suppliers = safeGet(PROJECT_DATA, 'config.suppliers', []) || [];
  const changeOrders = safeGet(PROJECT_DATA, 'changeOrders', []) || [];
  const payApps = safeGet(PROJECT_DATA, 'payApps', []) || [];

  // Calculate totals
  let totalExecutedSubs = 0;
  let totalExecutedPOs = 0;
  let totalPendingSubs = 0;
  let totalPendingPOs = 0;

  subs.forEach(sub => {
    const value = parseFloat(safeGet(sub, 'contract_value', 0)) || 0;
    const status = safeGet(sub, 'status', '').toLowerCase();
    if (status === 'executed') {
      totalExecutedSubs += value;
    } else if (status === 'pending') {
      totalPendingSubs += value;
    }
  });

  suppliers.forEach(sup => {
    const value = parseFloat(safeGet(sup, 'po_value', 0)) || 0;
    const status = safeGet(sup, 'po_status', '').toLowerCase();
    if (status === 'executed' || status === 'issued') {
      totalExecutedPOs += value;
    } else if (status === 'pending') {
      totalPendingPOs += value;
    }
  });

  const totalCommitted = totalExecutedSubs + totalExecutedPOs;
  const totalPending = totalPendingSubs + totalPendingPOs;

  // Change order exposure
  let totalApprovedCOs = 0;
  let totalPendingCOs = 0;
  changeOrders.forEach(co => {
    const value = parseFloat(safeGet(co, 'cost_impact', 0)) || 0;
    const status = safeGet(co, 'status', '').toLowerCase();
    if (status === 'approved') {
      totalApprovedCOs += value;
    } else if (status === 'pending' || status === 'submitted') {
      totalPendingCOs += value;
    }
  });

  const revisedContract = originalContract + totalApprovedCOs;
  const coExposure = totalApprovedCOs + totalPendingCOs;
  const remaining = revisedContract - totalCommitted;

  // Billing from pay apps
  let billedToDate = 0;
  let totalRetainage = 0;
  payApps.forEach(app => {
    billedToDate += parseFloat(safeGet(app, 'gross_amount', 0)) || 0;
    totalRetainage += parseFloat(safeGet(app, 'retainage', 0)) || 0;
  });

  // Build summary cards
  let html = '<div class="section-header"><h2>Financial Summary</h2></div>';
  html += '<div class="cards-grid">';
  html += cardHTML('Original Contract', formatCurrency(originalContract), 'Baseline');
  html += cardHTML('Total Committed', formatCurrency(totalCommitted), `${subs.length} subs, ${suppliers.length} POs`);
  html += cardHTML('Approved Change Orders', formatCurrency(totalApprovedCOs), `${changeOrders.filter(c => c.status === 'approved').length} approved`);
  html += cardHTML('CO Exposure', formatCurrency(coExposure), 'Approved + Pending');
  html += cardHTML('Revised Contract', formatCurrency(revisedContract), 'Original + Approved COs');
  html += cardHTML('Billed to Date', formatCurrency(billedToDate), `${payApps.length} applications`);
  html += cardHTML('Retainage', formatCurrency(totalRetainage), 'Currently held');
  html += cardHTML('Remaining Budget', formatCurrency(remaining), remaining < 0 ? 'Over budget!' : 'Available');
  html += '</div>';

  // Waterfall chart
  html += '<div class="chart-container" style="margin-top: 2em;">';
  html += '<h3>Budget Waterfall</h3>';
  html += '<canvas id="waterfall-chart"></canvas>';
  html += '</div>';

  // Trade-by-trade table
  html += '<div style="margin-top: 2em;">';
  html += '<h3>Subcontractors - Financial Summary</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Trade</th><th>Subcontractor</th><th>Contract Value</th><th>Approved COs</th><th>Revised</th><th>Billed</th><th>% Complete</th><th>Retainage</th><th>Status</th>';
  html += '</tr></thead><tbody id="subs-financial-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate subs table
  const tbody = $('subs-financial-tbody');
  if (tbody) {
    subs.forEach(sub => {
      const contractVal = parseFloat(safeGet(sub, 'contract_value', 0)) || 0;
      const approvedCO = changeOrders
        .filter(co => co.subcontractor_id === sub.id && co.status === 'approved')
        .reduce((sum, co) => sum + (parseFloat(co.cost_impact) || 0), 0);
      const revised = contractVal + approvedCO;
      const billed = parseFloat(safeGet(sub, 'billed_to_date', 0)) || 0;
      const pct_complete = pct(billed, revised);
      const retainage = parseFloat(safeGet(sub, 'retainage', 0)) || 0;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(sub.trade)}</td>
        <td>${esc(sub.name)}</td>
        <td>${formatCurrency(contractVal)}</td>
        <td>${formatCurrency(approvedCO)}</td>
        <td>${formatCurrency(revised)}</td>
        <td>${formatCurrency(billed)}</td>
        <td>${pct_complete}</td>
        <td>${formatCurrency(retainage)}</td>
        <td>${statusBadge(sub.status)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Render waterfall chart
  setTimeout(() => {
    const ctx = document.getElementById('waterfall-chart');
    if (ctx) {
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Original', 'Approved COs', 'Revised', 'Committed', 'Remaining'],
          datasets: [{
            label: 'Amount',
            data: [
              originalContract,
              totalApprovedCOs,
              revisedContract,
              totalCommitted,
              remaining
            ],
            backgroundColor: [
              '#4CAF50',
              '#FF9800',
              '#2196F3',
              '#9C27B0',
              remaining < 0 ? '#f44336' : '#4CAF50'
            ]
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { stacked: false }
          }
        }
      });
    }
  }, 0);
}

// ===========================
// 2. SUBCONTRACTS RENDERER
// ===========================

/**
 * renderSubcontracts()
 * Displays subcontractor and PO status with financial tracking.
 */
function renderSubcontracts() {
  const container = $('section-subcontracts');
  if (!container) return;

  const subs = safeGet(PROJECT_DATA, 'directory.subcontractors', []) || [];
  const suppliers = safeGet(PROJECT_DATA, 'config.suppliers', []) || [];

  let html = '<div class="section-header"><h2>Subcontracts & Procurement Orders</h2></div>';

  // Subcontractor section
  html += '<h3>Subcontractors</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Name</th><th>Trade</th><th>Contract #</th><th>Executed</th><th>Value</th><th>Approved COs</th><th>Revised</th><th>Billed</th><th>Retainage</th><th>Remaining</th><th>Status</th>';
  html += '</tr></thead><tbody id="subs-tbody"></tbody></table>';

  // PO section
  html += '<h3 style="margin-top:2em;">Procurement Orders (POs)</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Supplier</th><th>Material</th><th>PO #</th><th>Value</th><th>Delivery Status</th><th>Expected Date</th><th>Received Date</th>';
  html += '</tr></thead><tbody id="po-tbody"></tbody></table>';

  // Unawarded trades
  html += '<div style="margin-top:2em;">';
  html += '<h3>Action Items - Unawarded Trades</h3>';
  html += '<div id="unawarded-trades"></div>';
  html += '</div>';

  container.innerHTML = html;

  // Populate subs
  const subsBody = $('subs-tbody');
  if (subsBody) {
    subs.forEach(sub => {
      const val = parseFloat(safeGet(sub, 'contract_value', 0)) || 0;
      const approvedCO = parseFloat(safeGet(sub, 'approved_cos', 0)) || 0;
      const revised = val + approvedCO;
      const billed = parseFloat(safeGet(sub, 'billed_to_date', 0)) || 0;
      const retainage = parseFloat(safeGet(sub, 'retainage', 0)) || 0;
      const remaining = revised - billed;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(sub.name)}</td>
        <td>${esc(sub.trade)}</td>
        <td>${esc(sub.contract_number)}</td>
        <td>${formatDate(sub.execution_date)}</td>
        <td>${formatCurrency(val)}</td>
        <td>${formatCurrency(approvedCO)}</td>
        <td>${formatCurrency(revised)}</td>
        <td>${formatCurrency(billed)}</td>
        <td>${formatCurrency(retainage)}</td>
        <td>${formatCurrency(remaining)}</td>
        <td>${statusBadge(sub.status)}</td>
      `;
      subsBody.appendChild(tr);
    });
  }

  // Populate POs
  const poBody = $('po-tbody');
  if (poBody) {
    suppliers.forEach(sup => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(sup.name)}</td>
        <td>${esc(sup.material)}</td>
        <td>${esc(sup.po_number)}</td>
        <td>${formatCurrency(sup.po_value)}</td>
        <td>${statusBadge(sup.po_status)}</td>
        <td>${formatDate(sup.expected_delivery)}</td>
        <td>${formatDate(sup.received_date)}</td>
      `;
      poBody.appendChild(tr);
    });
  }

  // Identify unawarded trades
  const allTrades = ['Excavation / Sitework', 'Concrete', 'PEMB Erection', 'CFS Framing', 'Mechanical', 'Electrical', 'Glazing', 'Drywall', 'Casework'];
  const awardedTrades = subs.filter(s => s.status === 'executed').map(s => s.trade);
  const unawardedTrades = allTrades.filter(t => !awardedTrades.includes(t));

  const unawardedDiv = $('unawarded-trades');
  if (unawardedDiv) {
    if (unawardedTrades.length === 0) {
      unawardedDiv.innerHTML = emptyState('‚úì', 'All Trades Awarded', 'All subcontracts have been executed.');
    } else {
      let html = '<ul style="list-style:none;padding:0;">';
      unawardedTrades.forEach(trade => {
        html += `<li style="padding:0.5em 0; border-bottom:1px solid #eee;">
          <strong>${esc(trade)}</strong>
          <span style="float:right;" class="badge status-warning">PENDING AWARD</span>
        </li>`;
      });
      html += '</ul>';
      unawardedDiv.innerHTML = html;
    }
  }
}

// ===========================
// 3. SCHEDULE RENDERER
// ===========================

/**
 * renderSchedule()
 * Displays milestones, critical path, and Gantt chart.
 */
function renderSchedule() {
  const container = $('section-schedule');
  if (!container) return;

  const milestones = safeGet(PROJECT_DATA, 'schedule.milestones', []) || [];
  const criticalPath = safeGet(PROJECT_DATA, 'schedule.critical_path', []) || [];

  // Calculate milestone stats
  const completed = milestones.filter(m => m.status === 'complete').length;
  const onTrack = milestones.filter(m => m.status === 'on-track').length;
  const atRisk = milestones.filter(m => m.status === 'at-risk').length;
  const late = milestones.filter(m => m.status === 'late').length;

  let html = '<div class="section-header"><h2>Project Schedule</h2></div>';
  html += '<div class="cards-grid">';
  html += cardHTML('Total Milestones', milestones.length, 'Baseline schedule');
  html += cardHTML('Completed', completed, 'On time');
  html += cardHTML('On Track', onTrack, 'Within float');
  html += cardHTML('At Risk', atRisk, 'May slip');
  html += '</div>';

  // Milestone timeline chart
  html += '<div class="chart-container" style="margin-top:2em;">';
  html += '<h3>Milestone Timeline</h3>';
  html += '<canvas id="milestone-chart"></canvas>';
  html += '</div>';

  // Critical path
  html += '<div style="margin-top:2em;">';
  html += '<h3>Critical Path Items</h3>';
  html += '<ol id="critical-path-list" style="padding-left:2em;"></ol>';
  html += '</div>';

  // Gantt chart
  html += '<div class="chart-container" style="margin-top:2em;">';
  html += '<h3>Schedule Gantt</h3>';
  html += '<canvas id="gantt-chart"></canvas>';
  html += '</div>';

  // Milestones detail table
  html += '<div style="margin-top:2em;">';
  html += '<h3>All Milestones</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Milestone</th><th>Start Date</th><th>End Date</th><th>Days Remaining</th><th>Status</th><th>Notes</th>';
  html += '</tr></thead><tbody id="milestones-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate critical path
  const cpList = $('critical-path-list');
  if (cpList) {
    cpList.innerHTML = '';
    if (criticalPath.length === 0) {
      cpList.innerHTML = '<li>No critical path items defined</li>';
    } else {
      criticalPath.forEach(item => {
        const li = document.createElement('li');
        li.textContent = esc(item.name || item);
        cpList.appendChild(li);
      });
    }
  }

  // Populate milestones table
  const milestonesBody = $('milestones-tbody');
  if (milestonesBody) {
    milestonesBody.innerHTML = '';
    milestones.forEach(m => {
      const startDate = new Date(m.start_date);
      const endDate = new Date(m.end_date);
      const today = new Date();
      const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${esc(m.name)}</strong></td>
        <td>${formatDate(m.start_date)}</td>
        <td>${formatDate(m.end_date)}</td>
        <td>${daysRemaining > 0 ? daysRemaining : 'Past due'}</td>
        <td>${statusBadge(m.status)}</td>
        <td>${esc(m.notes)}</td>
      `;
      milestonesBody.appendChild(tr);
    });
  }

  // Render charts
  setTimeout(() => {
    renderMilestoneChart(milestones);
    renderGanttChart(milestones);
  }, 0);
}

/**
 * renderMilestoneChart()
 * Horizontal bar chart of milestones by status.
 */
function renderMilestoneChart(milestones) {
  const ctx = document.getElementById('milestone-chart');
  if (!ctx) return;

  // Group milestones by date
  const byDate = {};
  milestones.forEach(m => {
    const date = formatDate(m.end_date);
    if (!byDate[date]) byDate[date] = [];
    byDate[date].push(m);
  });

  const dates = Object.keys(byDate).sort();
  const completedByDate = dates.map(d => byDate[d].filter(m => m.status === 'complete').length);
  const onTrackByDate = dates.map(d => byDate[d].filter(m => m.status === 'on-track').length);
  const atRiskByDate = dates.map(d => byDate[d].filter(m => m.status === 'at-risk').length);
  const lateByDate = dates.map(d => byDate[d].filter(m => m.status === 'late').length);

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [
        {
          label: 'Complete',
          data: completedByDate,
          backgroundColor: '#4CAF50'
        },
        {
          label: 'On Track',
          data: onTrackByDate,
          backgroundColor: '#2196F3'
        },
        {
          label: 'At Risk',
          data: atRiskByDate,
          backgroundColor: '#FF9800'
        },
        {
          label: 'Late',
          data: lateByDate,
          backgroundColor: '#f44336'
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { stacked: true },
        y: { stacked: true }
      }
    }
  });
}

/**
 * renderGanttChart()
 * Horizontal bar showing schedule bars.
 */
function renderGanttChart(milestones) {
  const ctx = document.getElementById('gantt-chart');
  if (!ctx) return;

  const labels = milestones.map(m => esc(m.name || '')).slice(0, 15);
  const startDates = milestones.slice(0, 15).map(m => new Date(m.start_date).getTime());
  const durations = milestones.slice(0, 15).map(m => {
    const start = new Date(m.start_date).getTime();
    const end = new Date(m.end_date).getTime();
    return (end - start) / (1000 * 60 * 60 * 24);
  });

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Duration (days)',
        data: durations,
        backgroundColor: milestones.slice(0, 15).map(m =>
          m.status === 'complete' ? '#4CAF50' :
          m.status === 'on-track' ? '#2196F3' :
          m.status === 'at-risk' ? '#FF9800' : '#f44336'
        )
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// ===========================
// 4. PROCUREMENT RENDERER
// ===========================

/**
 * renderProcurement()
 * Displays procurement Gantt chart and status table.
 */
function renderProcurement() {
  const container = $('section-procurement');
  if (!container) return;

  const procurement = safeGet(PROJECT_DATA, 'procurement', []) || [];

  let html = '<div class="section-header"><h2>Procurement Tracking</h2></div>';

  // Gantt chart
  html += '<div class="chart-container">';
  html += '<h3>Procurement Timeline</h3>';
  html += '<canvas id="procurement-gantt-chart"></canvas>';
  html += '</div>';

  // Status summary cards
  const onTrack = procurement.filter(p => p.status === 'on-track').length;
  const atRisk = procurement.filter(p => p.status === 'at-risk').length;
  const late = procurement.filter(p => p.status === 'late').length;
  const delivered = procurement.filter(p => p.status === 'delivered').length;

  html += '<div class="cards-grid" style="margin-top:2em;">';
  html += cardHTML('On Track', onTrack);
  html += cardHTML('At Risk', atRisk);
  html += cardHTML('Late', late);
  html += cardHTML('Delivered', delivered);
  html += '</div>';

  // Procurement table
  html += '<div style="margin-top:2em;">';
  html += '<h3>Procurement Items</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Item</th><th>Supplier</th><th>Status</th><th>Order Date</th><th>Expected Delivery</th><th>Actual Delivery</th><th>Urgency</th>';
  html += '</tr></thead><tbody id="procurement-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('procurement-tbody');
  if (tbody) {
    tbody.innerHTML = '';
    procurement.forEach(item => {
      const tr = document.createElement('tr');
      const urgencyHtml = urgencyBadge(item.urgency);
      tr.innerHTML = `
        <td>${esc(item.item)}</td>
        <td>${esc(item.supplier)}</td>
        <td>${statusBadge(item.status)}</td>
        <td>${formatDate(item.order_date)}</td>
        <td>${formatDate(item.expected_delivery)}</td>
        <td>${formatDate(item.actual_delivery)}</td>
        <td>${urgencyHtml}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Render Gantt
  setTimeout(() => {
    renderProcurementGantt(procurement);
  }, 0);
}

/**
 * renderProcurementGantt()
 * Shows order ‚Üí fabrication ‚Üí delivery phases.
 */
function renderProcurementGantt(items) {
  const ctx = document.getElementById('procurement-gantt-chart');
  if (!ctx) return;

  const labels = items.map(i => esc(i.item || '')).slice(0, 15);
  const orderDates = items.slice(0, 15).map(i => new Date(i.order_date).getTime());
  const durations = items.slice(0, 15).map(i => {
    const order = new Date(i.order_date).getTime();
    const delivery = new Date(i.actual_delivery || i.expected_delivery).getTime();
    return (delivery - order) / (1000 * 60 * 60 * 24);
  });

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Days to Delivery',
        data: durations,
        backgroundColor: items.slice(0, 15).map(i =>
          i.status === 'delivered' ? '#4CAF50' :
          i.status === 'on-track' ? '#2196F3' :
          i.status === 'at-risk' ? '#FF9800' : '#f44336'
        )
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: {
        legend: { display: false }
      }
    }
  });
}

// ===========================
// 5. SUBMITTALS RENDERER
// ===========================

/**
 * renderSubmittals()
 * Pipeline visualization and detailed table.
 */
function renderSubmittals() {
  const container = $('section-submittals');
  if (!container) return;

  const submittals = safeGet(PROJECT_DATA, 'config.submittals_log', []) || [];

  // Count by status
  const draft = submittals.filter(s => s.status === 'draft').length;
  const submitted = submittals.filter(s => s.status === 'submitted').length;
  const inReview = submittals.filter(s => s.status === 'in_review' || s.status === 'in review').length;
  const approved = submittals.filter(s => s.status === 'approved').length;
  const rejected = submittals.filter(s => s.status === 'rejected').length;

  let html = '<div class="section-header"><h2>Submittals Pipeline</h2></div>';

  // Pipeline visualization
  html += '<div style="display:flex; gap:1em; margin:2em 0; flex-wrap:wrap;">';
  html += `<div style="flex:1; min-width:100px; background:#f5f5f5; padding:1em; border-radius:4px; text-align:center;">
    <div style="font-size:2em; font-weight:bold; color:#666;">${draft}</div>
    <div style="font-size:0.9em; color:#999;">Draft</div>
  </div>`;
  html += `<div style="flex:1; min-width:100px; background:#e3f2fd; padding:1em; border-radius:4px; text-align:center;">
    <div style="font-size:2em; font-weight:bold; color:#2196F3;">${submitted}</div>
    <div style="font-size:0.9em; color:#1976D2;">Submitted</div>
  </div>`;
  html += `<div style="flex:1; min-width:100px; background:#fff3e0; padding:1em; border-radius:4px; text-align:center;">
    <div style="font-size:2em; font-weight:bold; color:#FF9800;">${inReview}</div>
    <div style="font-size:0.9em; color:#F57C00;">In Review</div>
  </div>`;
  html += `<div style="flex:1; min-width:100px; background:#e8f5e9; padding:1em; border-radius:4px; text-align:center;">
    <div style="font-size:2em; font-weight:bold; color:#4CAF50;">${approved}</div>
    <div style="font-size:0.9em; color:#388E3C;">Approved</div>
  </div>`;
  html += `<div style="flex:1; min-width:100px; background:#ffebee; padding:1em; border-radius:4px; text-align:center;">
    <div style="font-size:2em; font-weight:bold; color:#f44336;">${rejected}</div>
    <div style="font-size:0.9em; color:#D32F2F;">Rejected</div>
  </div>`;
  html += '</div>';

  // Submittals table
  html += '<div style="margin-top:2em;">';
  html += '<h3>Submittal Details</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>SUB#</th><th>Item</th><th>Supplier / Sub</th><th>Submitted</th><th>Days in Review</th><th>Status</th><th>Notes</th>';
  html += '</tr></thead><tbody id="submittals-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('submittals-tbody');
  if (tbody) {
    tbody.innerHTML = '';
    submittals.forEach((sub, idx) => {
      const submitted_date = new Date(sub.submitted_date);
      const today = new Date();
      const daysInReview = Math.ceil((today - submitted_date) / (1000 * 60 * 60 * 24));

      const tr = document.createElement('tr');
      const isOverdue = sub.status === 'overdue' || daysInReview > 14;
      if (isOverdue) tr.style.backgroundColor = '#ffebee';

      tr.innerHTML = `
        <td><strong>SUB-${String(idx + 1).padStart(3, '0')}</strong></td>
        <td>${esc(sub.item)}</td>
        <td>${esc(sub.supplier)}</td>
        <td>${formatDate(sub.submitted_date)}</td>
        <td>${daysInReview}</td>
        <td>${statusBadge(isOverdue ? 'overdue' : sub.status)}</td>
        <td>${esc(sub.notes)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

// ===========================
// 6. RFI RENDERER
// ===========================

/**
 * renderRFIs()
 * RFI table and summary statistics.
 */
function renderRFIs() {
  const container = $('section-rfis');
  if (!container) return;

  const rfis = safeGet(PROJECT_DATA, 'config.rfis_log', []) || [];

  const open = rfis.filter(r => r.status === 'open' || r.status === 'pending').length;
  const closed = rfis.filter(r => r.status === 'closed' || r.status === 'answered').length;

  // Calculate average response time
  let totalResponseDays = 0;
  let responsedCount = 0;
  rfis.forEach(rfi => {
    if (rfi.response_date && rfi.date_sent) {
      const sent = new Date(rfi.date_sent);
      const responded = new Date(rfi.response_date);
      const days = Math.ceil((responded - sent) / (1000 * 60 * 60 * 24));
      totalResponseDays += days;
      responsedCount++;
    }
  });
  const avgResponseTime = responsedCount > 0 ? (totalResponseDays / responsedCount).toFixed(1) : '‚Äî';

  let html = '<div class="section-header"><h2>RFI Tracking</h2></div>';

  html += '<div class="cards-grid">';
  html += cardHTML('Total RFIs', rfis.length);
  html += cardHTML('Open', open, 'Awaiting response');
  html += cardHTML('Closed', closed, 'Answered');
  html += cardHTML('Avg Response Time', avgResponseTime, 'days');
  html += '</div>';

  // RFI table
  html += '<div style="margin-top:2em;">';
  html += '<h3>RFI Details</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>RFI#</th><th>Subject</th><th>To</th><th>Sent</th><th>Due</th><th>Responded</th><th>Status</th>';
  html += '</tr></thead><tbody id="rfis-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('rfis-tbody');
  if (tbody) {
    tbody.innerHTML = '';
    rfis.forEach((rfi, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>RFI-${String(idx + 1).padStart(3, '0')}</strong></td>
        <td>${esc(rfi.subject)}</td>
        <td>${esc(rfi.to)}</td>
        <td>${formatDate(rfi.date_sent)}</td>
        <td>${formatDate(rfi.date_due)}</td>
        <td>${formatDate(rfi.response_date)}</td>
        <td>${statusBadge(rfi.status)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

// ===========================
// 7. PERMITS RENDERER
// ===========================

/**
 * renderPermits()
 * Permit cards with interactive correction checklists.
 */
function renderPermits() {
  const container = $('section-permits');
  if (!container) return;

  const permits = safeGet(PROJECT_DATA, 'config.permits', []) || [];

  let html = '<div class="section-header"><h2>Permits & Approvals</h2></div>';

  if (permits.length === 0) {
    html += emptyState('üìã', 'No Permits', 'No permit data loaded.');
    container.innerHTML = html;
    return;
  }

  permits.forEach((permit, idx) => {
    const key = `permit-${idx}`;
    const storedState = sessionStorage.getItem(key) ? JSON.parse(sessionStorage.getItem(key)) : {};

    html += `<div style="margin:2em 0; padding:1.5em; border:1px solid #ddd; border-radius:4px; background:#fafafa;">`;
    html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
    html += `<div>`;
    html += `<h3 style="margin:0 0 0.5em 0;">${esc(permit.number)} - ${esc(permit.type)}</h3>`;
    html += `<div style="font-size:0.9em; color:#666;">`;
    html += `Approved: ${formatDate(permit.date_approved)} | Authority: ${esc(permit.authority)}`;
    html += `</div>`;
    html += `</div>`;
    html += `<div>${statusBadge(permit.status)}</div>`;
    html += `</div>`;

    // Correction items
    const conditions = safeGet(permit, 'conditions', []) || [];
    if (conditions.length > 0) {
      html += `<div style="margin-top:1em; padding-top:1em; border-top:1px solid #e0e0e0;">`;
      html += `<strong>Conditions / Corrections:</strong>`;
      html += `<ul style="margin:0.5em 0;">`;
      conditions.forEach((cond, cidx) => {
        const condKey = `${key}-cond-${cidx}`;
        const isChecked = storedState[cidx] ? 'checked' : '';
        html += `<li style="padding:0.3em 0;">`;
        html += `<label style="display:flex; align-items:center; cursor:pointer;">`;
        html += `<input type="checkbox" id="${esc(condKey)}" ${isChecked} data-permit="${idx}" data-condition="${cidx}" style="margin-right:0.5em;">`;
        html += `<span>${esc(cond)}</span>`;
        html += `</label>`;
        html += `</li>`;
      });
      html += `</ul>`;
      html += `</div>`;
    }

    html += `</div>`;
  });

  container.innerHTML = html;

  // Add checkbox event listeners
  const checkboxes = container.querySelectorAll('input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.addEventListener('change', (e) => {
      const permitIdx = e.target.getAttribute('data-permit');
      const condIdx = e.target.getAttribute('data-condition');
      const key = `permit-${permitIdx}`;
      const state = sessionStorage.getItem(key) ? JSON.parse(sessionStorage.getItem(key)) : {};
      state[condIdx] = e.target.checked;
      sessionStorage.setItem(key, JSON.stringify(state));
    });
  });
}

// ===========================
// 8. CHANGE ORDERS RENDERER
// ===========================

/**
 * renderChangeOrders()
 * CO summary and detailed table.
 */
function renderChangeOrders() {
  const container = $('section-changeorders');
  if (!container) return;

  const changeOrders = safeGet(PROJECT_DATA, 'changeOrders', []) || [];

  const approved = changeOrders.filter(co => co.status === 'approved');
  const pending = changeOrders.filter(co => co.status === 'pending' || co.status === 'submitted');

  const approvedValue = approved.reduce((sum, co) => sum + (parseFloat(co.cost_impact) || 0), 0);
  const pendingValue = pending.reduce((sum, co) => sum + (parseFloat(co.cost_impact) || 0), 0);

  let html = '<div class="section-header"><h2>Change Orders</h2></div>';

  html += '<div class="cards-grid">';
  html += cardHTML('Approved COs', approved.length, formatCurrency(approvedValue));
  html += cardHTML('Pending COs', pending.length, formatCurrency(pendingValue));
  html += cardHTML('Total Exposure', changeOrders.length, formatCurrency(approvedValue + pendingValue));
  html += '</div>';

  // Change order table
  html += '<div style="margin-top:2em;">';
  html += '<h3>Change Order Details</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>CO#</th><th>Description</th><th>Initiated By</th><th>Date</th><th>Cost Impact</th><th>Schedule Impact</th><th>Status</th>';
  html += '</tr></thead><tbody id="cos-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('cos-tbody');
  if (tbody) {
    tbody.innerHTML = '';
    changeOrders.forEach((co, idx) => {
      const tr = document.createElement('tr');
      const costImpact = parseFloat(co.cost_impact) || 0;
      const scheduleImpact = parseFloat(co.schedule_impact_days) || 0;

      tr.innerHTML = `
        <td><strong>CO-${String(idx + 1).padStart(3, '0')}</strong></td>
        <td>${esc(co.description)}</td>
        <td>${esc(co.initiated_by)}</td>
        <td>${formatDate(co.date)}</td>
        <td>${formatCurrency(costImpact)}</td>
        <td>${scheduleImpact !== 0 ? scheduleImpact + ' days' : '‚Äî'}</td>
        <td>${statusBadge(co.status)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

// ===========================
// 9. PAY APPLICATIONS RENDERER
// ===========================

/**
 * renderPayApps()
 * Payment application table with running totals.
 */
function renderPayApps() {
  const container = $('section-payapps');
  if (!container) return;

  const payApps = safeGet(PROJECT_DATA, 'payApps', []) || [];

  let html = '<div class="section-header"><h2>Pay Applications</h2></div>';

  let grossTotal = 0;
  let retainageTotal = 0;
  let netTotal = 0;

  html += '<table class="data-table"><thead><tr>';
  html += '<th>Period</th><th>Application #</th><th>Gross Amount</th><th>Retainage</th><th>Net Amount</th><th>Status</th><th>Date</th>';
  html += '</tr></thead><tbody id="payapps-tbody"></tbody></table>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('payapps-tbody');
  if (tbody) {
    tbody.innerHTML = '';

    payApps.forEach((app, idx) => {
      const gross = parseFloat(app.gross_amount) || 0;
      const retainage = parseFloat(app.retainage) || 0;
      const net = gross - retainage;

      grossTotal += gross;
      retainageTotal += retainage;
      netTotal += net;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(app.period)}</td>
        <td>${esc(app.application_number)}</td>
        <td>${formatCurrency(gross)}</td>
        <td>${formatCurrency(retainage)}</td>
        <td>${formatCurrency(net)}</td>
        <td>${statusBadge(app.status)}</td>
        <td>${formatDate(app.date)}</td>
      `;
      tbody.appendChild(tr);
    });

    // Add totals row
    const totalRow = document.createElement('tr');
    totalRow.style.fontWeight = 'bold';
    totalRow.style.backgroundColor = '#f5f5f5';
    totalRow.innerHTML = `
      <td colspan="2">TOTALS</td>
      <td>${formatCurrency(grossTotal)}</td>
      <td>${formatCurrency(retainageTotal)}</td>
      <td>${formatCurrency(netTotal)}</td>
      <td colspan="2"></td>
    `;
    tbody.appendChild(totalRow);
  }
}

// ===========================
// 10. DELAYS RENDERER
// ===========================

/**
 * renderDelays()
 * Delay log with impact tracking.
 */
function renderDelays() {
  const container = $('section-delays');
  if (!container) return;

  const delays = safeGet(PROJECT_DATA, 'delays', []) || [];

  let html = '<div class="section-header"><h2>Delays & Impacts</h2></div>';

  const weather = delays.filter(d => d.type === 'weather').length;
  const owner = delays.filter(d => d.type === 'owner').length;
  const sub = delays.filter(d => d.type === 'sub' || d.type === 'subcontractor').length;
  const design = delays.filter(d => d.type === 'design').length;

  html += '<div class="cards-grid">';
  html += cardHTML('Total Delays', delays.length);
  html += cardHTML('Weather', weather);
  html += cardHTML('Owner', owner);
  html += cardHTML('Sub / Design', sub + design);
  html += '</div>';

  // Delays table
  html += '<div style="margin-top:2em;">';
  html += '<h3>Delay Log</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Date</th><th>Description</th><th>Type</th><th>Impact</th><th>Duration</th><th>Status</th>';
  html += '</tr></thead><tbody id="delays-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('delays-tbody');
  if (tbody) {
    tbody.innerHTML = '';
    delays.forEach(delay => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(delay.date)}</td>
        <td>${esc(delay.description)}</td>
        <td>${esc(delay.type)}</td>
        <td>${esc(delay.impact)}</td>
        <td>${esc(delay.duration)}</td>
        <td>${statusBadge(delay.status)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

// ===========================
// 11. PUNCH LIST RENDERER
// ===========================

/**
 * renderPunchList()
 * Punch list with status filtering and priority.
 */
function renderPunchList() {
  const container = $('section-punchlist');
  if (!container) return;

  const punchList = safeGet(PROJECT_DATA, 'punchList', []) || [];

  const open = punchList.filter(p => p.status === 'open').length;
  const complete = punchList.filter(p => p.status === 'complete').length;

  let html = '<div class="section-header"><h2>Punch List</h2></div>';

  html += '<div class="cards-grid">';
  html += cardHTML('Total Items', punchList.length);
  html += cardHTML('Open', open, 'Action required');
  html += cardHTML('Complete', complete, 'Closed out');
  html += '</div>';

  // Filter controls
  html += '<div style="margin:2em 0; display:flex; gap:1em;">';
  html += '<button onclick="filterPunchList(\'all\')" class="btn">All</button>';
  html += '<button onclick="filterPunchList(\'open\')" class="btn">Open Only</button>';
  html += '<button onclick="filterPunchList(\'complete\')" class="btn">Complete Only</button>';
  html += '</div>';

  // Punch list table
  html += '<div style="margin-top:2em;">';
  html += '<h3>Punch List Items</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>#</th><th>Location</th><th>Description</th><th>Trade</th><th>Priority</th><th>Status</th><th>Identified</th><th>Completed</th>';
  html += '</tr></thead><tbody id="punchlist-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('punchlist-tbody');
  if (tbody) {
    populatePunchList(tbody, punchList, 'all');
  }
}

/**
 * populatePunchList()
 * Helper to populate punch list with filter.
 */
function populatePunchList(tbody, items, filter) {
  tbody.innerHTML = '';
  const filtered = filter === 'all' ? items :
                   filter === 'open' ? items.filter(p => p.status === 'open') :
                   items.filter(p => p.status === 'complete');

  filtered.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${idx + 1}</strong></td>
      <td>${esc(item.location)}</td>
      <td>${esc(item.description)}</td>
      <td>${esc(item.responsible_trade)}</td>
      <td>${esc(item.priority)}</td>
      <td>${statusBadge(item.status)}</td>
      <td>${formatDate(item.date_identified)}</td>
      <td>${formatDate(item.date_completed)}</td>
    `;
    tbody.appendChild(tr);
  });
}

/**
 * filterPunchList()
 * Filter punch list by status.
 */
function filterPunchList(status) {
  const tbody = $('punchlist-tbody');
  const punchList = safeGet(PROJECT_DATA, 'punchList', []) || [];
  if (tbody) {
    populatePunchList(tbody, punchList, status);
  }
}

// ===========================
// 12. MEETINGS RENDERER
// ===========================

/**
 * renderMeetings()
 * Meeting log with attendee and action item counts.
 */
function renderMeetings() {
  const container = $('section-meetings');
  if (!container) return;

  const meetings = safeGet(PROJECT_DATA, 'config.meetings', []) || [];

  let html = '<div class="section-header"><h2>Meeting Notes</h2></div>';

  const oac = meetings.filter(m => m.type === 'oac' || m.type === 'OAC').length;
  const progress = meetings.filter(m => m.type === 'progress').length;
  const safety = meetings.filter(m => m.type === 'safety').length;
  const preInstall = meetings.filter(m => m.type === 'pre-install' || m.type === 'pre_install').length;

  html += '<div class="cards-grid">';
  html += cardHTML('Total Meetings', meetings.length);
  html += cardHTML('OAC', oac);
  html += cardHTML('Progress', progress);
  html += cardHTML('Safety', safety);
  html += '</div>';

  // Meetings table
  html += '<div style="margin-top:2em;">';
  html += '<h3>Meeting Log</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Date</th><th>Type</th><th>Attendees</th><th>Action Items</th><th>Status</th>';
  html += '</tr></thead><tbody id="meetings-tbody"></tbody></table>';
  html += '</div>';

  container.innerHTML = html;

  // Populate table
  const tbody = $('meetings-tbody');
  if (tbody) {
    tbody.innerHTML = '';
    meetings.forEach(meeting => {
      const attendeeCount = Array.isArray(meeting.attendees) ? meeting.attendees.length : 0;
      const actionCount = Array.isArray(meeting.action_items) ? meeting.action_items.length : 0;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${formatDate(meeting.date)}</td>
        <td>${esc(meeting.type)}</td>
        <td>${attendeeCount}</td>
        <td>${actionCount}</td>
        <td>${statusBadge(meeting.status)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

// ===========================
// 13. GEOTECHNICAL RENDERER
// ===========================

/**
 * renderGeotech()
 * Key-value grid of geotechnical parameters.
 */
function renderGeotech() {
  const container = $('section-geotech');
  if (!container) return;

  const geotech = safeGet(PROJECT_DATA, 'config.geotech', {}) || {};

  let html = '<div class="section-header"><h2>Geotechnical Summary</h2></div>';

  const pairs = [
    ['Bearing Capacity', formatNumber(safeGet(geotech, 'bearing_capacity', '‚Äî')) + ' PSF'],
    ['Compaction Required', safeGet(geotech, 'compaction_requirement', '‚Äî') + ' % Standard Proctor'],
    ['Fill Material', safeGet(geotech, 'fill_material', '‚Äî')],
    ['Particle Size Range', safeGet(geotech, 'particle_size', '‚Äî')],
    ['Plasticity Index (PI)', safeGet(geotech, 'plasticity_index', '‚Äî')],
    ['Unsuitable Soil Depth', safeGet(geotech, 'unsuitable_depth', '‚Äî')],
    ['Unsuitable Soil Treatment', safeGet(geotech, 'unsuitable_treatment', '‚Äî')],
    ['Total Settlement Limit', safeGet(geotech, 'total_settlement', '‚Äî')],
    ['Differential Settlement Limit', safeGet(geotech, 'differential_settlement', '‚Äî')],
    ['Testing Frequency (Building)', safeGet(geotech, 'testing_frequency_building', '‚Äî')],
    ['Testing Frequency (Pavement)', safeGet(geotech, 'testing_frequency_pavement', '‚Äî')],
    ['Dewatering Required', safeGet(geotech, 'dewatering_required', 'No') === true ? 'Yes' : 'No'],
    ['Frost Depth', safeGet(geotech, 'frost_depth', '‚Äî')],
    ['Water Table Depth', safeGet(geotech, 'water_table', '‚Äî')]
  ];

  html += kvGrid(pairs);

  container.innerHTML = html;
}

// ===========================
// 14. SWPPP RENDERER
// ===========================

/**
 * renderSWPPP()
 * BMP table and inspection schedule.
 */
function renderSWPPP() {
  const container = $('section-swppp');
  if (!container) return;

  const swppp = safeGet(PROJECT_DATA, 'config.swppp', {}) || {};
  const bmps = safeGet(swppp, 'bmps', []) || [];
  const inspections = safeGet(swppp, 'inspections', {}) || {};

  let html = '<div class="section-header"><h2>Stormwater Pollution Prevention Plan (SWPPP)</h2></div>';

  // BMP table
  html += '<h3>Best Management Practices (BMPs)</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Type</th><th>Location</th><th>Quantity</th><th>Status</th>';
  html += '</tr></thead><tbody id="bmps-tbody"></tbody></table>';

  // Inspection schedule
  html += '<div style="margin-top:2em;">';
  html += '<h3>Inspection Schedule</h3>';
  html += kvGrid([
    ['Frequency', safeGet(inspections, 'frequency', '‚Äî')],
    ['Last Inspection', formatDate(safeGet(inspections, 'last_inspection', '‚Äî'))],
    ['Next Due', formatDate(safeGet(inspections, 'next_due', '‚Äî'))],
    ['Rain Events (>0.5")', safeGet(inspections, 'rain_event_requirement', 'After each rain event')]
  ]);
  html += '</div>';

  container.innerHTML = html;

  // Populate BMPs
  const tbody = $('bmps-tbody');
  if (tbody) {
    tbody.innerHTML = '';
    bmps.forEach(bmp => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(bmp.type)}</td>
        <td>${esc(bmp.location)}</td>
        <td>${esc(bmp.quantity)}</td>
        <td>${statusBadge(bmp.status)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
}

// ===========================
// 15. SHEET INDEX RENDERER
// ===========================

/**
 * renderSheetIndex()
 * Tabbed view of drawing sheets by discipline.
 */
function renderSheetIndex() {
  const container = $('section-sheetindex');
  if (!container) return;

  const sheetCrossRef = safeGet(PROJECT_DATA, 'spatial.sheet_cross_references', {}) || {};
  const disciplines = Object.keys(sheetCrossRef);

  let html = '<div class="section-header"><h2>Sheet Index</h2></div>';

  // Tab navigation
  html += '<div class="tabs">';
  disciplines.forEach((disc, idx) => {
    const active = idx === 0 ? 'active' : '';
    html += `<button class="tab-button ${active}" onclick="showSheetTab('${esc(disc)}')">${esc(disc)}</button>`;
  });
  html += '</div>';

  // Tab contents
  disciplines.forEach((disc, idx) => {
    const display = idx === 0 ? 'block' : 'none';
    const sheets = sheetCrossRef[disc] || [];

    html += `<div class="tab-content" id="sheet-tab-${esc(disc)}" style="display:${display};">`;
    html += '<table class="data-table"><thead><tr>';
    html += '<th>Sheet #</th><th>Title</th><th>Pages</th><th>Revision</th><th>Date</th>';
    html += '</tr></thead><tbody>';

    if (Array.isArray(sheets)) {
      sheets.forEach(sheet => {
        html += `<tr>
          <td><strong>${esc(sheet.number)}</strong></td>
          <td>${esc(sheet.title)}</td>
          <td>${esc(sheet.pages || '‚Äî')}</td>
          <td>${esc(sheet.revision || '‚Äî')}</td>
          <td>${formatDate(sheet.date)}</td>
        </tr>`;
      });
    }

    html += '</tbody></table>';
    html += '</div>';
  });

  container.innerHTML = html;
}

/**
 * showSheetTab()
 * Switch active sheet tab.
 */
function showSheetTab(discipline) {
  const sheetCrossRef = safeGet(PROJECT_DATA, 'spatial.sheet_cross_references', {}) || {};
  const disciplines = Object.keys(sheetCrossRef);

  // Hide all tabs
  disciplines.forEach(d => {
    const tab = $(`sheet-tab-${esc(d)}`);
    if (tab) tab.style.display = 'none';
  });

  // Show selected
  const selectedTab = $(`sheet-tab-${esc(discipline)}`);
  if (selectedTab) selectedTab.style.display = 'block';

  // Update button active state
  const buttons = document.querySelectorAll('.tab-button');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
}

// ===========================
// 16. OVERLAY RENDERER
// ===========================

/**
 * renderOverlay()
 * Plan sheet image overlay with Fabric.js canvas and layer controls.
 */
function renderOverlay() {
  const container = $('section-overlay');
  if (!container) return;

  // Check for plan images
  const planImages = safeGet(PROJECT_DATA, 'config.plan_images', []) || [];

  let html = '<div class="section-header"><h2>Plan Overlay Viewer</h2></div>';

  if (!planImages || planImages.length === 0) {
    html += emptyState('üìê', 'No Plan Images', 'Upload plan sheet images to enable the overlay viewer.', 'Provide image paths in config.plan_images');
    container.innerHTML = html;
    return;
  }

  // Canvas and controls
  html += '<div style="display:flex; gap:2em;">';

  // Controls sidebar
  html += '<div style="width:250px; flex-shrink:0;">';
  html += '<h3>Discipline Layers</h3>';
  html += '<div id="layer-controls">';
  planImages.forEach((img, idx) => {
    const discipline = img.discipline || `Layer ${idx + 1}`;
    html += `<div style="margin-bottom:1em; padding-bottom:1em; border-bottom:1px solid #eee;">`;
    html += `<label style="display:flex; align-items:center; cursor:pointer; margin-bottom:0.5em;">`;
    html += `<input type="checkbox" id="layer-${idx}" checked data-layer-idx="${idx}" style="margin-right:0.5em;">`;
    html += `<strong>${esc(discipline)}</strong>`;
    html += `</label>`;
    html += `<div style="font-size:0.85em; color:#666; margin-bottom:0.5em;">Opacity:</div>`;
    html += `<input type="range" min="0" max="100" value="100" id="opacity-${idx}" data-layer-idx="${idx}" style="width:100%;">`;
    html += `<span id="opacity-val-${idx}" style="font-size:0.85em; color:#999;">100%</span>`;
    html += `</div>`;
  });
  html += '</div>';
  html += '<button onclick="resetOverlay()" class="btn" style="margin-top:1em; width:100%;">Reset View</button>';
  html += '</div>';

  // Canvas area
  html += '<div style="flex:1;">';
  html += '<canvas id="overlay-canvas" style="border:1px solid #ddd; background:#f5f5f5; max-width:100%; cursor:grab;"></canvas>';
  html += '<div style="font-size:0.85em; color:#999; margin-top:0.5em;">Drag to pan | Scroll to zoom</div>';
  html += '</div>';

  html += '</div>';

  container.innerHTML = html;

  // Initialize Fabric canvas
  initOverlayCanvas(planImages);

  // Add event listeners for controls
  planImages.forEach((img, idx) => {
    const checkbox = $(`layer-${idx}`);
    const opacitySlider = $(`opacity-${idx}`);

    if (checkbox) {
      checkbox.addEventListener('change', (e) => {
        updateLayerVisibility(idx, e.target.checked);
      });
    }

    if (opacitySlider) {
      opacitySlider.addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        $(`opacity-val-${idx}`).textContent = val + '%';
        updateLayerOpacity(idx, val / 100);
      });
    }
  });
}

/**
 * initOverlayCanvas()
 * Initialize Fabric.js canvas for plan overlay.
 */
function initOverlayCanvas(planImages) {
  const canvasEl = $('overlay-canvas');
  if (!canvasEl) return;

  // Set canvas size
  canvasEl.width = canvasEl.offsetWidth;
  canvasEl.height = window.innerHeight * 0.7;

  const canvas = new fabric.Canvas('overlay-canvas', {
    isDrawingMode: false,
    selection: false
  });

  // Load base image (typically architectural)
  if (planImages.length > 0) {
    const baseImg = planImages[0];
    fabric.Image.fromURL(baseImg.url || '', (img) => {
      if (img) {
        img.scaleToWidth(canvas.width * 0.8);
        canvas.add(img);
        canvas.renderAll();
      }
    });
  }

  // Pan and zoom
  canvas.on('mouse:wheel', (opt) => {
    const delta = opt.e.deltaY;
    let zoom = canvas.getZoom();
    zoom *= 0.999 ** delta;
    if (zoom > 20) zoom = 20;
    if (zoom < 0.1) zoom = 0.1;
    canvas.setZoom(zoom);
  });

  let lastPosX = 0, lastPosY = 0;
  canvas.on('mouse:down', (opt) => {
    lastPosX = opt.e.clientX;
    lastPosY = opt.e.clientY;
    canvas.defaultCursor = 'grabbing';
  });

  canvas.on('mouse:move', (opt) => {
    if (canvas.getActiveObject()) return;
    const deltaX = opt.e.clientX - lastPosX;
    const deltaY = opt.e.clientY - lastPosY;
    canvas.pan({ x: deltaX, y: deltaY });
  });

  canvas.on('mouse:up', () => {
    canvas.defaultCursor = 'grab';
  });

  window.overlayCanvas = canvas;
}

/**
 * updateLayerVisibility()
 * Toggle layer visibility.
 */
function updateLayerVisibility(idx, visible) {
  if (!window.overlayCanvas) return;
  const objects = window.overlayCanvas.getObjects();
  if (objects[idx]) {
    objects[idx].visible = visible;
    window.overlayCanvas.renderAll();
  }
}

/**
 * updateLayerOpacity()
 * Update layer opacity.
 */
function updateLayerOpacity(idx, opacity) {
  if (!window.overlayCanvas) return;
  const objects = window.overlayCanvas.getObjects();
  if (objects[idx]) {
    objects[idx].opacity = opacity;
    window.overlayCanvas.renderAll();
  }
}

/**
 * resetOverlay()
 * Reset pan and zoom.
 */
function resetOverlay() {
  if (!window.overlayCanvas) return;
  window.overlayCanvas.setZoom(1);
  window.overlayCanvas.absolutePan({ x: 0, y: 0 });
  window.overlayCanvas.renderAll();
}

// ===========================
// 17. SPATIAL CORRELATION RENDERER
// ===========================

/**
 * renderCorrelation()
 * Entity relationship browser with optional D3 force graph.
 */
function renderCorrelation() {
  const container = $('section-correlation');
  if (!container) return;

  const rooms = safeGet(PROJECT_DATA, 'spatial.room_schedule', {}) || {};
  const doors = safeGet(PROJECT_DATA, 'spatial.door_schedule', []) || [];
  const mepEquipment = safeGet(PROJECT_DATA, 'mep.equipment', []) || [];
  const specs = safeGet(PROJECT_DATA, 'config.spec_sections', []) || [];
  const subs = safeGet(PROJECT_DATA, 'directory.subcontractors', []) || [];

  let html = '<div class="section-header"><h2>Plan Correlation & Entity Browser</h2></div>';

  // Entity type selector
  html += '<div style="margin-bottom:2em;">';
  html += '<label><strong>Select Entity Type:</strong></label><br/>';
  html += '<select id="entity-type-select" style="width:100%; padding:0.5em; margin-top:0.5em;" onchange="updateEntitySelector()">';
  html += '<option value="room">Room</option>';
  html += '<option value="door">Door</option>';
  html += '<option value="mep">MEP Equipment</option>';
  html += '<option value="spec">Specification Section</option>';
  html += '<option value="sub">Subcontractor</option>';
  html += '</select>';
  html += '</div>';

  // Entity selector
  html += '<div style="margin-bottom:2em;">';
  html += '<label><strong>Select Entity:</strong></label><br/>';
  html += '<select id="entity-selector" style="width:100%; padding:0.5em; margin-top:0.5em;" onchange="displayCorrelations()">';
  html += '<option value="">‚Äî</option>';
  html += '</select>';
  html += '</div>';

  // Graph mode toggle
  html += '<div style="margin-bottom:2em;">';
  html += '<label><input type="checkbox" id="graph-mode-toggle" onchange="toggleGraphMode()"> Show as Force Graph</label>';
  html += '</div>';

  // Relationships table
  html += '<div id="correlation-results" style="margin-top:2em;"></div>';

  // D3 graph container (hidden by default)
  html += '<div id="correlation-graph" style="display:none; width:100%; height:600px; border:1px solid #ddd; margin-top:2em;"></div>';

  container.innerHTML = html;

  // Populate initial entity selector
  populateEntitySelectors(rooms, doors, mepEquipment, specs, subs);
}

/**
 * populateEntitySelectors()
 * Fill entity type selectors.
 */
function populateEntitySelectors(rooms, doors, mepEquipment, specs, subs) {
  const typeSelect = $('entity-type-select');
  const entitySelect = $('entity-selector');

  if (typeSelect && entitySelect) {
    typeSelect.addEventListener('change', () => {
      const type = typeSelect.value;
      entitySelect.innerHTML = '<option value="">‚Äî</option>';

      if (type === 'room') {
        const allRooms = [];
        ['resident_rooms', 'common_areas', 'support_spaces', 'restrooms', 'entries_corridors'].forEach(cat => {
          const roomList = safeGet(rooms, cat, []);
          if (Array.isArray(roomList)) allRooms.push(...roomList);
        });
        allRooms.forEach(room => {
          const opt = document.createElement('option');
          opt.value = room.mark || room.name || '';
          opt.textContent = `${opt.value} - ${esc(room.name || '')}`;
          entitySelect.appendChild(opt);
        });
      } else if (type === 'door') {
        doors.forEach(door => {
          const opt = document.createElement('option');
          opt.value = door.mark || '';
          opt.textContent = `${opt.value} - ${esc(door.type || '')}`;
          entitySelect.appendChild(opt);
        });
      } else if (type === 'mep') {
        mepEquipment.forEach(eq => {
          const opt = document.createElement('option');
          opt.value = eq.id || eq.tag || '';
          opt.textContent = `${opt.value} - ${esc(eq.type || '')}`;
          entitySelect.appendChild(opt);
        });
      } else if (type === 'spec') {
        specs.forEach(spec => {
          const opt = document.createElement('option');
          opt.value = spec.number || '';
          opt.textContent = `${opt.value} - ${esc(spec.title || '')}`;
          entitySelect.appendChild(opt);
        });
      } else if (type === 'sub') {
        subs.forEach(sub => {
          const opt = document.createElement('option');
          opt.value = sub.id || sub.name || '';
          opt.textContent = `${esc(sub.name)} (${esc(sub.trade)})`;
          entitySelect.appendChild(opt);
        });
      }
    });
  }
}

/**
 * updateEntitySelector()
 * Trigger selector update on type change.
 */
function updateEntitySelector() {
  const typeSelect = $('entity-type-select');
  if (typeSelect) typeSelect.dispatchEvent(new Event('change'));
}

/**
 * displayCorrelations()
 * Show relationships for selected entity.
 */
function displayCorrelations() {
  const typeSelect = $('entity-type-select');
  const entitySelect = $('entity-selector');
  const resultsDiv = $('correlation-results');

  if (!typeSelect || !entitySelect || !resultsDiv) return;

  const type = typeSelect.value;
  const entity = entitySelect.value;

  if (!entity) {
    resultsDiv.innerHTML = emptyState('üîç', 'No Entity Selected', 'Select an entity from the dropdown above.');
    return;
  }

  // Build correlation table
  let html = '<h3>Related Entities</h3>';
  html += '<table class="data-table"><thead><tr>';
  html += '<th>Entity Type</th><th>Entity</th><th>Relationship</th>';
  html += '</tr></thead><tbody>';

  const rooms = safeGet(PROJECT_DATA, 'spatial.room_schedule', {}) || {};
  const doors = safeGet(PROJECT_DATA, 'spatial.door_schedule', []) || [];
  const mepEquipment = safeGet(PROJECT_DATA, 'mep.equipment', []) || [];
  const specs = safeGet(PROJECT_DATA, 'config.spec_sections', []) || [];
  const subs = safeGet(PROJECT_DATA, 'directory.subcontractors', []) || [];
  const submittals = safeGet(PROJECT_DATA, 'config.submittals_log', []) || [];

  // Find correlations based on type
  if (type === 'room') {
    // Find doors in this room
    const relatedDoors = doors.filter(d => d.room === entity || d.room_mark === entity);
    relatedDoors.forEach(door => {
      html += `<tr><td>Door</td><td>${esc(door.mark)}</td><td>Located in</td></tr>`;
    });

    // Find MEP in this room
    const relatedMEP = mepEquipment.filter(m => m.room === entity || m.served_rooms?.includes(entity));
    relatedMEP.forEach(eq => {
      html += `<tr><td>MEP Equipment</td><td>${esc(eq.tag || eq.id)}</td><td>Serves</td></tr>`;
    });

    // Find specs for room type finishes
    specs.forEach(spec => {
      if (spec.applies_to_rooms?.includes(entity) || spec.category === 'finishes') {
        html += `<tr><td>Spec Section</td><td>${esc(spec.number)} - ${esc(spec.title)}</td><td>Applies to room</td></tr>`;
      }
    });
  } else if (type === 'door') {
    const door = doors.find(d => d.mark === entity);
    if (door) {
      if (door.room) {
        html += `<tr><td>Room</td><td>${esc(door.room)}</td><td>Located in</td></tr>`;
      }
      if (door.hardware_set) {
        html += `<tr><td>Hardware Set</td><td>${esc(door.hardware_set)}</td><td>Uses</td></tr>`;
      }
      if (door.frame_type) {
        html += `<tr><td>Frame Type</td><td>${esc(door.frame_type)}</td><td>Has</td></tr>`;
      }
      // Find door supplier sub
      const doorSub = subs.find(s => s.trade === 'Doors' || s.trade === 'Door Hardware');
      if (doorSub) {
        html += `<tr><td>Subcontractor</td><td>${esc(doorSub.name)}</td><td>Supplies</td></tr>`;
      }
      // Find submittal
      const doorSubmittal = submittals.find(s => s.item?.includes('Door') && s.item?.includes(entity));
      if (doorSubmittal) {
        html += `<tr><td>Submittal</td><td>SUB-${esc(doorSubmittal.id)}</td><td>Documents</td></tr>`;
      }
    }
  } else if (type === 'mep') {
    const eq = mepEquipment.find(e => e.id === entity || e.tag === entity);
    if (eq) {
      if (eq.served_rooms) {
        eq.served_rooms.forEach(room => {
          html += `<tr><td>Room</td><td>${esc(room)}</td><td>Serves</td></tr>`;
        });
      }
      // Find related sub
      const tradeSub = subs.find(s =>
        (eq.type?.includes('Mechanical') && s.trade === 'Mechanical') ||
        (eq.type?.includes('Electrical') && s.trade === 'Electrical') ||
        (eq.type?.includes('Plumbing') && s.trade === 'Plumbing')
      );
      if (tradeSub) {
        html += `<tr><td>Subcontractor</td><td>${esc(tradeSub.name)}</td><td>Installs</td></tr>`;
      }
      // Find spec
      const spec = specs.find(s => s.category === 'mep' || s.title?.includes(eq.type || ''));
      if (spec) {
        html += `<tr><td>Spec Section</td><td>${esc(spec.number)}</td><td>Specifies</td></tr>`;
      }
    }
  } else if (type === 'spec') {
    const spec = specs.find(s => s.number === entity);
    if (spec) {
      // Find subs for this trade
      const relevantSubs = subs.filter(s => s.trade === spec.category);
      relevantSubs.forEach(sub => {
        html += `<tr><td>Subcontractor</td><td>${esc(sub.name)}</td><td>Provides</td></tr>`;
      });
      // Find related submittals
      const relatedSubmittals = submittals.filter(s => s.spec_section === entity);
      relatedSubmittals.forEach(sub => {
        html += `<tr><td>Submittal</td><td>SUB-${esc(sub.id)}</td><td>Submits for</td></tr>`;
      });
    }
  } else if (type === 'sub') {
    const sub = subs.find(s => s.id === entity || s.name === entity);
    if (sub) {
      // Find specs for this trade
      const relatedSpecs = specs.filter(s => s.category === sub.trade);
      relatedSpecs.forEach(spec => {
        html += `<tr><td>Spec Section</td><td>${esc(spec.number)}</td><td>Relates to</td></tr>`;
      });
      // Find submittals for this sub
      const relatedSubmittals = submittals.filter(s => s.supplier === sub.name);
      relatedSubmittals.forEach(sub => {
        html += `<tr><td>Submittal</td><td>SUB-${esc(sub.id)}</td><td>Submitted by</td></tr>`;
      });
    }
  }

  html += '</tbody></table>';

  if (html.match(/<tr><td>/g).length === 0) {
    html = emptyState('üîó', 'No Relationships Found', 'This entity has no related items.');
  }

  resultsDiv.innerHTML = html;
}

/**
 * toggleGraphMode()
 * Switch between table and D3 force graph view.
 */
function toggleGraphMode() {
  const toggle = $('graph-mode-toggle');
  const table = $('correlation-results');
  const graph = $('correlation-graph');

  if (!toggle || !table || !graph) return;

  if (toggle.checked) {
    table.style.display = 'none';
    graph.style.display = 'block';
    // Simple D3 force graph simulation would go here
    // For now, show placeholder
    graph.innerHTML = '<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#999;">D3 force graph (D3 library required)</div>';
  } else {
    table.style.display = 'block';
    graph.style.display = 'none';
  }
}

// ===========================
// 18. PROGRESS TRACKING RENDERER
// ===========================

/**
 * renderProgress()
 * Quantity progress bars, S-curve, and earned value.
 */
function renderProgress() {
  const container = $('section-progress');
  if (!container) return;

  const dailyReports = safeGet(PROJECT_DATA, 'dailyReports', []) || [];
  const schedule = safeGet(PROJECT_DATA, 'schedule', {}) || {};
  const doors = safeGet(PROJECT_DATA, 'spatial.door_schedule', []) || [];

  let html = '<div class="section-header"><h2>Project Progress Tracking</h2></div>';

  // Quantity progress bars
  html += '<h3>Quantity Progress</h3>';

  // Doors installed
  const doorsInstalled = dailyReports.reduce((sum, r) => sum + (parseInt(safeGet(r, 'quantities.doors_installed', 0)) || 0), 0);
  const doorsTotal = doors.length;
  const doorsPct = pct(doorsInstalled, doorsTotal);

  html += '<div style="margin-bottom:2em;">';
  html += '<div style="display:flex; justify-content:space-between; margin-bottom:0.5em;">';
  html += `<strong>Doors Installed</strong><span>${doorsInstalled} / ${doorsTotal} (${doorsPct})</span>`;
  html += '</div>';
  html += `<div style="width:100%; height:20px; background:#e0e0e0; border-radius:4px; overflow:hidden;">`;
  html += `<div style="width:${doorsPct.replace('%', '')}%; height:100%; background:#4CAF50;"></div>`;
  html += '</div>';
  html += '</div>';

  // Concrete placed
  const concretePlaced = dailyReports.reduce((sum, r) => sum + (parseFloat(safeGet(r, 'quantities.concrete_cy', 0)) || 0), 0);
  const concreteTotal = 850; // Estimated from project specs
  const concretePct = pct(concretePlaced, concreteTotal);

  html += '<div style="margin-bottom:2em;">';
  html += '<div style="display:flex; justify-content:space-between; margin-bottom:0.5em;">';
  html += `<strong>Concrete Placed (CY)</strong><span>${concretePlaced.toFixed(1)} / ${concreteTotal} (${concretePct})</span>`;
  html += '</div>';
  html += `<div style="width:100%; height:20px; background:#e0e0e0; border-radius:4px; overflow:hidden;">`;
  html += `<div style="width:${concretePct.replace('%', '')}%; height:100%; background:#2196F3;"></div>`;
  html += '</div>';
  html += '</div>';

  // Rooms framed
  const roomsFramed = dailyReports.reduce((sum, r) => sum + (parseInt(safeGet(r, 'quantities.rooms_framed', 0)) || 0), 0);
  const roomsTotal = 40; // Estimated
  const roomsPct = pct(roomsFramed, roomsTotal);

  html += '<div style="margin-bottom:2em;">';
  html += '<div style="display:flex; justify-content:space-between; margin-bottom:0.5em;">';
  html += `<strong>Rooms Framed</strong><span>${roomsFramed} / ${roomsTotal} (${roomsPct})</span>`;
  html += '</div>';
  html += `<div style="width:100%; height:20px; background:#e0e0e0; border-radius:4px; overflow:hidden;">`;
  html += `<div style="width:${roomsPct.replace('%', '')}%; height:100%; background:#FF9800;"></div>`;
  html += '</div>';
  html += '</div>';

  if (dailyReports.length === 0) {
    html += '<p style="color:#999; font-style:italic;">Progress data will populate as daily reports are logged.</p>';
  }

  // S-curve chart
  html += '<div class="chart-container" style="margin-top:2em;">';
  html += '<h3>Cumulative Progress (S-Curve)</h3>';
  html += '<canvas id="scurve-chart"></canvas>';
  html += '</div>';

  // Earned value cards (if data exists)
  const hasEarnedValue = dailyReports.length > 0 && safeGet(PROJECT_DATA, 'config.original_contract_value') > 0;

  if (hasEarnedValue) {
    html += '<div style="margin-top:2em;">';
    html += '<h3>Earned Value Analysis</h3>';
    html += '<div class="cards-grid">';
    html += cardHTML('BCWS', 'TBD', 'Budgeted Cost of Work Scheduled');
    html += cardHTML('BCWP', 'TBD', 'Budgeted Cost of Work Performed');
    html += cardHTML('ACWP', 'TBD', 'Actual Cost of Work Performed');
    html += cardHTML('SPI', 'TBD', 'Schedule Performance Index');
    html += cardHTML('CPI', 'TBD', 'Cost Performance Index');
    html += '</div>';
    html += '</div>';
  }

  container.innerHTML = html;

  // Render S-curve
  setTimeout(() => {
    renderSCurve(dailyReports, schedule);
  }, 0);
}

/**
 * renderSCurve()
 * Cumulative progress line chart.
 */
function renderSCurve(dailyReports, schedule) {
  const ctx = document.getElementById('scurve-chart');
  if (!ctx) return;

  // Group by week
  const byWeek = {};
  dailyReports.forEach(report => {
    const date = new Date(report.date);
    const week = Math.floor(date.getTime() / (1000 * 60 * 60 * 24 * 7));
    if (!byWeek[week]) byWeek[week] = { concrete: 0, doors: 0, rooms: 0 };
    byWeek[week].concrete += parseFloat(safeGet(report, 'quantities.concrete_cy', 0)) || 0;
    byWeek[week].doors += parseInt(safeGet(report, 'quantities.doors_installed', 0)) || 0;
    byWeek[week].rooms += parseInt(safeGet(report, 'quantities.rooms_framed', 0)) || 0;
  });

  const weeks = Object.keys(byWeek).sort((a, b) => a - b);
  const cumulativePct = weeks.map((week, idx) => {
    const concreteToDate = weeks.slice(0, idx + 1).reduce((sum, w) => sum + byWeek[w].concrete, 0);
    return Math.min((concreteToDate / 850) * 100, 100);
  });

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: weeks.map((w, i) => `W${i + 1}`),
      datasets: [{
        label: 'Actual Progress',
        data: cumulativePct,
        borderColor: '#4CAF50',
        backgroundColor: 'rgba(76, 175, 80, 0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          min: 0,
          max: 100,
          title: { display: true, text: '% Complete' }
        }
      }
    }
  });
}

// ===========================
// 19. RENDERINGS RENDERER
// ===========================

/**
 * renderRenderings()
 * 3D rendering gallery and generation form.
 */
function renderRenderings() {
  const container = $('section-renderings');
  if (!container) return;

  const renderings = safeGet(PROJECT_DATA, 'renderings', []) || [];

  let html = '<div class="section-header"><h2>Renderings & 3D Visualizations</h2></div>';

  // Gallery grid
  html += '<h3>Rendering Gallery</h3>';
  html += '<div id="renderings-gallery" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1em; margin-bottom:2em;">';

  if (renderings.length === 0) {
    html += '<p style="grid-column:1/-1; color:#999;">No renderings yet. Generate one below.</p>';
  } else {
    renderings.forEach((rendering, idx) => {
      html += `<div style="border:1px solid #ddd; border-radius:4px; overflow:hidden; cursor:pointer;" onclick="viewRendering(${idx})">`;
      html += `<img src="${esc(rendering.image_url)}" style="width:100%; height:150px; object-fit:cover;" alt="Rendering">`;
      html += `<div style="padding:0.5em;">`;
      html += `<div style="font-weight:bold; font-size:0.85em;">${esc(rendering.type)}</div>`;
      html += `<div style="font-size:0.75em; color:#999;">${formatDate(rendering.created_at)}</div>`;
      html += `</div>`;
      html += `</div>`;
    });
  }

  html += '</div>';

  // SVG diagrams section
  html += '<h3>SVG Diagrams</h3>';
  html += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:2em; margin-bottom:2em;">';

  // Floor plan SVG
  html += '<div>';
  html += '<h4>Floor Plan</h4>';
  html += '<svg id="floorplan-svg" viewBox="0 0 300 400" style="border:1px solid #ddd; width:100%; background:#f5f5f5;"></svg>';
  html += '</div>';

  // Site plan SVG
  html += '<div>';
  html += '<h4>Site Plan</h4>';
  html += '<svg id="siteplan-svg" viewBox="0 0 400 300" style="border:1px solid #ddd; width:100%; background:#f5f5f5;"></svg>';
  html += '</div>';

  html += '</div>';

  // Generation form
  html += '<h3 style="margin-top:2em;">Generate New Rendering</h3>';
  html += '<div style="padding:1em; background:#f5f5f5; border-radius:4px;">';
  html += '<div style="margin-bottom:1em;">';
  html += '<label><strong>Type:</strong></label><br/>';
  html += '<select id="render-type" style="width:100%; padding:0.5em; margin-top:0.5em;">';
  html += '<option value="exterior">Exterior</option>';
  html += '<option value="interior">Interior</option>';
  html += '<option value="site">Site Plan</option>';
  html += '</select>';
  html += '</div>';

  html += '<div style="margin-bottom:1em;">';
  html += '<label><strong>Style:</strong></label><br/>';
  html += '<select id="render-style" style="width:100%; padding:0.5em; margin-top:0.5em;">';
  html += '<option value="photorealistic">Photorealistic</option>';
  html += '<option value="conceptual">Conceptual</option>';
  html += '<option value="schematic">Schematic</option>';
  html += '</select>';
  html += '</div>';

  html += '<div style="margin-bottom:1em;">';
  html += '<label><strong>Lighting:</strong></label><br/>';
  html += '<select id="render-lighting" style="width:100%; padding:0.5em; margin-top:0.5em;">';
  html += '<option value="daylight">Daylight</option>';
  html += '<option value="evening">Evening</option>';
  html += '<option value="night">Night</option>';
  html += '</select>';
  html += '</div>';

  html += '<div style="margin-bottom:1em;">';
  html += '<label><strong>API:</strong></label><br/>';
  html += '<select id="render-api" style="width:100%; padding:0.5em; margin-top:0.5em;">';
  if (API_KEYS.gemini) html += '<option value="gemini">Gemini Vision</option>';
  if (API_KEYS.flux2) html += '<option value="flux2">Flux 2.0</option>';
  html += '<option value="" disabled>No APIs configured</option>';
  html += '</select>';
  html += '</div>';

  html += '<button id="render-btn" class="btn" style="width:100%; padding:0.7em;" onclick="generateRendering()">Generate Rendering</button>';
  html += '</div>';

  container.innerHTML = html;

  // Draw sample SVG diagrams
  drawFloorplanSVG();
  drawSiteplanSVG();
}

/**
 * drawFloorplanSVG()
 * Draw sample floor plan SVG.
 */
function drawFloorplanSVG() {
  const svg = $('floorplan-svg');
  if (!svg) return;

  const roomSchedule = safeGet(PROJECT_DATA, 'spatial.room_schedule', {}) || {};
  const rooms = [];
  ['resident_rooms', 'common_areas', 'support_spaces'].forEach(cat => {
    const list = safeGet(roomSchedule, cat, []);
    if (Array.isArray(list)) rooms.push(...list.slice(0, 8));
  });

  // Simple grid layout
  let x = 10, y = 10;
  rooms.forEach((room, idx) => {
    const width = 70;
    const height = 60;

    if (x + width > 290) {
      x = 10;
      y += height + 10;
    }

    svg.innerHTML += `<rect x="${x}" y="${y}" width="${width}" height="${height}" fill="#e3f2fd" stroke="#2196F3" stroke-width="2"/>`;
    svg.innerHTML += `<text x="${x + width/2}" y="${y + 20}" text-anchor="middle" font-size="10" font-weight="bold">${esc((room.mark || room.name || '').substring(0, 6))}</text>`;

    x += width + 5;
  });
}

/**
 * drawSiteplanSVG()
 * Draw sample site plan SVG.
 */
function drawSiteplanSVG() {
  const svg = $('siteplan-svg');
  if (!svg) return;

  // Building footprint
  svg.innerHTML = `<rect x="80" y="50" width="200" height="200" fill="#ddd" stroke="#333" stroke-width="2"/>`;
  svg.innerHTML += `<text x="180" y="150" text-anchor="middle" font-size="14" font-weight="bold">MOSC Building</text>`;

  // Parking areas
  svg.innerHTML += `<rect x="20" y="70" width="50" height="80" fill="#ffd54f" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>`;
  svg.innerHTML += `<text x="45" y="115" text-anchor="middle" font-size="9">Parking</text>`;

  svg.innerHTML += `<rect x="330" y="100" width="50" height="120" fill="#ffd54f" stroke="#999" stroke-width="1" stroke-dasharray="3,3"/>`;
  svg.innerHTML += `<text x="355" y="165" text-anchor="middle" font-size="9">Parking</text>`;

  // Site boundary
  svg.innerHTML += `<rect x="10" y="10" width="380" height="280" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>`;
}

/**
 * viewRendering()
 * Open rendering in modal overlay.
 */
function viewRendering(idx) {
  const renderings = safeGet(PROJECT_DATA, 'renderings', []) || [];
  if (idx < 0 || idx >= renderings.length) return;

  const rendering = renderings[idx];
  let html = `<div style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; display:flex; align-items:center; justify-content:center;" onclick="this.remove();">`;
  html += `<div style="position:relative; max-width:90%; max-height:90%; background:#fff; border-radius:4px; overflow:hidden;" onclick="event.stopPropagation();">`;
  html += `<img src="${esc(rendering.image_url)}" style="width:100%; height:auto;" alt="Rendering">`;
  html += `<button style="position:absolute; top:10px; right:10px; background:#f44336; color:#fff; border:none; padding:0.5em 1em; border-radius:4px; cursor:pointer;" onclick="this.parentElement.parentElement.remove();">Close</button>`;
  html += `</div>`;
  html += `</div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}

/**
 * generateRendering()
 * Call AI API to generate rendering.
 */
function generateRendering() {
  const typeEl = $('render-type');
  const styleEl = $('render-style');
  const lightingEl = $('render-lighting');
  const apiEl = $('render-api');

  if (!typeEl || !styleEl || !lightingEl || !apiEl) return;

  const type = typeEl.value;
  const style = styleEl.value;
  const lighting = lightingEl.value;
  const api = apiEl.value;

  if (!api) {
    alert('No API configured');
    return;
  }

  // Build prompt from project data
  const projectName = safeGet(PROJECT_DATA, 'config.project_name', 'Morehead One Senior Care');
  const description = safeGet(PROJECT_DATA, 'config.description', 'Healthcare facility');
  const buildingSize = safeGet(PROJECT_DATA, 'spatial.pemb_envelope.length', 75);
  const width = safeGet(PROJECT_DATA, 'spatial.pemb_envelope.width', 133);

  const prompt = `Generate a ${style} architectural ${type} rendering of a ${description} facility.
Building: ${buildingSize}' x ${width}' healthcare campus in Morehead, KY.
${style === 'photorealistic' ? 'High-quality, detailed, realistic materials and finishes.' : ''}
${style === 'conceptual' ? 'Modern conceptual design with emphasis on spatial relationships.' : ''}
${style === 'schematic' ? 'Clean schematic diagram showing layout and organization.' : ''}
Lighting: ${lighting}.
${type === 'site' ? 'Show site plan with parking, roads, and landscaping.' : ''}
${type === 'interior' ? 'Show interior common areas and residential spaces.' : ''}`;

  const btn = $('render-btn');
  if (btn) {
    btn.disabled = true;
    btn.textContent = 'Generating...';
  }

  // Call API
  if (api === 'gemini') {
    callGeminiRendering(prompt, btn);
  } else if (api === 'flux2') {
    callFluxRendering(prompt, btn);
  }
}

/**
 * callGeminiRendering()
 * Call Gemini 2.0 Vision API.
 */
function callGeminiRendering(prompt, btn) {
  const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent';
  const payload = {
    contents: [{
      parts: [{
        text: prompt
      }]
    }]
  };

  fetch(url + '?key=' + API_KEYS.gemini, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Generate Rendering';
    }
    console.log('Gemini response:', data);
    alert('Gemini API call complete (check console for response)');
  })
  .catch(err => {
    console.error('Gemini error:', err);
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Generate Rendering';
    }
    alert('Error calling Gemini API');
  });
}

/**
 * callFluxRendering()
 * Call Flux 2.0 image generation API.
 */
function callFluxRendering(prompt, btn) {
  const url = 'https://api.bfl.ml/v1/flux-pro-1.1';
  const payload = {
    prompt: prompt,
    num_inference_steps: 25,
    guidance_scale: 7.5
  };

  fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-key': API_KEYS.flux2
    },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'Generate Rendering';
    }
    console.log('Flux response:', data);
    alert('Flux API call complete (check console for response)');
  })

/**
 * part3e-js-chatbot.js
 * ProjectChatbot Class ‚Äî AI-powered construction project assistant
 * Uses Anthropic Claude API with offline keyword fallback
 * Depends on: Part 3A helpers (esc, safeGet, formatNumber, formatCurrency, $)
 */

class ProjectChatbot {
  constructor(apiKey, projectData) {
    this.apiKey = apiKey;
    this.data = projectData || {};
    this.history = [];
    this.isOnline = !!apiKey;
    this.isLoading = false;
    this.systemPrompt = '';
    this.suggestedQuestions = [];
    this.messageCount = 0;
  }

  /**
   * Initialize chatbot: set up DOM, event listeners, and UI
   */
  init() {
    // Find chat panel elements
    this.chatPanel = document.getElementById('chat-panel');
    this.chatMessages = document.getElementById('chat-messages');
    this.chatInput = document.getElementById('chat-input');
    this.chatSend = document.getElementById('chat-send');
    this.modeIndicator = document.getElementById('chat-mode-indicator');

    if (!this.chatPanel || !this.chatMessages || !this.chatInput || !this.chatSend) {
      console.warn('ProjectChatbot: required DOM elements not found');
      return;
    }

    // Build system prompt once at init
    this.systemPrompt = this.buildSystemPrompt();

    // Set up event listeners
    this.chatSend.addEventListener('click', () => this.handleSendClick());
    this.chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.handleSendClick();
      }
    });

    // Set up collapse/expand toggle
    const toggleBtn = this.chatPanel.querySelector('.chat-toggle-btn');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => this.togglePanel());
    }

    // Display mode indicator
    this.updateModeIndicator();

    // Show initial suggestions
    this.showSuggestions();
  }

  /**
   * Handle send button click
   */
  handleSendClick() {
    const question = this.chatInput.value.trim();
    if (!question) return;

    this.chatInput.value = '';
    this.processMessage(question);
  }

  /**
   * Process a user question: add to chat, send to API or offline search
   */
  processMessage(question) {
    // Add user message to chat
    this.addMessage('user', question);

    // Clear suggestions on first real message
    if (this.messageCount === 0) {
      const suggestionsDiv = this.chatMessages.querySelector('.chat-suggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
      }
    }
    this.messageCount++;

    // Process message based on online/offline mode
    if (this.isOnline) {
      this.sendToAPI(question);
    } else {
      const response = this.offlineSearch(question);
      this.addMessage('assistant', response);
      this.scrollToBottom();
    }
  }

  /**
   * Send message to Anthropic API
   */
  async sendToAPI(question) {
    this.isLoading = true;
    this.showLoading();

    try {
      // Trim history to last 20 messages (10 exchanges) to prevent context overflow
      const MAX_HISTORY = 20;
      if (this.history.length > MAX_HISTORY) {
        this.history = this.history.slice(-MAX_HISTORY);
      }

      // Build messages array
      const messages = this.history.concat([{ role: 'user', content: question }]);

      // Call Anthropic API
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': this.apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-5-20250514',
          max_tokens: 2048,
          system: this.systemPrompt,
          messages: messages
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
      }

      const data = await response.json();

      // Extract text from response, filtering out any non-text content blocks
      const textBlocks = (data.content || []).filter(b => b.type === 'text');
      const assistantMessage = textBlocks.map(b => b.text).join('\n') || 'No response received';

      // Add to history (text-only to avoid tool_use ID conflicts)
      this.history.push({ role: 'user', content: question });
      this.history.push({ role: 'assistant', content: assistantMessage });

      // Display response
      this.hideLoading();
      this.addMessage('assistant', assistantMessage);
      this.scrollToBottom();

    } catch (error) {
      console.error('ProjectChatbot API error:', error);
      this.hideLoading();
      const errorMsg = `I encountered an error: ${error.message}. Please try again or switch to offline mode.`;
      this.addMessage('assistant', errorMsg);
      this.scrollToBottom();
    }

    this.isLoading = false;
  }

  /**
   * Offline keyword search fallback
   */
  offlineSearch(question) {
    const q = question.toLowerCase();
    let results = [];

    // Room queries
    if (this.matchKeyword(q, ['room', 'bedroom', 'bathroom', 'common', 'support', 'how many'])) {
      const rooms = safeGet(this.data, 'room_schedule', {});
      if (Object.keys(rooms).length > 0) {
        results.push('**Rooms:**');
        Object.entries(rooms).forEach(([type, count]) => {
          results.push(`- ${type}: ${count}`);
        });
      }
    }

    // Concrete specs
    if (this.matchKeyword(q, ['concrete', 'mix', 'psi', 'slump', 'air', 'water', 'finish'])) {
      const concrete = safeGet(this.data, 'concrete_intelligence', {});
      if (Object.keys(concrete).length > 0) {
        results.push('**Concrete Specifications:**');
        if (concrete.sog_interior_psi) {
          results.push(`- Interior SOG: ${concrete.sog_interior_psi} PSI`);
        }
        if (concrete.sog_exterior_psi) {
          results.push(`- Exterior SOG: ${concrete.sog_exterior_psi} PSI`);
        }
        if (concrete.bearing_psi) {
          results.push(`- Bearing: ${concrete.bearing_psi} PSF`);
        }
        if (concrete.anchor_bolt_type) {
          results.push(`- Anchor Bolts: ${concrete.anchor_bolt_type}`);
        }
      }
    }

    // Schedule queries
    if (this.matchKeyword(q, ['schedule', 'when', 'milestone', 'deadline', 'date', 'start', 'complete', 'phase'])) {
      const schedule = safeGet(this.data, 'schedule', {});
      if (Object.keys(schedule).length > 0) {
        results.push('**Key Milestones:**');
        Object.entries(schedule).slice(0, 10).forEach(([name, date]) => {
          if (date) {
            results.push(`- ${name}: ${date}`);
          }
        });
      }
    }

    // Submittal queries
    if (this.matchKeyword(q, ['submittal', 'overdue', 'review', 'approved', 'pending'])) {
      const submittals = safeGet(this.data, 'submittals', []);
      const overdue = submittals.filter(s => s.status === 'OVERDUE');
      if (submittals.length > 0) {
        results.push(`**Submittals:** ${submittals.length} total`);
        if (overdue.length > 0) {
          results.push(`- **Overdue: ${overdue.length}**`);
          overdue.slice(0, 5).forEach(s => {
            results.push(`  - ${s.item}: ${s.days_in_review} days`);
          });
        } else {
          results.push('- All current');
        }
      }
    }

    // Subcontractor/contractor queries
    if (this.matchKeyword(q, ['sub', 'contractor', 'who', 'trade', 'company'])) {
      const subs = safeGet(this.data, 'subcontractors', []);
      if (subs.length > 0) {
        results.push('**Subcontractors:**');
        subs.forEach(s => {
          results.push(`- ${s.name || 'TBD'} (${s.trade || 'TBD'})`);
        });
      }
    }

    // Door queries
    if (this.matchKeyword(q, ['door', 'hardware', 'opening', 'frame'])) {
      const doors = safeGet(this.data, 'door_schedule', {});
      if (Object.keys(doors).length > 0) {
        results.push('**Doors & Hardware:**');
        Object.entries(doors).forEach(([type, count]) => {
          results.push(`- ${type}: ${count} openings`);
        });
      }
      const doorPO = safeGet(this.data, 'door_po_value');
      if (doorPO) {
        results.push(`- PO Value: ${formatCurrency(doorPO)}`);
      }
    }

    // MEP equipment queries
    if (this.matchKeyword(q, ['mep', 'hvac', 'electrical', 'plumbing', 'mechanical', 'equipment', 'panel', 'ductwork'])) {
      const mep = safeGet(this.data, 'mep_equipment', {});
      if (Object.keys(mep).length > 0) {
        results.push('**MEP Equipment:**');
        Object.entries(mep).forEach(([category, items]) => {
          results.push(`- **${category}:** ${Array.isArray(items) ? items.join(', ') : items}`);
        });
      }
    }

    // Procurement/Material queries
    if (this.matchKeyword(q, ['material', 'procurement', 'order', 'supplier', 'delivery', 'now', 'urgent'])) {
      const alerts = safeGet(this.data, 'procurement_alerts', []);
      const specs = safeGet(this.data, 'specifications', {});
      if (alerts.length > 0) {
        results.push('**Procurement Alerts ‚Äî NOW:**');
        alerts.forEach(a => {
          results.push(`- ${a.item}: ${a.status || 'Verify PO'}`);
        });
      }
    }

    // Specification queries
    if (this.matchKeyword(q, ['spec', 'specification', 'standard', 'astm', 'code', 'requirement'])) {
      const specs = safeGet(this.data, 'specifications', {});
      if (Object.keys(specs).length > 0) {
        results.push('**Key Specifications:**');
        Object.entries(specs).slice(0, 8).forEach(([section, detail]) => {
          results.push(`- ${section}: ${detail}`);
        });
      }
    }

    // Financial queries
    if (this.matchKeyword(q, ['cost', 'budget', 'financial', 'committed', 'pending', 'contract', 'value'])) {
      const financial = safeGet(this.data, 'financial_summary', {});
      if (Object.keys(financial).length > 0) {
        results.push('**Financial Summary:**');
        Object.entries(financial).forEach(([item, value]) => {
          if (typeof value === 'number') {
            results.push(`- ${item}: ${formatCurrency(value)}`);
          } else {
            results.push(`- ${item}: ${value}`);
          }
        });
      }
    }

    // RFI queries
    if (this.matchKeyword(q, ['rfi', 'request', 'information', 'clarification', 'question'])) {
      const rfis = safeGet(this.data, 'rfis', []);
      if (rfis.length > 0) {
        results.push(`**RFIs:** ${rfis.length} on file`);
        rfis.slice(0, 3).forEach(r => {
          results.push(`- ${r.title || 'RFI'}: ${r.status || 'Pending'}`);
        });
      } else {
        results.push('**RFIs:** No RFIs logged yet');
      }
    }

    // Safety queries
    if (this.matchKeyword(q, ['safety', 'ppe', 'hazard', 'osha', 'fall', 'protection'])) {
      results.push('Safety data is managed separately via the /safety command. Contact your safety manager for specific requirements.');
    }

    // Summary fallback
    if (results.length === 0 && this.matchKeyword(q, ['summary', 'overview', 'tell', 'what'])) {
      const projectName = safeGet(this.data, 'project_name', 'This Project');
      results.push(`**${projectName}**`);
      results.push(`Type: ${safeGet(this.data, 'project_type', 'N/A')}`);
      results.push(`Building: ${safeGet(this.data, 'building_sf', 'N/A')} SF`);
      results.push(`Phase: ${safeGet(this.data, 'current_phase', 'N/A')}`);
      const subs = safeGet(this.data, 'subcontractors', []);
      results.push(`Subcontractors: ${subs.length} on file`);
    }

    // No match fallback
    if (results.length === 0) {
      results.push('I couldn\'t find data matching your question. Try asking about:');
      results.push('- Rooms and spaces');
      results.push('- Schedule and milestones');
      results.push('- Submittals');
      results.push('- Concrete specifications');
      results.push('- Doors and hardware');
      results.push('- MEP equipment');
      results.push('- Materials and procurement');
      results.push('- Budget and costs');
      results.push('- Subcontractors');
    }

    return results.join('\n');
  }

  /**
   * Check if question matches keyword patterns
   */
  matchKeyword(question, keywords) {
    return keywords.some(kw => question.includes(kw.toLowerCase()));
  }

  /**
   * Build comprehensive system prompt from project data
   */
  buildSystemPrompt() {
    const projectName = safeGet(this.data, 'project_name', 'Construction Project');
    const projectCode = safeGet(this.data, 'project_code', '');
    const address = safeGet(this.data, 'address', 'TBD');
    const type = safeGet(this.data, 'project_type', 'N/A');
    const company = safeGet(this.data, 'company', 'N/A');
    const phase = safeGet(this.data, 'current_phase', 'N/A');
    const buildingSF = safeGet(this.data, 'building_sf', 'N/A');
    const stories = safeGet(this.data, 'stories', '1');

    let prompt = `You are a construction project data assistant for ${projectName}.`;
    if (projectCode) prompt += ` (${projectCode})`;
    prompt += ` You have access to detailed project data. Answer questions concisely and cite specific data points. If data is not available, say so clearly. Format responses for readability ‚Äî use bold for key values and short paragraphs.\n\n`;

    // Project basics
    prompt += `**PROJECT BASICS**\n`;
    prompt += `Name: ${projectName}\n`;
    prompt += `Address: ${address}\n`;
    prompt += `Type: ${type}\n`;
    prompt += `Company: ${company}\n`;
    prompt += `Current Phase: ${phase}\n`;
    prompt += `Building: ${buildingSF} SF, ${stories} story\n\n`;

    // Room summary
    const rooms = safeGet(this.data, 'room_schedule', {});
    if (Object.keys(rooms).length > 0) {
      prompt += `**ROOMS & SPACES**\n`;
      Object.entries(rooms).forEach(([type, count]) => {
        prompt += `- ${type}: ${count}\n`;
      });
      prompt += '\n';
    }

    // Door summary
    const doors = safeGet(this.data, 'door_schedule', {});
    const doorPO = safeGet(this.data, 'door_po_value', 0);
    if (Object.keys(doors).length > 0) {
      prompt += `**DOORS & HARDWARE**\n`;
      prompt += `Total Openings: ${Object.values(doors).reduce((a, b) => a + b, 0)}\n`;
      Object.entries(doors).forEach(([type, count]) => {
        prompt += `- ${type}: ${count}\n`;
      });
      if (doorPO > 0) {
        prompt += `PO Value: ${formatCurrency(doorPO)}\n`;
      }
      prompt += '\n';
    }

    // Schedule highlights (key milestones only)
    const schedule = safeGet(this.data, 'schedule', {});
    if (Object.keys(schedule).length > 0) {
      prompt += `**SCHEDULE MILESTONES**\n`;
      const keyMilestones = ['ntp', 'mobilization', 'foundation_complete', 'pemb_erection', 'dried_in', 'substantial_completion', 'final_completion'];
      Object.entries(schedule).forEach(([name, date]) => {
        if (date && keyMilestones.some(km => name.toLowerCase().includes(km))) {
          prompt += `- ${this.prettifyKey(name)}: ${date}\n`;
        }
      });
      prompt += '\n';
    }

    // Subcontractors (just names and trades)
    const subs = safeGet(this.data, 'subcontractors', []);
    if (subs.length > 0) {
      prompt += `**SUBCONTRACTORS (${subs.length})**\n`;
      subs.forEach(s => {
        prompt += `- ${s.name || 'TBD'}: ${s.trade || 'N/A'}\n`;
      });
      prompt += '\n';
    }

    // Submittal status summary
    const submittals = safeGet(this.data, 'submittals', []);
    if (submittals.length > 0) {
      const overdue = submittals.filter(s => s.status === 'OVERDUE').length;
      prompt += `**SUBMITTALS**\n`;
      prompt += `Total: ${submittals.length} | Overdue: ${overdue}\n`;
      if (overdue > 0) {
        prompt += `Overdue Items:\n`;
        submittals.filter(s => s.status === 'OVERDUE').slice(0, 5).forEach(s => {
          prompt += `- ${s.item}: ${s.days_in_review} days\n`;
        });
      }
      prompt += '\n';
    }

    // Procurement alerts
    const alerts = safeGet(this.data, 'procurement_alerts', []);
    if (alerts.length > 0) {
      prompt += `**PROCUREMENT ALERTS ‚Äî PRIORITY**\n`;
      alerts.forEach(a => {
        prompt += `- ${a.item}: ${a.status || 'Action Required'}\n`;
      });
      prompt += '\n';
    }

    // Concrete specs
    const concrete = safeGet(this.data, 'concrete_intelligence', {});
    if (Object.keys(concrete).length > 0) {
      prompt += `**CONCRETE SPECIFICATIONS**\n`;
      if (concrete.sog_interior_psi) prompt += `- Interior SOG: ${concrete.sog_interior_psi} PSI\n`;
      if (concrete.sog_exterior_psi) prompt += `- Exterior SOG: ${concrete.sog_exterior_psi} PSI\n`;
      if (concrete.bearing_psi) prompt += `- Bearing: ${concrete.bearing_psi} PSF\n`;
      if (concrete.rebar) prompt += `- Rebar: ${concrete.rebar}\n`;
      if (concrete.anchor_bolt_type) prompt += `- Anchor Bolts: ${concrete.anchor_bolt_type}\n`;
      prompt += '\n';
    }

    // MEP summary
    const mep = safeGet(this.data, 'mep_equipment', {});
    if (Object.keys(mep).length > 0) {
      prompt += `**MEP EQUIPMENT**\n`;
      Object.entries(mep).forEach(([category, items]) => {
        const itemStr = Array.isArray(items) ? items.join(', ') : items;
        prompt += `- ${category}: ${itemStr}\n`;
      });
      prompt += '\n';
    }

    // Financial summary
    const financial = safeGet(this.data, 'financial_summary', {});
    if (Object.keys(financial).length > 0) {
      prompt += `**FINANCIAL SUMMARY**\n`;
      Object.entries(financial).forEach(([item, value]) => {
        if (typeof value === 'number') {
          prompt += `- ${item}: ${formatCurrency(value)}\n`;
        } else {
          prompt += `- ${item}: ${value}\n`;
        }
      });
      prompt += '\n';
    }

    // Geotechnical summary
    const geotech = safeGet(this.data, 'geotechnical_summary', {});
    if (Object.keys(geotech).length > 0) {
      prompt += `**GEOTECHNICAL**\n`;
      if (geotech.bearing) prompt += `- Bearing: ${geotech.bearing}\n`;
      if (geotech.compaction) prompt += `- Compaction: ${geotech.compaction}\n`;
      prompt += '\n';
    }

    // Trim to reasonable size (roughly 3000 tokens ‚âà 12,000 chars)
    if (prompt.length > 12000) {
      prompt = prompt.substring(0, 11800) + '\n... (data truncated)';
    }

    return prompt;
  }

  /**
   * Convert database keys to readable titles
   */
  prettifyKey(key) {
    return key
      .split('_')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  /**
   * Add a message to the chat (user or assistant)
   */
  addMessage(role, content) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `chat-message chat-message-${role}`;

    // Format content: markdown-lite rendering
    let html = this.formatMessageContent(content);

    msgDiv.innerHTML = html;
    this.chatMessages.appendChild(msgDiv);
    this.scrollToBottom();
  }

  /**
   * Format message content with markdown-lite: bold, code, lists, line breaks
   */
  formatMessageContent(content) {
    let html = esc(content);

    // Bold: **text** ‚Üí <strong>text</strong>
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // Code: `text` ‚Üí <code>text</code>
    html = html.replace(/`(.*?)`/g, '<code>$1</code>');

    // List items: lines starting with - or * ‚Üí <li>
    const lines = html.split('\n');
    let inList = false;
    const formattedLines = [];

    lines.forEach(line => {
      const trimmed = line.trim();
      if (trimmed.startsWith('-') || trimmed.startsWith('*')) {
        if (!inList) {
          formattedLines.push('<ul>');
          inList = true;
        }
        const item = trimmed.substring(1).trim();
        formattedLines.push(`<li>${item}</li>`);
      } else {
        if (inList) {
          formattedLines.push('</ul>');
          inList = false;
        }
        if (trimmed) {
          formattedLines.push(trimmed);
        }
      }
    });

    if (inList) {
      formattedLines.push('</ul>');
    }

    // Rejoin and convert newlines to <br>
    html = formattedLines.join('<br>');

    return html;
  }

  /**
   * Show loading indicator (typing dots)
   */
  showLoading() {
    if (this.loadingDiv) return; // Already showing

    this.loadingDiv = document.createElement('div');
    this.loadingDiv.className = 'chat-message chat-message-assistant chat-loading';
    this.loadingDiv.innerHTML = `
      <div class="typing-indicator">
        <span></span><span></span><span></span>
      </div>
    `;
    this.chatMessages.appendChild(this.loadingDiv);
    this.scrollToBottom();
  }

  /**
   * Hide loading indicator
   */
  hideLoading() {
    if (this.loadingDiv) {
      this.loadingDiv.remove();
      this.loadingDiv = null;
    }
  }

  /**
   * Show suggested questions based on available data
   */
  showSuggestions() {
    const suggestions = [];

    // Build suggestions based on data availability
    const rooms = safeGet(this.data, 'room_schedule', {});
    if (Object.keys(rooms).length > 0) {
      suggestions.push('How many bedrooms are there?');
    }

    const schedule = safeGet(this.data, 'schedule', {});
    if (Object.keys(schedule).length > 0) {
      suggestions.push('When is the next major milestone?');
    }

    const submittals = safeGet(this.data, 'submittals', []);
    const overdue = submittals.filter(s => s.status === 'OVERDUE');
    if (overdue.length > 0) {
      suggestions.push(`What submittals are overdue? (${overdue.length})`);
    }

    const alerts = safeGet(this.data, 'procurement_alerts', []);
    if (alerts.length > 0) {
      suggestions.push('What materials are needed now?');
    }

    // Always add summary
    if (suggestions.length < 4) {
      suggestions.push('Give me a project summary');
    }

    // Limit to 4 suggestions
    this.suggestedQuestions = suggestions.slice(0, 4);

    // Create and display suggestions UI
    const suggestionsDiv = document.createElement('div');
    suggestionsDiv.className = 'chat-suggestions';
    suggestionsDiv.innerHTML = '<div class="chat-suggestions-label">Suggested questions:</div>';

    this.suggestedQuestions.forEach(question => {
      const btn = document.createElement('button');
      btn.className = 'chat-suggestion-btn';
      btn.textContent = question;
      btn.addEventListener('click', () => {
        this.chatInput.value = question;
        this.handleSendClick();
      });
      suggestionsDiv.appendChild(btn);
    });

    this.chatMessages.appendChild(suggestionsDiv);
  }

  /**
   * Scroll chat to bottom
   */
  scrollToBottom() {
    setTimeout(() => {
      this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }, 0);
  }

  /**
   * Toggle chat panel collapse/expand
   */
  togglePanel() {
    this.chatPanel.classList.toggle('chat-collapsed');
    const isCollapsed = this.chatPanel.classList.contains('chat-collapsed');
    if (!isCollapsed) {
      this.scrollToBottom();
    }
  }

  /**
   * Update mode indicator: shows "AI Mode" or "Offline Mode"
   */
  updateModeIndicator() {
    if (!this.modeIndicator) return;

    if (this.isOnline) {
      this.modeIndicator.innerHTML = '<span class="chat-mode-dot online"></span> AI Mode';
      this.modeIndicator.title = 'Connected to Anthropic API';
    } else {
      this.modeIndicator.innerHTML = '<span class="chat-mode-dot offline"></span> Offline Mode';
      this.modeIndicator.title = 'Using offline keyword search';
    }
  }
}

/**
 * Initialize chatbot after DOM and dashboard are ready
 */
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    const apiKey = (typeof API_KEYS !== 'undefined' && API_KEYS.anthropic) ? API_KEYS.anthropic : '';
    if (typeof PROJECT_DATA !== 'undefined') {
      window.chatbot = new ProjectChatbot(apiKey, PROJECT_DATA);
      window.chatbot.init();
    } else {
      console.warn('ProjectChatbot: PROJECT_DATA not defined');
    }
  }, 500); // slight delay to let dashboard init first
});

// ===========================
// END OF PART 3D
// ===========================
// External data.js loader (to be included in HTML template)
// Check if data.js was loaded externally
if (typeof window.PROJECT_DATA !== 'undefined') {
  window.dispatchEvent(new Event('projectDataLoaded'));
}
</script>

<!-- Load project data -->
<script src="data.js"></script>

</body>
</html>
